INFO:     Started server process [19516]
INFO:     Waiting for application startup.
INFO:app.db.init_db:数据库连接成功: [(1,)]
INFO:app.db.init_db:数据库表创建成功
INFO:     Application startup complete.
INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
INFO:     127.0.0.1:6769 - "POST /api/v1/auth/token HTTP/1.1" 200 OK
INFO:     127.0.0.1:6772 - "GET /api/v1/documents/41 HTTP/1.1" 200 OK
ERROR:app.db.session:Database connection error: 400: 用户名已被注册
Traceback (most recent call last):
  File "D:\Projects\edit\app\db\session.py", line 79, in get_db
    yield conn
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\concurrency.py", line 27, in contextmanager_in_threadpool
    yield await run_in_threadpool(cm.__enter__)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 111, in app
    response = await f(request)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 391, in app
    raw_response = await run_endpoint_function(
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 292, in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\concurrency.py", line 38, in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
  File "D:\Projects\edit\venv\lib\site-packages\anyio\to_thread.py", line 56, in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
  File "D:\Projects\edit\venv\lib\site-packages\anyio\_backends\_asyncio.py", line 2485, in run_sync_in_worker_thread
    return await future
  File "D:\Projects\edit\venv\lib\site-packages\anyio\_backends\_asyncio.py", line 976, in run
    result = context.run(func, *args)
  File "D:\Projects\edit\app\api\routers\auth.py", line 21, in register
    raise HTTPException(
fastapi.exceptions.HTTPException: 400: 用户名已被注册
INFO:     127.0.0.1:6784 - "POST /api/v1/auth/register HTTP/1.1" 400 Bad Request
INFO:     127.0.0.1:6786 - "POST /api/v1/auth/token HTTP/1.1" 200 OK
INFO:     127.0.0.1:6789 - "GET /api/v1/auth/me HTTP/1.1" 200 OK
ERROR:app.db.session:Database connection error: 400: 用户名已被注册
Traceback (most recent call last):
  File "D:\Projects\edit\app\db\session.py", line 79, in get_db
    yield conn
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\concurrency.py", line 27, in contextmanager_in_threadpool
    yield await run_in_threadpool(cm.__enter__)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 111, in app
    response = await f(request)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 391, in app
    raw_response = await run_endpoint_function(
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 292, in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\concurrency.py", line 38, in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
  File "D:\Projects\edit\venv\lib\site-packages\anyio\to_thread.py", line 56, in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
  File "D:\Projects\edit\venv\lib\site-packages\anyio\_backends\_asyncio.py", line 2485, in run_sync_in_worker_thread
    return await future
  File "D:\Projects\edit\venv\lib\site-packages\anyio\_backends\_asyncio.py", line 976, in run
    result = context.run(func, *args)
  File "D:\Projects\edit\app\api\routers\auth.py", line 21, in register
    raise HTTPException(
fastapi.exceptions.HTTPException: 400: 用户名已被注册
INFO:     127.0.0.1:6790 - "POST /api/v1/auth/register HTTP/1.1" 400 Bad Request
INFO:     127.0.0.1:6791 - "POST /api/v1/auth/token HTTP/1.1" 200 OK
INFO:     127.0.0.1:6792 - "GET /api/v1/auth/me HTTP/1.1" 200 OK
ERROR:app.db.session:Database connection error: 400: 用户名已被注册
Traceback (most recent call last):
  File "D:\Projects\edit\app\db\session.py", line 79, in get_db
    yield conn
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\concurrency.py", line 27, in contextmanager_in_threadpool
    yield await run_in_threadpool(cm.__enter__)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 111, in app
    response = await f(request)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 391, in app
    raw_response = await run_endpoint_function(
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 292, in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\concurrency.py", line 38, in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
  File "D:\Projects\edit\venv\lib\site-packages\anyio\to_thread.py", line 56, in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
  File "D:\Projects\edit\venv\lib\site-packages\anyio\_backends\_asyncio.py", line 2485, in run_sync_in_worker_thread
    return await future
  File "D:\Projects\edit\venv\lib\site-packages\anyio\_backends\_asyncio.py", line 976, in run
    result = context.run(func, *args)
  File "D:\Projects\edit\app\api\routers\auth.py", line 21, in register
    raise HTTPException(
fastapi.exceptions.HTTPException: 400: 用户名已被注册
INFO:     127.0.0.1:6794 - "POST /api/v1/auth/register HTTP/1.1" 400 Bad Request
INFO:     127.0.0.1:6795 - "POST /api/v1/auth/token HTTP/1.1" 200 OK
INFO:     127.0.0.1:6798 - "GET /api/v1/auth/me HTTP/1.1" 200 OK
INFO:     127.0.0.1:6799 - "POST /api/v1/documents HTTP/1.1" 201 Created
INFO:app.services.document_service:尝试添加协作者: document_id=42, user_id=45, role=editor
INFO:app.services.document_service:插入新协作者记录
INFO:app.services.document_service:协作者添加成功
INFO:app.services.document_service:尝试添加协作者: document_id=42, user_id=46, role=viewer
INFO:app.services.document_service:插入新协作者记录
INFO:app.services.document_service:协作者添加成功
INFO:     127.0.0.1:6800 - "POST /api/v1/documents/42/collaborators/batch HTTP/1.1" 200 OK
INFO:     127.0.0.1:6803 - "GET /api/v1/documents/42 HTTP/1.1" 200 OK
INFO:     127.0.0.1:6804 - "GET /api/v1/documents/42 HTTP/1.1" 200 OK
DEBUG:    = connection is CONNECTING
DEBUG:    < GET /ws/documents/42?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0X3VzZXJfYSIsImV4cCI6MTc2NDA4NjgyMn0.XP5xJEtVmq_1hew1E3QGIm4QSUuauU4ufPlfVc7YAD0&username=test_user_a HTTP/1.1
DEBUG:    < host: 127.0.0.1:8000
DEBUG:    < upgrade: websocket
DEBUG:    < connection: Upgrade
DEBUG:    < sec-websocket-key: bTBx4i//lf6svzrfpyL2pg==
DEBUG:    < sec-websocket-version: 13
DEBUG:    < sec-websocket-extensions: permessage-deflate; client_max_window_bits
DEBUG:    < user-agent: Python/3.10 websockets/15.0.1
DEBUG:    = connection is CONNECTING
DEBUG:    = connection is CONNECTING
INFO:     127.0.0.1:6805 - "WebSocket /ws/documents/42?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0X3VzZXJfYSIsImV4cCI6MTc2NDA4NjgyMn0.XP5xJEtVmq_1hew1E3QGIm4QSUuauU4ufPlfVc7YAD0&username=test_user_a" [accepted]
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "D:\Projects\edit\venv\lib\site-packages\uvicorn\protocols\websockets\websockets_impl.py", line 244, in run_asgi
    result = await self.app(self.scope, self.asgi_receive, self.asgi_send)  # type: ignore[func-returns-value]
  File "D:\Projects\edit\venv\lib\site-packages\uvicorn\middleware\proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\applications.py", line 1134, in __call__
    await super().__call__(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\errors.py", line 151, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\cors.py", line 77, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\middleware\asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 364, in handle
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 151, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 148, in app
    await func(session)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 463, in app
    await dependant.call(**solved_result.values)
  File "D:\Projects\edit\app\api\routers\ws.py", line 206, in document_collab_ws
    await manager.connect(document_id, websocket, current_username, user_id)
UnboundLocalError: local variable 'user_id' referenced before assignment
DEBUG:    < GET /ws/documents/42?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0X3VzZXJfYiIsImV4cCI6MTc2NDA4NjgyM30.TeAN9GKNbH-dKg12nsqBZeVJaeqMqWzfUFGRAt7-364&username=test_user_b HTTP/1.1
DEBUG:    < host: 127.0.0.1:8000
DEBUG:    < upgrade: websocket
DEBUG:    < connection: Upgrade
DEBUG:    < sec-websocket-key: vnTFQ5F0ES/OhlQ732TJcg==
DEBUG:    < sec-websocket-version: 13
DEBUG:    < sec-websocket-extensions: permessage-deflate; client_max_window_bits
DEBUG:    < user-agent: Python/3.10 websockets/15.0.1
DEBUG:    < GET /ws/documents/42?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0X3VzZXJfYyIsImV4cCI6MTc2NDA4NjgyM30.WCpYYCnSYlUooC5KAd2KxLhAqQ53Rzm7gRGUFFtxYTI&username=test_user_c HTTP/1.1
DEBUG:    < host: 127.0.0.1:8000
DEBUG:    < upgrade: websocket
DEBUG:    < connection: Upgrade
DEBUG:    < sec-websocket-key: W3w1R/in6N2Cn97r1oXxHg==
DEBUG:    < sec-websocket-version: 13
DEBUG:    < sec-websocket-extensions: permessage-deflate; client_max_window_bits
DEBUG:    < user-agent: Python/3.10 websockets/15.0.1
DEBUG:    > HTTP/1.1 101 Switching Protocols
DEBUG:    > Upgrade: websocket
DEBUG:    > Connection: Upgrade
DEBUG:    > Sec-WebSocket-Accept: I0s9E2KMiiy7qYcIRzR/7XxQ9Fg=
DEBUG:    > Sec-WebSocket-Extensions: permessage-deflate
DEBUG:    > date: Tue, 25 Nov 2025 15:37:05 GMT
DEBUG:    > server: uvicorn
INFO:     connection open
DEBUG:    = connection is OPEN
INFO:     127.0.0.1:6806 - "WebSocket /ws/documents/42?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0X3VzZXJfYiIsImV4cCI6MTc2NDA4NjgyM30.TeAN9GKNbH-dKg12nsqBZeVJaeqMqWzfUFGRAt7-364&username=test_user_b" [accepted]
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "D:\Projects\edit\venv\lib\site-packages\uvicorn\protocols\websockets\websockets_impl.py", line 244, in run_asgi
    result = await self.app(self.scope, self.asgi_receive, self.asgi_send)  # type: ignore[func-returns-value]
  File "D:\Projects\edit\venv\lib\site-packages\uvicorn\middleware\proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\applications.py", line 1134, in __call__
    await super().__call__(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\errors.py", line 151, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\cors.py", line 77, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\middleware\asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 364, in handle
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 151, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 148, in app
    await func(session)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 463, in app
    await dependant.call(**solved_result.values)
  File "D:\Projects\edit\app\api\routers\ws.py", line 206, in document_collab_ws
    await manager.connect(document_id, websocket, current_username, user_id)
UnboundLocalError: local variable 'user_id' referenced before assignment
INFO:     127.0.0.1:6807 - "WebSocket /ws/documents/42?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0X3VzZXJfYyIsImV4cCI6MTc2NDA4NjgyM30.WCpYYCnSYlUooC5KAd2KxLhAqQ53Rzm7gRGUFFtxYTI&username=test_user_c" [accepted]
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "D:\Projects\edit\venv\lib\site-packages\uvicorn\protocols\websockets\websockets_impl.py", line 244, in run_asgi
    result = await self.app(self.scope, self.asgi_receive, self.asgi_send)  # type: ignore[func-returns-value]
  File "D:\Projects\edit\venv\lib\site-packages\uvicorn\middleware\proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\applications.py", line 1134, in __call__
    await super().__call__(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\errors.py", line 151, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\cors.py", line 77, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\middleware\asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 364, in handle
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 151, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 148, in app
    await func(session)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 463, in app
    await dependant.call(**solved_result.values)
  File "D:\Projects\edit\app\api\routers\ws.py", line 206, in document_collab_ws
    await manager.connect(document_id, websocket, current_username, user_id)
UnboundLocalError: local variable 'user_id' referenced before assignment
DEBUG:    > HTTP/1.1 101 Switching Protocols
DEBUG:    > Upgrade: websocket
DEBUG:    > Connection: Upgrade
DEBUG:    > Sec-WebSocket-Accept: EGp0Prmqx0P35dcjaWz81JO10Us=
DEBUG:    > Sec-WebSocket-Extensions: permessage-deflate
DEBUG:    > date: Tue, 25 Nov 2025 15:37:05 GMT
DEBUG:    > server: uvicorn
INFO:     connection open
DEBUG:    = connection is OPEN
DEBUG:    > HTTP/1.1 101 Switching Protocols
DEBUG:    > Upgrade: websocket
DEBUG:    > Connection: Upgrade
DEBUG:    > Sec-WebSocket-Accept: 2ZN/tAucYWLr8dyjTSVXveNZl40=
DEBUG:    > Sec-WebSocket-Extensions: permessage-deflate
DEBUG:    > date: Tue, 25 Nov 2025 15:37:05 GMT
DEBUG:    > server: uvicorn
INFO:     connection open
DEBUG:    = connection is OPEN
DEBUG:    = connection is CLOSED
DEBUG:    ! failing connection with code 1006
DEBUG:    = connection is CLOSED
DEBUG:    = connection is CLOSED
DEBUG:    x half-closing TCP connection
DEBUG:    ! failing connection with code 1006
DEBUG:    ! failing connection with code 1006
DEBUG:    x half-closing TCP connection
DEBUG:    x half-closing TCP connection
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
DEBUG:    = connection is CONNECTING
DEBUG:    < GET /ws/documents/42?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0X3VzZXJfYSIsImV4cCI6MTc2NDA4NjgyMn0.XP5xJEtVmq_1hew1E3QGIm4QSUuauU4ufPlfVc7YAD0&username=test_user_a HTTP/1.1
DEBUG:    < host: 127.0.0.1:8000
DEBUG:    < upgrade: websocket
DEBUG:    < connection: Upgrade
DEBUG:    < sec-websocket-key: Oy2jhK7pOtEL1xb493Fmgw==
DEBUG:    < sec-websocket-version: 13
DEBUG:    < sec-websocket-extensions: permessage-deflate; client_max_window_bits
DEBUG:    < user-agent: Python/3.10 websockets/15.0.1
INFO:     127.0.0.1:6812 - "WebSocket /ws/documents/42?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0X3VzZXJfYSIsImV4cCI6MTc2NDA4NjgyMn0.XP5xJEtVmq_1hew1E3QGIm4QSUuauU4ufPlfVc7YAD0&username=test_user_a" [accepted]
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "D:\Projects\edit\venv\lib\site-packages\uvicorn\protocols\websockets\websockets_impl.py", line 244, in run_asgi
    result = await self.app(self.scope, self.asgi_receive, self.asgi_send)  # type: ignore[func-returns-value]
  File "D:\Projects\edit\venv\lib\site-packages\uvicorn\middleware\proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\applications.py", line 1134, in __call__
    await super().__call__(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\errors.py", line 151, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\cors.py", line 77, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\middleware\asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 364, in handle
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 151, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 148, in app
    await func(session)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 463, in app
    await dependant.call(**solved_result.values)
  File "D:\Projects\edit\app\api\routers\ws.py", line 206, in document_collab_ws
    await manager.connect(document_id, websocket, current_username, user_id)
UnboundLocalError: local variable 'user_id' referenced before assignment
DEBUG:    > HTTP/1.1 101 Switching Protocols
DEBUG:    > Upgrade: websocket
DEBUG:    > Connection: Upgrade
DEBUG:    > Sec-WebSocket-Accept: fwC69fwa1cM7SRZUMGZvyhQvYtY=
DEBUG:    > Sec-WebSocket-Extensions: permessage-deflate
DEBUG:    > date: Tue, 25 Nov 2025 15:37:06 GMT
DEBUG:    > server: uvicorn
INFO:     connection open
DEBUG:    = connection is OPEN
DEBUG:    = connection is CLOSED
DEBUG:    ! failing connection with code 1006
DEBUG:    x half-closing TCP connection
INFO:     connection closed
DEBUG:    = connection is CONNECTING
DEBUG:    < GET /ws/documents/42?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0X3VzZXJfYiIsImV4cCI6MTc2NDA4NjgyM30.TeAN9GKNbH-dKg12nsqBZeVJaeqMqWzfUFGRAt7-364&username=test_user_b HTTP/1.1
DEBUG:    < host: 127.0.0.1:8000
DEBUG:    < upgrade: websocket
DEBUG:    < connection: Upgrade
DEBUG:    < sec-websocket-key: boGBNg4hdXEjiMpqsETeEA==
DEBUG:    < sec-websocket-version: 13
DEBUG:    < sec-websocket-extensions: permessage-deflate; client_max_window_bits
DEBUG:    < user-agent: Python/3.10 websockets/15.0.1
INFO:     127.0.0.1:6815 - "WebSocket /ws/documents/42?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0X3VzZXJfYiIsImV4cCI6MTc2NDA4NjgyM30.TeAN9GKNbH-dKg12nsqBZeVJaeqMqWzfUFGRAt7-364&username=test_user_b" [accepted]
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "D:\Projects\edit\venv\lib\site-packages\uvicorn\protocols\websockets\websockets_impl.py", line 244, in run_asgi
    result = await self.app(self.scope, self.asgi_receive, self.asgi_send)  # type: ignore[func-returns-value]
  File "D:\Projects\edit\venv\lib\site-packages\uvicorn\middleware\proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\applications.py", line 1134, in __call__
    await super().__call__(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\errors.py", line 151, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\cors.py", line 77, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\middleware\asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 364, in handle
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 151, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 148, in app
    await func(session)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 463, in app
    await dependant.call(**solved_result.values)
  File "D:\Projects\edit\app\api\routers\ws.py", line 206, in document_collab_ws
    await manager.connect(document_id, websocket, current_username, user_id)
UnboundLocalError: local variable 'user_id' referenced before assignment
DEBUG:    > HTTP/1.1 101 Switching Protocols
DEBUG:    > Upgrade: websocket
DEBUG:    > Connection: Upgrade
DEBUG:    > Sec-WebSocket-Accept: 5dsm02SHe9HZIzwrW8VuGfr7+Ms=
DEBUG:    > Sec-WebSocket-Extensions: permessage-deflate
DEBUG:    > date: Tue, 25 Nov 2025 15:37:07 GMT
DEBUG:    > server: uvicorn
INFO:     connection open
DEBUG:    = connection is OPEN
DEBUG:    = connection is CLOSED
DEBUG:    ! failing connection with code 1006
DEBUG:    x half-closing TCP connection
INFO:     connection closed
DEBUG:    = connection is CONNECTING
DEBUG:    < GET /ws/documents/42?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0X3VzZXJfYyIsImV4cCI6MTc2NDA4NjgyM30.WCpYYCnSYlUooC5KAd2KxLhAqQ53Rzm7gRGUFFtxYTI&username=test_user_c HTTP/1.1
DEBUG:    < host: 127.0.0.1:8000
DEBUG:    < upgrade: websocket
DEBUG:    < connection: Upgrade
DEBUG:    < sec-websocket-key: 9bcnOhVwzHkSkeWrbe8JKw==
DEBUG:    < sec-websocket-version: 13
DEBUG:    < sec-websocket-extensions: permessage-deflate; client_max_window_bits
DEBUG:    < user-agent: Python/3.10 websockets/15.0.1
INFO:     127.0.0.1:6818 - "WebSocket /ws/documents/42?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0X3VzZXJfYyIsImV4cCI6MTc2NDA4NjgyM30.WCpYYCnSYlUooC5KAd2KxLhAqQ53Rzm7gRGUFFtxYTI&username=test_user_c" [accepted]
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "D:\Projects\edit\venv\lib\site-packages\uvicorn\protocols\websockets\websockets_impl.py", line 244, in run_asgi
    result = await self.app(self.scope, self.asgi_receive, self.asgi_send)  # type: ignore[func-returns-value]
  File "D:\Projects\edit\venv\lib\site-packages\uvicorn\middleware\proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\applications.py", line 1134, in __call__
    await super().__call__(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\errors.py", line 151, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\cors.py", line 77, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\middleware\asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 364, in handle
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 151, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 148, in app
    await func(session)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 463, in app
    await dependant.call(**solved_result.values)
  File "D:\Projects\edit\app\api\routers\ws.py", line 206, in document_collab_ws
    await manager.connect(document_id, websocket, current_username, user_id)
UnboundLocalError: local variable 'user_id' referenced before assignment
DEBUG:    > HTTP/1.1 101 Switching Protocols
DEBUG:    > Upgrade: websocket
DEBUG:    > Connection: Upgrade
DEBUG:    > Sec-WebSocket-Accept: TNXGbZa+890jk7x1K2KHAID9LUk=
DEBUG:    > Sec-WebSocket-Extensions: permessage-deflate
DEBUG:    > date: Tue, 25 Nov 2025 15:37:08 GMT
DEBUG:    > server: uvicorn
INFO:     connection open
DEBUG:    = connection is OPEN
DEBUG:    = connection is CLOSED
DEBUG:    ! failing connection with code 1006
DEBUG:    x half-closing TCP connection
INFO:     connection closed
ERROR:app.db.session:Database connection error: 400: 用户名已被注册
Traceback (most recent call last):
  File "D:\Projects\edit\app\db\session.py", line 79, in get_db
    yield conn
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\concurrency.py", line 27, in contextmanager_in_threadpool
    yield await run_in_threadpool(cm.__enter__)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 111, in app
    response = await f(request)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 391, in app
    raw_response = await run_endpoint_function(
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 292, in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\concurrency.py", line 38, in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
  File "D:\Projects\edit\venv\lib\site-packages\anyio\to_thread.py", line 56, in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
  File "D:\Projects\edit\venv\lib\site-packages\anyio\_backends\_asyncio.py", line 2485, in run_sync_in_worker_thread
    return await future
  File "D:\Projects\edit\venv\lib\site-packages\anyio\_backends\_asyncio.py", line 976, in run
    result = context.run(func, *args)
  File "D:\Projects\edit\app\api\routers\auth.py", line 21, in register
    raise HTTPException(
fastapi.exceptions.HTTPException: 400: 用户名已被注册
WebSocket 连接请求: document_id=42, token=eyJhbGciOiJIUzI1NiIs...
WebSocket 连接已接受
JWT 验证成功，用户: test_user_a
WebSocket 连接请求: document_id=42, token=eyJhbGciOiJIUzI1NiIs...
WebSocket 连接已接受
JWT 验证成功，用户: test_user_b
WebSocket 连接请求: document_id=42, token=eyJhbGciOiJIUzI1NiIs...
WebSocket 连接已接受
JWT 验证成功，用户: test_user_c
WebSocket 连接请求: document_id=42, token=eyJhbGciOiJIUzI1NiIs...
WebSocket 连接已接受
JWT 验证成功，用户: test_user_a
WebSocket 连接请求: document_id=42, token=eyJhbGciOiJIUzI1NiIs...
WebSocket 连接已接受
JWT 验证成功，用户: test_user_b
WebSocket 连接请求: document_id=42, token=eyJhbGciOiJIUzI1NiIs...
WebSocket 连接已接受
JWT 验证成功，用户: test_user_c
INFO:     127.0.0.1:2495 - "POST /api/v1/auth/register HTTP/1.1" 400 Bad Request
INFO:     127.0.0.1:2496 - "POST /api/v1/auth/token HTTP/1.1" 200 OK
INFO:     127.0.0.1:2497 - "GET /api/v1/auth/me HTTP/1.1" 200 OK
ERROR:app.db.session:Database connection error: 400: 用户名已被注册
Traceback (most recent call last):
  File "D:\Projects\edit\app\db\session.py", line 79, in get_db
    yield conn
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\concurrency.py", line 27, in contextmanager_in_threadpool
    yield await run_in_threadpool(cm.__enter__)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 111, in app
    response = await f(request)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 391, in app
    raw_response = await run_endpoint_function(
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 292, in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\concurrency.py", line 38, in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
  File "D:\Projects\edit\venv\lib\site-packages\anyio\to_thread.py", line 56, in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
  File "D:\Projects\edit\venv\lib\site-packages\anyio\_backends\_asyncio.py", line 2485, in run_sync_in_worker_thread
    return await future
  File "D:\Projects\edit\venv\lib\site-packages\anyio\_backends\_asyncio.py", line 976, in run
    result = context.run(func, *args)
  File "D:\Projects\edit\app\api\routers\auth.py", line 21, in register
    raise HTTPException(
fastapi.exceptions.HTTPException: 400: 用户名已被注册
INFO:     127.0.0.1:2498 - "POST /api/v1/auth/register HTTP/1.1" 400 Bad Request
INFO:     127.0.0.1:2499 - "POST /api/v1/auth/token HTTP/1.1" 200 OK
INFO:     127.0.0.1:2500 - "GET /api/v1/auth/me HTTP/1.1" 200 OK
ERROR:app.db.session:Database connection error: 400: 用户名已被注册
Traceback (most recent call last):
  File "D:\Projects\edit\app\db\session.py", line 79, in get_db
    yield conn
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\concurrency.py", line 27, in contextmanager_in_threadpool
    yield await run_in_threadpool(cm.__enter__)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 111, in app
    response = await f(request)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 391, in app
    raw_response = await run_endpoint_function(
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 292, in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\concurrency.py", line 38, in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
  File "D:\Projects\edit\venv\lib\site-packages\anyio\to_thread.py", line 56, in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
  File "D:\Projects\edit\venv\lib\site-packages\anyio\_backends\_asyncio.py", line 2485, in run_sync_in_worker_thread
    return await future
  File "D:\Projects\edit\venv\lib\site-packages\anyio\_backends\_asyncio.py", line 976, in run
    result = context.run(func, *args)
  File "D:\Projects\edit\app\api\routers\auth.py", line 21, in register
    raise HTTPException(
fastapi.exceptions.HTTPException: 400: 用户名已被注册
INFO:     127.0.0.1:2503 - "POST /api/v1/auth/register HTTP/1.1" 400 Bad Request
INFO:     127.0.0.1:2504 - "POST /api/v1/auth/token HTTP/1.1" 200 OK
INFO:     127.0.0.1:2505 - "GET /api/v1/auth/me HTTP/1.1" 200 OK
INFO:     127.0.0.1:2506 - "POST /api/v1/documents HTTP/1.1" 201 Created
INFO:app.services.document_service:尝试添加协作者: document_id=43, user_id=45, role=editor
INFO:app.services.document_service:插入新协作者记录
INFO:app.services.document_service:协作者添加成功
INFO:app.services.document_service:尝试添加协作者: document_id=43, user_id=46, role=viewer
INFO:app.services.document_service:插入新协作者记录
INFO:app.services.document_service:协作者添加成功
INFO:     127.0.0.1:2507 - "POST /api/v1/documents/43/collaborators/batch HTTP/1.1" 200 OK
INFO:     127.0.0.1:2510 - "GET /api/v1/documents/43 HTTP/1.1" 200 OK
INFO:     127.0.0.1:2511 - "GET /api/v1/documents/43 HTTP/1.1" 200 OK
DEBUG:    = connection is CONNECTING
DEBUG:    < GET /ws/documents/43?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0X3VzZXJfYSIsImV4cCI6MTc2NDA4NjgzOX0.pGfqkPoGH99Lxrj5Ih4PnrfDUOQJk-xpCcuI9rRQMUc&username=test_user_a HTTP/1.1
DEBUG:    < host: 127.0.0.1:8000
DEBUG:    < upgrade: websocket
DEBUG:    < connection: Upgrade
DEBUG:    < sec-websocket-key: 9FM6aMFcI/a1izSfb9i5aQ==
DEBUG:    < sec-websocket-version: 13
DEBUG:    < sec-websocket-extensions: permessage-deflate; client_max_window_bits
DEBUG:    < user-agent: Python/3.10 websockets/15.0.1
DEBUG:    = connection is CONNECTING
DEBUG:    = connection is CONNECTING
INFO:     127.0.0.1:2514 - "WebSocket /ws/documents/43?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0X3VzZXJfYSIsImV4cCI6MTc2NDA4NjgzOX0.pGfqkPoGH99Lxrj5Ih4PnrfDUOQJk-xpCcuI9rRQMUc&username=test_user_a" [accepted]
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "D:\Projects\edit\venv\lib\site-packages\uvicorn\protocols\websockets\websockets_impl.py", line 244, in run_asgi
    result = await self.app(self.scope, self.asgi_receive, self.asgi_send)  # type: ignore[func-returns-value]
  File "D:\Projects\edit\venv\lib\site-packages\uvicorn\middleware\proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\applications.py", line 1134, in __call__
    await super().__call__(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\errors.py", line 151, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\cors.py", line 77, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\middleware\asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 364, in handle
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 151, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 148, in app
    await func(session)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 463, in app
    await dependant.call(**solved_result.values)
  File "D:\Projects\edit\app\api\routers\ws.py", line 206, in document_collab_ws
    await manager.connect(document_id, websocket, current_username, user_id)
UnboundLocalError: local variable 'user_id' referenced before assignment
DEBUG:    < GET /ws/documents/43?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0X3VzZXJfYiIsImV4cCI6MTc2NDA4Njg0MH0._anHkq1dacP32jtMhD9VDFq5AcLpBrlPEpPOVhSSGo4&username=test_user_b HTTP/1.1
DEBUG:    < host: 127.0.0.1:8000
DEBUG:    < upgrade: websocket
DEBUG:    < connection: Upgrade
DEBUG:    < sec-websocket-key: +P+GHD7n3bzzWXfaBu31Sw==
DEBUG:    < sec-websocket-version: 13
DEBUG:    < sec-websocket-extensions: permessage-deflate; client_max_window_bits
DEBUG:    < user-agent: Python/3.10 websockets/15.0.1
DEBUG:    < GET /ws/documents/43?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0X3VzZXJfYyIsImV4cCI6MTc2NDA4Njg0MH0.DDZ-7KSqUDWHllbIsbiP5cSJVlXjsdh-mKUA1U7ieHM&username=test_user_c HTTP/1.1
DEBUG:    < host: 127.0.0.1:8000
DEBUG:    < upgrade: websocket
DEBUG:    < connection: Upgrade
DEBUG:    < sec-websocket-key: VG2lUOudLgmfJ4qEfTuQrA==
DEBUG:    < sec-websocket-version: 13
DEBUG:    < sec-websocket-extensions: permessage-deflate; client_max_window_bits
DEBUG:    < user-agent: Python/3.10 websockets/15.0.1
DEBUG:    > HTTP/1.1 101 Switching Protocols
DEBUG:    > Upgrade: websocket
DEBUG:    > Connection: Upgrade
DEBUG:    > Sec-WebSocket-Accept: FP3a+CALeAeN7LdgA0UvtYZA/XY=
DEBUG:    > Sec-WebSocket-Extensions: permessage-deflate
DEBUG:    > date: Tue, 25 Nov 2025 15:37:22 GMT
DEBUG:    > server: uvicorn
INFO:     connection open
DEBUG:    = connection is OPEN
INFO:     127.0.0.1:2515 - "WebSocket /ws/documents/43?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0X3VzZXJfYiIsImV4cCI6MTc2NDA4Njg0MH0._anHkq1dacP32jtMhD9VDFq5AcLpBrlPEpPOVhSSGo4&username=test_user_b" [accepted]
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "D:\Projects\edit\venv\lib\site-packages\uvicorn\protocols\websockets\websockets_impl.py", line 244, in run_asgi
    result = await self.app(self.scope, self.asgi_receive, self.asgi_send)  # type: ignore[func-returns-value]
  File "D:\Projects\edit\venv\lib\site-packages\uvicorn\middleware\proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\applications.py", line 1134, in __call__
    await super().__call__(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\errors.py", line 151, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\cors.py", line 77, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\middleware\asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 364, in handle
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 151, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 148, in app
    await func(session)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 463, in app
    await dependant.call(**solved_result.values)
  File "D:\Projects\edit\app\api\routers\ws.py", line 206, in document_collab_ws
    await manager.connect(document_id, websocket, current_username, user_id)
UnboundLocalError: local variable 'user_id' referenced before assignment
INFO:     127.0.0.1:2516 - "WebSocket /ws/documents/43?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0X3VzZXJfYyIsImV4cCI6MTc2NDA4Njg0MH0.DDZ-7KSqUDWHllbIsbiP5cSJVlXjsdh-mKUA1U7ieHM&username=test_user_c" [accepted]
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "D:\Projects\edit\venv\lib\site-packages\uvicorn\protocols\websockets\websockets_impl.py", line 244, in run_asgi
    result = await self.app(self.scope, self.asgi_receive, self.asgi_send)  # type: ignore[func-returns-value]
  File "D:\Projects\edit\venv\lib\site-packages\uvicorn\middleware\proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\applications.py", line 1134, in __call__
    await super().__call__(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\errors.py", line 151, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\cors.py", line 77, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\middleware\asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 364, in handle
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 151, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 148, in app
    await func(session)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 463, in app
    await dependant.call(**solved_result.values)
  File "D:\Projects\edit\app\api\routers\ws.py", line 206, in document_collab_ws
    await manager.connect(document_id, websocket, current_username, user_id)
UnboundLocalError: local variable 'user_id' referenced before assignment
DEBUG:    > HTTP/1.1 101 Switching Protocols
DEBUG:    > Upgrade: websocket
DEBUG:    > Connection: Upgrade
DEBUG:    > Sec-WebSocket-Accept: VDOGO9hSke3IvLq60b00N3Jhutg=
DEBUG:    > Sec-WebSocket-Extensions: permessage-deflate
DEBUG:    > date: Tue, 25 Nov 2025 15:37:22 GMT
DEBUG:    > server: uvicorn
INFO:     connection open
DEBUG:    = connection is OPEN
DEBUG:    > HTTP/1.1 101 Switching Protocols
DEBUG:    > Upgrade: websocket
DEBUG:    > Connection: Upgrade
DEBUG:    > Sec-WebSocket-Accept: X+Qwxl1BwCfTAtze4u1GUgf7Hx0=
DEBUG:    > Sec-WebSocket-Extensions: permessage-deflate
DEBUG:    > date: Tue, 25 Nov 2025 15:37:22 GMT
DEBUG:    > server: uvicorn
INFO:     connection open
DEBUG:    = connection is OPEN
DEBUG:    = connection is CLOSED
DEBUG:    ! failing connection with code 1006
DEBUG:    = connection is CLOSED
DEBUG:    = connection is CLOSED
DEBUG:    x half-closing TCP connection
DEBUG:    ! failing connection with code 1006
DEBUG:    ! failing connection with code 1006
DEBUG:    x half-closing TCP connection
DEBUG:    x half-closing TCP connection
INFO:     connection closed
INFO:     connection closed
INFO:     connection closed
DEBUG:    = connection is CONNECTING
DEBUG:    < GET /ws/documents/43?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0X3VzZXJfYSIsImV4cCI6MTc2NDA4NjgzOX0.pGfqkPoGH99Lxrj5Ih4PnrfDUOQJk-xpCcuI9rRQMUc&username=test_user_a HTTP/1.1
DEBUG:    < host: 127.0.0.1:8000
DEBUG:    < upgrade: websocket
DEBUG:    < connection: Upgrade
DEBUG:    < sec-websocket-key: B3EpoKFtoYjhGr0l4o1FRQ==
DEBUG:    < sec-websocket-version: 13
DEBUG:    < sec-websocket-extensions: permessage-deflate; client_max_window_bits
DEBUG:    < user-agent: Python/3.10 websockets/15.0.1
INFO:     127.0.0.1:2519 - "WebSocket /ws/documents/43?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0X3VzZXJfYSIsImV4cCI6MTc2NDA4NjgzOX0.pGfqkPoGH99Lxrj5Ih4PnrfDUOQJk-xpCcuI9rRQMUc&username=test_user_a" [accepted]
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "D:\Projects\edit\venv\lib\site-packages\uvicorn\protocols\websockets\websockets_impl.py", line 244, in run_asgi
    result = await self.app(self.scope, self.asgi_receive, self.asgi_send)  # type: ignore[func-returns-value]
  File "D:\Projects\edit\venv\lib\site-packages\uvicorn\middleware\proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\applications.py", line 1134, in __call__
    await super().__call__(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\errors.py", line 151, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\cors.py", line 77, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\middleware\asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 364, in handle
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 151, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 148, in app
    await func(session)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 463, in app
    await dependant.call(**solved_result.values)
  File "D:\Projects\edit\app\api\routers\ws.py", line 206, in document_collab_ws
    await manager.connect(document_id, websocket, current_username, user_id)
UnboundLocalError: local variable 'user_id' referenced before assignment
DEBUG:    > HTTP/1.1 101 Switching Protocols
DEBUG:    > Upgrade: websocket
DEBUG:    > Connection: Upgrade
DEBUG:    > Sec-WebSocket-Accept: 7+GWo3Gz+qkNKBFMLTW0039l3uI=
DEBUG:    > Sec-WebSocket-Extensions: permessage-deflate
DEBUG:    > date: Tue, 25 Nov 2025 15:37:23 GMT
DEBUG:    > server: uvicorn
INFO:     connection open
DEBUG:    = connection is OPEN
DEBUG:    = connection is CLOSED
DEBUG:    ! failing connection with code 1006
DEBUG:    x half-closing TCP connection
INFO:     connection closed
DEBUG:    = connection is CONNECTING
DEBUG:    < GET /ws/documents/43?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0X3VzZXJfYiIsImV4cCI6MTc2NDA4Njg0MH0._anHkq1dacP32jtMhD9VDFq5AcLpBrlPEpPOVhSSGo4&username=test_user_b HTTP/1.1
DEBUG:    < host: 127.0.0.1:8000
DEBUG:    < upgrade: websocket
DEBUG:    < connection: Upgrade
DEBUG:    < sec-websocket-key: 8MDud4l8ttSmzsXs0zIc9A==
DEBUG:    < sec-websocket-version: 13
DEBUG:    < sec-websocket-extensions: permessage-deflate; client_max_window_bits
DEBUG:    < user-agent: Python/3.10 websockets/15.0.1
INFO:     127.0.0.1:2522 - "WebSocket /ws/documents/43?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0X3VzZXJfYiIsImV4cCI6MTc2NDA4Njg0MH0._anHkq1dacP32jtMhD9VDFq5AcLpBrlPEpPOVhSSGo4&username=test_user_b" [accepted]
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "D:\Projects\edit\venv\lib\site-packages\uvicorn\protocols\websockets\websockets_impl.py", line 244, in run_asgi
    result = await self.app(self.scope, self.asgi_receive, self.asgi_send)  # type: ignore[func-returns-value]
  File "D:\Projects\edit\venv\lib\site-packages\uvicorn\middleware\proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\applications.py", line 1134, in __call__
    await super().__call__(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\errors.py", line 151, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\cors.py", line 77, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\middleware\asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 364, in handle
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 151, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 148, in app
    await func(session)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 463, in app
    await dependant.call(**solved_result.values)
  File "D:\Projects\edit\app\api\routers\ws.py", line 206, in document_collab_ws
    await manager.connect(document_id, websocket, current_username, user_id)
UnboundLocalError: local variable 'user_id' referenced before assignment
DEBUG:    > HTTP/1.1 101 Switching Protocols
DEBUG:    > Upgrade: websocket
DEBUG:    > Connection: Upgrade
DEBUG:    > Sec-WebSocket-Accept: tHS1ntI2b+FdCAiD0NM8DxowQmY=
DEBUG:    > Sec-WebSocket-Extensions: permessage-deflate
DEBUG:    > date: Tue, 25 Nov 2025 15:37:24 GMT
DEBUG:    > server: uvicorn
INFO:     connection open
DEBUG:    = connection is OPEN
DEBUG:    = connection is CLOSED
DEBUG:    ! failing connection with code 1006
DEBUG:    x half-closing TCP connection
INFO:     connection closed
DEBUG:    = connection is CONNECTING
DEBUG:    < GET /ws/documents/43?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0X3VzZXJfYyIsImV4cCI6MTc2NDA4Njg0MH0.DDZ-7KSqUDWHllbIsbiP5cSJVlXjsdh-mKUA1U7ieHM&username=test_user_c HTTP/1.1
DEBUG:    < host: 127.0.0.1:8000
DEBUG:    < upgrade: websocket
DEBUG:    < connection: Upgrade
DEBUG:    < sec-websocket-key: WelVdk80G+2SUHOi6Q1gdQ==
DEBUG:    < sec-websocket-version: 13
DEBUG:    < sec-websocket-extensions: permessage-deflate; client_max_window_bits
DEBUG:    < user-agent: Python/3.10 websockets/15.0.1
INFO:     127.0.0.1:2525 - "WebSocket /ws/documents/43?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0X3VzZXJfYyIsImV4cCI6MTc2NDA4Njg0MH0.DDZ-7KSqUDWHllbIsbiP5cSJVlXjsdh-mKUA1U7ieHM&username=test_user_c" [accepted]
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "D:\Projects\edit\venv\lib\site-packages\uvicorn\protocols\websockets\websockets_impl.py", line 244, in run_asgi
    result = await self.app(self.scope, self.asgi_receive, self.asgi_send)  # type: ignore[func-returns-value]
  File "D:\Projects\edit\venv\lib\site-packages\uvicorn\middleware\proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\applications.py", line 1134, in __call__
    await super().__call__(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\errors.py", line 151, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\cors.py", line 77, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\middleware\asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\routing.py", line 364, in handle
    await self.app(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 151, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "D:\Projects\edit\venv\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 148, in app
    await func(session)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 463, in app
    await dependant.call(**solved_result.values)
  File "D:\Projects\edit\app\api\routers\ws.py", line 206, in document_collab_ws
    await manager.connect(document_id, websocket, current_username, user_id)
UnboundLocalError: local variable 'user_id' referenced before assignment
DEBUG:    > HTTP/1.1 101 Switching Protocols
DEBUG:    > Upgrade: websocket
DEBUG:    > Connection: Upgrade
DEBUG:    > Sec-WebSocket-Accept: G9qurZeVkMo4UE32CjVtY9UTGBg=
DEBUG:    > Sec-WebSocket-Extensions: permessage-deflate
DEBUG:    > date: Tue, 25 Nov 2025 15:37:25 GMT
DEBUG:    > server: uvicorn
INFO:     connection open
DEBUG:    = connection is OPEN
DEBUG:    = connection is CLOSED
DEBUG:    ! failing connection with code 1006
DEBUG:    x half-closing TCP connection
INFO:     connection closed
WebSocket 连接请求: document_id=43, token=eyJhbGciOiJIUzI1NiIs...
WebSocket 连接已接受
JWT 验证成功，用户: test_user_a
WebSocket 连接请求: document_id=43, token=eyJhbGciOiJIUzI1NiIs...
WebSocket 连接已接受
JWT 验证成功，用户: test_user_b
WebSocket 连接请求: document_id=43, token=eyJhbGciOiJIUzI1NiIs...
WebSocket 连接已接受
JWT 验证成功，用户: test_user_c
WebSocket 连接请求: document_id=43, token=eyJhbGciOiJIUzI1NiIs...
WebSocket 连接已接受
JWT 验证成功，用户: test_user_a
WebSocket 连接请求: document_id=43, token=eyJhbGciOiJIUzI1NiIs...
WebSocket 连接已接受
JWT 验证成功，用户: test_user_b
WebSocket 连接请求: document_id=43, token=eyJhbGciOiJIUzI1NiIs...
WebSocket 连接已接受
JWT 验证成功，用户: test_user_c
INFO:     127.0.0.1:13282 - "POST /api/v1/auth/token HTTP/1.1" 200 OK
INFO:     127.0.0.1:13283 - "POST /api/v1/documents HTTP/1.1" 201 Created
INFO:     127.0.0.1:13284 - "POST /api/v1/auth/token HTTP/1.1" 200 OK
INFO:app.services.document_service:尝试添加协作者: document_id=44, user_id=45, role=editor
INFO:app.services.document_service:插入新协作者记录
INFO:app.services.document_service:协作者添加成功
INFO:     127.0.0.1:13287 - "POST /api/v1/documents/44/collaborators HTTP/1.1" 200 OK
INFO:     127.0.0.1:13288 - "POST /api/v1/auth/token HTTP/1.1" 200 OK
INFO:app.services.document_service:尝试添加协作者: document_id=44, user_id=46, role=viewer
INFO:app.services.document_service:插入新协作者记录
INFO:app.services.document_service:协作者添加成功
INFO:     127.0.0.1:13289 - "POST /api/v1/documents/44/collaborators HTTP/1.1" 200 OK
INFO:     127.0.0.1:13292 - "POST /api/v1/auth/token HTTP/1.1" 200 OK
INFO:     127.0.0.1:13293 - "GET /api/v1/documents/44 HTTP/1.1" 200 OK
INFO:     127.0.0.1:13294 - "POST /api/v1/auth/token HTTP/1.1" 200 OK
INFO:     127.0.0.1:13297 - "GET /api/v1/documents/44 HTTP/1.1" 200 OK
INFO:     127.0.0.1:13298 - "POST /api/v1/auth/token HTTP/1.1" 200 OK
INFO:     127.0.0.1:13299 - "GET /api/v1/documents/44/collaborators HTTP/1.1" 200 OK
INFO:     127.0.0.1:13300 - "POST /api/v1/auth/token HTTP/1.1" 200 OK
INFO:     127.0.0.1:13303 - "GET /api/v1/documents/shared HTTP/1.1" 200 OK
INFO:     127.0.0.1:13304 - "POST /api/v1/auth/token HTTP/1.1" 200 OK
INFO:     127.0.0.1:13305 - "GET /api/v1/documents/shared HTTP/1.1" 200 OK
INFO:     127.0.0.1:13306 - "POST /api/v1/auth/token HTTP/1.1" 200 OK
INFO:     127.0.0.1:13309 - "PUT /api/v1/documents/44 HTTP/1.1" 200 OK
INFO:     127.0.0.1:13311 - "POST /api/v1/auth/token HTTP/1.1" 200 OK
ERROR:app.db.session:Database connection error: 403: 无编辑权限
Traceback (most recent call last):
  File "D:\Projects\edit\app\db\session.py", line 79, in get_db
    yield conn
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\concurrency.py", line 27, in contextmanager_in_threadpool
    yield await run_in_threadpool(cm.__enter__)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 111, in app
    response = await f(request)
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 391, in app
    raw_response = await run_endpoint_function(
  File "D:\Projects\edit\venv\lib\site-packages\fastapi\routing.py", line 290, in run_endpoint_function
    return await dependant.call(**values)
  File "D:\Projects\edit\app\api\routers\documents.py", line 444, in update_document_endpoint
    raise HTTPException(status_code=403, detail="无编辑权限")
fastapi.exceptions.HTTPException: 403: 无编辑权限
INFO:     127.0.0.1:13314 - "PUT /api/v1/documents/44 HTTP/1.1" 403 Forbidden
INFO:     127.0.0.1:13315 - "POST /api/v1/auth/token HTTP/1.1" 200 OK
INFO:     127.0.0.1:13316 - "GET /api/v1/documents/44 HTTP/1.1" 200 OK
