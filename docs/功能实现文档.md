# 多人协作文档编辑系统 - 功能实现文档

## 📋 概述

本文档详细说明了系统中所有新增功能的实现位置、使用方法和配置说明。

---

## 一、认证与安全模块

### 1.1 找回/重置密码

**功能说明**：用户可通过邮箱或手机验证码重置密码。

**实现位置**：
- 服务层：`app/services/verification_service.py`
- 路由层：`app/api/routers/auth.py`

**API 端点**：
| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/v1/auth/password-reset/request` | 请求密码重置验证码 |
| POST | `/api/v1/auth/password-reset/verify` | 验证并重置密码 |

**使用示例**：
```json
// 请求验证码
POST /api/v1/auth/password-reset/request
{
    "email": "user@example.com"
}

// 重置密码
POST /api/v1/auth/password-reset/verify
{
    "email": "user@example.com",
    "code": "123456",
    "new_password": "newPassword123"
}
```

**数据表**：`verification_codes`

---

### 1.2 验证码登录

**功能说明**：用户可通过邮箱或手机验证码直接登录，无需密码。

**实现位置**：
- 服务层：`app/services/verification_service.py`
- 路由层：`app/api/routers/auth.py`

**API 端点**：
| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/v1/auth/login/code/request` | 请求登录验证码 |
| POST | `/api/v1/auth/login/code/verify` | 验证码登录 |

**配置说明**：
- 验证码长度：6位数字
- 有效期：10分钟
- 最大尝试次数：5次

**注意**：邮件/短信发送目前为模拟实现，生产环境需配置：
```python
# app/core/config.py
SMTP_HOST = "smtp.example.com"
SMTP_PORT = 587
SMTP_USER = "user"
SMTP_PASSWORD = "password"
SMS_ACCESS_KEY_ID = "your-key"
SMS_ACCESS_KEY_SECRET = "your-secret"
```

---

### 1.3 OAuth2 社交登录

**功能说明**：支持 GitHub 和 Google 第三方登录。

**实现位置**：
- 服务层：`app/services/oauth_service.py`
- 路由层：`app/api/routers/auth.py`

**API 端点**：
| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/v1/auth/oauth/providers` | 获取支持的提供商列表 |
| GET | `/api/v1/auth/oauth/{provider}/authorize` | 获取授权URL |
| POST | `/api/v1/auth/oauth/{provider}/callback` | 处理授权回调 |
| GET | `/api/v1/auth/oauth/accounts` | 获取已绑定的账户 |
| DELETE | `/api/v1/auth/oauth/{provider}` | 解绑OAuth账户 |

**环境变量配置**：
```bash
# GitHub OAuth
GITHUB_CLIENT_ID=your_client_id
GITHUB_CLIENT_SECRET=your_client_secret

# Google OAuth
GOOGLE_CLIENT_ID=your_client_id
GOOGLE_CLIENT_SECRET=your_client_secret
```

**数据表**：`oauth_accounts`

**使用流程**：
1. 前端调用 `/oauth/{provider}/authorize?redirect_uri=xxx` 获取授权URL
2. 重定向用户到授权URL
3. 用户授权后回调到 redirect_uri，携带 code 参数
4. 前端调用 `/oauth/{provider}/callback` 完成登录

---

### 1.4 双因素认证 (2FA/TOTP)

**功能说明**：基于时间的一次性密码认证，支持 Google Authenticator 等验证器 App。

**实现位置**：
- 服务层：`app/services/totp_service.py`
- 路由层：`app/api/routers/auth.py`

**API 端点**：
| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/v1/auth/2fa/status` | 获取2FA状态 |
| POST | `/api/v1/auth/2fa/setup` | 设置2FA（获取密钥和二维码URI） |
| POST | `/api/v1/auth/2fa/enable` | 启用2FA |
| POST | `/api/v1/auth/2fa/disable` | 禁用2FA |
| POST | `/api/v1/auth/2fa/backup-codes/regenerate` | 重新生成备用码 |
| POST | `/api/v1/auth/token/2fa` | 带2FA的登录 |

**使用流程**：
1. 调用 `/2fa/setup` 获取密钥和二维码URI
2. 用户使用验证器App扫描二维码
3. 调用 `/2fa/enable` 并提供验证码完成启用
4. 启用后登录需要提供 TOTP 验证码

**备用码**：
- 系统自动生成10个备用码
- 每个备用码只能使用一次
- 格式：XXXX-XXXX

**数据表**：`totp_secrets`

---

## 二、实时通讯模块

### 2.1 文档内实时聊天

**功能说明**：在文档协作时进行实时聊天。

**实现位置**：
- 服务层：`app/services/chat_service.py`
- 路由层：`app/api/routers/chat.py`

**REST API 端点**：
| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/v1/documents/{document_id}/chat` | 获取聊天记录 |
| POST | `/api/v1/documents/{document_id}/chat` | 发送消息 |
| DELETE | `/api/v1/documents/{document_id}/chat/{message_id}` | 删除消息 |

**WebSocket 端点**：
```
ws://host/api/v1/documents/{document_id}/chat/ws?token=xxx
```

**WebSocket 消息类型**：
```json
// 发送聊天消息
{"type": "chat_message", "content": "Hello!", "message_type": "text"}

// 正在输入状态
{"type": "typing", "is_typing": true}

// 服务端推送 - 新消息
{"type": "chat_message", "message": {...}}

// 服务端推送 - 用户加入/离开
{"type": "chat_user_joined", "user_id": 1, "username": "xxx"}
{"type": "chat_user_left", "user_id": 1, "username": "xxx"}
```

**数据表**：`chat_messages`

---

## 三、系统管理模块

### 3.1 系统监控仪表板

**功能说明**：收集和展示系统性能指标、应用统计、数据库状态。

**实现位置**：
- 服务层：`app/services/monitoring_service.py`
- 路由层：`app/api/routers/admin.py`

**API 端点**：
| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| GET | `/api/v1/admin/monitoring/health` | 健康检查 | 公开 |
| GET | `/api/v1/admin/monitoring/system` | 系统信息 | 管理员 |
| GET | `/api/v1/admin/monitoring/application` | 应用统计 | 管理员 |
| GET | `/api/v1/admin/monitoring/database` | 数据库统计 | 管理员 |
| GET | `/api/v1/admin/monitoring/dashboard` | 综合监控 | 管理员 |
| GET | `/api/v1/admin/monitoring/metrics/{name}` | 指标历史 | 管理员 |
| POST | `/api/v1/admin/monitoring/cleanup` | 清理过期数据 | 管理员 |

**监控指标**：
- CPU/内存/磁盘使用率
- 在线用户数
- WebSocket连接数
- 今日活跃用户
- 各表数据量

**可选依赖**：安装 `psutil` 可获取更详细的系统信息
```bash
pip install psutil
```

**数据表**：`system_metrics`

---

### 3.2 数据备份与恢复

**功能说明**：支持数据库表的导出备份和恢复。

**实现位置**：
- 服务层：`app/services/backup_service.py`
- 路由层：`app/api/routers/admin.py`

**API 端点**：
| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/v1/admin/backup/list` | 列出所有备份 |
| POST | `/api/v1/admin/backup/create` | 创建备份 |
| GET | `/api/v1/admin/backup/{name}` | 获取备份详情 |
| POST | `/api/v1/admin/backup/restore` | 恢复备份 |
| DELETE | `/api/v1/admin/backup/{name}` | 删除备份 |
| GET | `/api/v1/admin/backup/export/{table}` | 导出单表 |
| POST | `/api/v1/admin/backup/cleanup` | 清理旧备份 |

**创建备份示例**：
```json
POST /api/v1/admin/backup/create
{
    "tables": ["users", "documents"],  // 可选，默认所有表
    "compress": true  // 是否压缩
}
```

**恢复备份示例**：
```json
POST /api/v1/admin/backup/restore
{
    "backup_name": "backup_20231129_120000",
    "tables": ["users"],  // 可选
    "truncate": false  // 是否先清空表
}
```

**备份目录**：`backups/`（可通过 `BACKUP_DIR` 环境变量配置）

**支持的导出格式**：JSON、CSV

---

## 四、协同编辑模块

### 4.1 CRDT 冲突自动解决

**功能说明**：基于 RGA (Replicated Growable Array) 算法的 CRDT 实现，支持多人同时编辑时的冲突自动解决。

**实现位置**：
- 核心算法：`app/crdt.py`
- WebSocket 服务：`app/services/websocket_service.py`
- 前端编辑器：`static/editor.js`

**核心类**：

| 类名 | 说明 |
|------|------|
| `Operation` | 操作记录（插入/删除/保持） |
| `Element` | 文档元素（带唯一ID和时间戳） |
| `CRDT` | 单客户端 CRDT 实例 |
| `DocumentCRDT` | 文档级 CRDT 管理器 |

**CRDT 操作类型**：
```python
from app.crdt import OpType, CRDT

crdt = CRDT(client_id="user_1")

# 插入字符
op = crdt.insert(0, "H")  # 在位置0插入字符H

# 删除字符
op = crdt.delete(0)  # 删除位置0的字符

# 批量插入
ops = crdt.insert_text(0, "Hello")  # 插入字符串

# 批量删除
ops = crdt.delete_range(0, 5)  # 删除5个字符
```

**冲突解决策略**：
1. **唯一标识**：每个字符都有唯一ID（client_id + timestamp + uuid）
2. **时间戳排序**：并发插入时按时间戳排序
3. **客户端ID 次序**：相同时间戳按客户端ID字典序排序
4. **墓碑删除**：删除操作标记为 deleted，不实际移除

**WebSocket CRDT 消息协议**：

```json
// 客户端 -> 服务端：发送操作
{
    "type": "crdt_ops",
    "ops": [
        {
            "type": "insert",
            "position": 0,
            "char": "H",
            "client_id": "user_1",
            "timestamp": 1701234567.123,
            "op_id": "user_1:1701234567.123:abc123"
        }
    ]
}

// 服务端 -> 客户端：广播操作
{
    "type": "crdt_ops",
    "ops": [...],
    "version": 42,
    "user_id": 1
}

// 服务端 -> 发送者：确认
{
    "type": "crdt_ack",
    "version": 42,
    "applied": 1
}
```

**文档状态管理**：

```python
from app.crdt import get_document_crdt

# 获取文档 CRDT 管理器
doc_crdt = get_document_crdt(document_id=1)

# 获取客户端 CRDT
client = doc_crdt.get_client("user_1")

# 应用客户端操作
result = doc_crdt.apply_client_ops("user_1", ops)

# 获取文档状态
state = doc_crdt.get_document_state()
# {
#     "document_id": 1,
#     "text": "Hello World",
#     "version": 42,
#     "clients": ["user_1", "user_2"],
#     "operations_count": 100
# }
```

**性能优化**：
- 操作 ID 防重复：已应用的操作不会重复执行
- 增量同步：只同步变更的操作，不是全量内容
- 压缩功能：可移除已删除的元素以节省内存

**使用注意**：
- 前端需支持 CRDT 操作模式（发送 `crdt_ops` 消息）
- 兼容现有的全量同步模式（`content_update` 消息）

---

## 五、新增数据表

运行以下脚本创建新表：
```bash
python scripts/check_new_tables.py
```

| 表名 | 用途 |
|------|------|
| `verification_codes` | 验证码存储 |
| `oauth_accounts` | OAuth账户绑定 |
| `totp_secrets` | 2FA密钥存储 |
| `chat_messages` | 聊天消息 |
| `system_metrics` | 监控指标 |

---

## 五、配置项汇总

在 `app/core/config.py` 中新增的配置：

```python
# OAuth2 - GitHub
GITHUB_CLIENT_ID: str
GITHUB_CLIENT_SECRET: str

# OAuth2 - Google
GOOGLE_CLIENT_ID: str
GOOGLE_CLIENT_SECRET: str

# 邮件服务 (SMTP)
SMTP_HOST: str
SMTP_PORT: int
SMTP_USER: str
SMTP_PASSWORD: str
SMTP_FROM_EMAIL: str

# 短信服务 (阿里云)
SMS_ACCESS_KEY_ID: str
SMS_ACCESS_KEY_SECRET: str
SMS_SIGN_NAME: str
SMS_TEMPLATE_CODE: str
```

**环境变量配置示例** (`.env`)：
```bash
# OAuth2
GITHUB_CLIENT_ID=xxx
GITHUB_CLIENT_SECRET=xxx
GOOGLE_CLIENT_ID=xxx
GOOGLE_CLIENT_SECRET=xxx

# 邮件
SMTP_HOST=smtp.qq.com
SMTP_PORT=587
SMTP_USER=your@qq.com
SMTP_PASSWORD=xxx

# 短信
SMS_ACCESS_KEY_ID=xxx
SMS_ACCESS_KEY_SECRET=xxx
SMS_SIGN_NAME=协作文档
SMS_TEMPLATE_CODE=SMS_123456

# 备份
BACKUP_DIR=backups
```

---

## 六、功能实现状态总览

| 功能 | 状态 | 实现文件 |
|------|------|---------|
| ✅ 找回/重置密码 | 已完成 | `verification_service.py`, `auth.py` |
| ✅ 验证码登录 | 已完成 | `verification_service.py`, `auth.py` |
| ✅ OAuth2 社交登录 | 已完成 | `oauth_service.py`, `auth.py` |
| ✅ 双因素认证 (2FA) | 已完成 | `totp_service.py`, `auth.py` |
| ✅ 实时聊天 | 已完成 | `chat_service.py`, `chat.py` |
| ✅ 系统监控 | 已完成 | `monitoring_service.py`, `admin.py` |
| ✅ 数据备份 | 已完成 | `backup_service.py`, `admin.py` |
| ✅ CRDT 冲突解决 | 已完成 | `crdt.py`, `websocket_service.py` |

---

## 八、待完善功能

| 功能 | 说明 |
|------|------|
| 邮件/短信发送 | 目前为模拟实现，需集成实际服务 |
| 视频/音频通话 | 需集成 WebRTC |
| 前端 CRDT 支持 | 前端编辑器需要支持发送 crdt_ops 消息 |

---

*文档更新时间：2025年11月29日*
