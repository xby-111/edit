# é¡¹ç›®æŠ€æœ¯æ¦‚è§ˆä¸æ¥å£è¯´æ˜

## 1. é¡¹ç›®æ•´ä½“æ¦‚å†µ

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäº FastAPI çš„**åä½œç¼–è¾‘å™¨åç«¯ç³»ç»Ÿ**ï¼Œæ”¯æŒå¤šç”¨æˆ·å®æ—¶åä½œç¼–è¾‘æ–‡æ¡£ã€‚ç³»ç»Ÿæä¾›å®Œæ•´çš„ç”¨æˆ·è®¤è¯ã€æƒé™ç®¡ç†ã€æ–‡æ¡£ç‰ˆæœ¬æ§åˆ¶ç­‰åŠŸèƒ½ï¼Œå¹¶é€šè¿‡ WebSocket å®ç°å®æ—¶åä½œç¼–è¾‘èƒ½åŠ›ã€‚é¡¹ç›®é¢å‘éœ€è¦å¤šäººåä½œç¼–è¾‘æ–‡æ¡£çš„åœºæ™¯ï¼Œå¦‚å›¢é˜Ÿæ–‡æ¡£åä½œã€åœ¨çº¿ç¼–è¾‘å™¨ç­‰åº”ç”¨åœºæ™¯ã€‚

**ä¸»è¦æŠ€æœ¯æ ˆï¼š**
- **åç«¯æ¡†æ¶**ï¼šFastAPI 0.121.2
- **ç¼–ç¨‹è¯­è¨€**ï¼šPython 3.10+
- **æ•°æ®åº“**ï¼šOpenGaussï¼ˆå…¼å®¹ PostgreSQL åè®®ï¼‰
- **ORM**ï¼šSQLAlchemy 2.0.44
- **è®¤è¯æ–¹å¼**ï¼šJWT Tokenï¼ˆpython-joseï¼‰
- **å¯†ç åŠ å¯†**ï¼šbcryptï¼ˆpasslibï¼‰
- **å®æ—¶é€šä¿¡**ï¼šWebSocketï¼ˆwebsockets 15.0.1ï¼‰
- **WebæœåŠ¡å™¨**ï¼šUvicorn 0.38.0
- **æ•°æ®éªŒè¯**ï¼šPydanticï¼ˆpydantic-settings 2.0.3ï¼‰

**æ ¸å¿ƒç›®å½•ç»“æ„ï¼š**
- `api/routers/` - API è·¯ç”±å±‚ï¼Œå®šä¹‰æ‰€æœ‰ HTTP æ¥å£å’Œ WebSocket ç«¯ç‚¹
- `services/` - ä¸šåŠ¡é€»è¾‘å±‚ï¼Œå°è£…æ ¸å¿ƒä¸šåŠ¡å¤„ç†é€»è¾‘
- `models/` - æ•°æ®æ¨¡å‹å±‚ï¼Œå®šä¹‰ SQLAlchemy ORM æ¨¡å‹
- `schemas/` - æ•°æ®éªŒè¯å±‚ï¼Œå®šä¹‰ Pydantic æ•°æ®æ¨¡å‹å’Œè¯·æ±‚/å“åº”ç»“æ„
- `db/` - æ•°æ®åº“ç›¸å…³ï¼ŒåŒ…å«è¿æ¥é…ç½®ã€åˆå§‹åŒ–è„šæœ¬
- `core/` - æ ¸å¿ƒé…ç½®å’Œå®‰å…¨æ¨¡å—ï¼ŒåŒ…å«åº”ç”¨é…ç½®ã€JWT è®¤è¯ã€å¯†ç åŠ å¯†ç­‰
- `utils/` - å·¥å…·å‡½æ•°ï¼ŒåŒ…å«å¼‚å¸¸å®šä¹‰ã€å“åº”æ ¼å¼åŒ–ç­‰
- `static/` - é™æ€æ–‡ä»¶ç›®å½•
- `templates/` - HTML æ¨¡æ¿æ–‡ä»¶
- `app/` - åº”ç”¨ä¸»å…¥å£å’Œ CRDT ç›¸å…³ä»£ç 

---

## 2. æ•°æ®åº“ä¸æ•°æ®æ¨¡å‹

### 2.1 æ•°æ®åº“è¿æ¥é…ç½®

**æ•°æ®åº“ç±»å‹**ï¼šOpenGaussï¼ˆä½¿ç”¨ PostgreSQL æ–¹è¨€ï¼‰

**è¿æ¥é…ç½®ä½ç½®**ï¼š`core/config.py`

**è¿æ¥å­—ç¬¦ä¸²æ ¼å¼**ï¼š
```
postgresql+psycopg2://ç”¨æˆ·å:å¯†ç @ä¸»æœº:ç«¯å£/æ•°æ®åº“å
```

**é»˜è®¤é…ç½®**ï¼ˆå¯é€šè¿‡ç¯å¢ƒå˜é‡ `DATABASE_URL` è¦†ç›–ï¼‰ï¼š
- é»˜è®¤è¿æ¥ï¼š`postgresql+psycopg2://appuser:***@localhost:5432/editdb`
- è¿æ¥æ± é…ç½®ï¼ˆ`db/session.py`ï¼‰ï¼š
  - `pool_size`: 10
  - `max_overflow`: 20
  - `pool_pre_ping`: Trueï¼ˆè¿æ¥å‰éªŒè¯æœ‰æ•ˆæ€§ï¼‰

### 2.2 æ•°æ®åº“è¡¨ç»“æ„

#### 2.2.1 ç”¨æˆ·è¡¨ (users)

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, AUTO_INCREMENT | ç”¨æˆ·ID |
| username | String(50) | UNIQUE, INDEX, NOT NULL | ç”¨æˆ·å |
| email | String(100) | UNIQUE, INDEX | é‚®ç®±åœ°å€ |
| phone | String(20) | UNIQUE, INDEX | æ‰‹æœºå· |
| hashed_password | String(255) | NOT NULL | å¯†ç å“ˆå¸Œå€¼ |
| is_active | Boolean | DEFAULT=True | è´¦æˆ·æ˜¯å¦æ¿€æ´» |
| role | String(20) | DEFAULT="viewer" | ç”¨æˆ·è§’è‰²ï¼šadmin/editor/viewer |
| avatar_url | String(500) | | å¤´åƒURL |
| full_name | String(100) | | å…¨å |
| bio | Text | | ä¸ªäººç®€ä»‹ |
| address | String(500) | | åœ°å€ |
| phone_secondary | String(20) | | å¤‡ç”¨ç”µè¯ |
| password_reset_token | String(255) | | å¯†ç é‡ç½®ä»¤ç‰Œ |
| password_reset_expires | DateTime | | å¯†ç é‡ç½®è¿‡æœŸæ—¶é—´ |
| verification_code | String(10) | | éªŒè¯ç  |
| verification_code_expires | DateTime | | éªŒè¯ç è¿‡æœŸæ—¶é—´ |
| created_at | DateTime | NOT NULL, DEFAULT=now() | åˆ›å»ºæ—¶é—´ |
| updated_at | DateTime | NOT NULL, DEFAULT=now(), ONUPDATE=now() | æ›´æ–°æ—¶é—´ |

**å…³ç³»**ï¼š
- `documents` - ä¸€å¯¹å¤šå…³ç³»ï¼Œä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªæ–‡æ¡£
- `operation_logs` - ä¸€å¯¹å¤šå…³ç³»ï¼Œä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªæ“ä½œæ—¥å¿—

**çº¦æŸ**ï¼š
- `username`ã€`email`ã€`phone` åˆ†åˆ«æœ‰å”¯ä¸€çº¦æŸå’Œç´¢å¼•
- é‚®ç®±å’Œæ‰‹æœºå·è‡³å°‘æä¾›ä¸€ä¸ªï¼ˆåº”ç”¨å±‚éªŒè¯ï¼‰

#### 2.2.2 æ–‡æ¡£è¡¨ (documents)

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, AUTO_INCREMENT | æ–‡æ¡£ID |
| owner_id | Integer | FOREIGN KEY(users.id), NOT NULL | æ–‡æ¡£æ‰€æœ‰è€…ID |
| title | String(200) | INDEX, NOT NULL | æ–‡æ¡£æ ‡é¢˜ |
| content | Text | NOT NULL, DEFAULT="" | æ–‡æ¡£å†…å®¹ |
| status | String(50) | DEFAULT="active" | æ–‡æ¡£çŠ¶æ€ï¼šactive/archived |
| created_at | DateTime | NOT NULL, DEFAULT=now() | åˆ›å»ºæ—¶é—´ |
| updated_at | DateTime | NOT NULL, DEFAULT=now(), ONUPDATE=now() | æ›´æ–°æ—¶é—´ |

**å…³ç³»**ï¼š
- `owner` - å¤šå¯¹ä¸€å…³ç³»ï¼Œæ–‡æ¡£å±äºä¸€ä¸ªç”¨æˆ·
- `versions` - ä¸€å¯¹å¤šå…³ç³»ï¼Œä¸€ä¸ªæ–‡æ¡£å¯ä»¥æœ‰å¤šä¸ªç‰ˆæœ¬

#### 2.2.3 æ–‡æ¡£ç‰ˆæœ¬è¡¨ (document_versions)

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, AUTO_INCREMENT | ç‰ˆæœ¬ID |
| document_id | Integer | FOREIGN KEY(documents.id), NOT NULL | æ–‡æ¡£ID |
| user_id | Integer | FOREIGN KEY(users.id), NOT NULL | åˆ›å»ºç‰ˆæœ¬çš„ç”¨æˆ·ID |
| version_number | Integer | NOT NULL | ç‰ˆæœ¬å· |
| content_snapshot | Text | NOT NULL | å†…å®¹å¿«ç…§ |
| summary | String(500) | | å˜æ›´æ‘˜è¦ |
| created_at | DateTime | NOT NULL, DEFAULT=now() | åˆ›å»ºæ—¶é—´ |

**å…³ç³»**ï¼š
- `document` - å¤šå¯¹ä¸€å…³ç³»ï¼Œç‰ˆæœ¬å±äºä¸€ä¸ªæ–‡æ¡£

#### 2.2.4 æ“ä½œæ—¥å¿—è¡¨ (operation_logs)

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, AUTO_INCREMENT | æ—¥å¿—ID |
| user_id | Integer | FOREIGN KEY(users.id), NOT NULL | æ“ä½œç”¨æˆ·ID |
| action | String(100) | NOT NULL | æ“ä½œç±»å‹ï¼šlogin, logout, create_document, update_documentç­‰ |
| resource_type | String(50) | | èµ„æºç±»å‹ï¼šdocument, userç­‰ |
| resource_id | Integer | | èµ„æºID |
| description | Text | | æ“ä½œæè¿° |
| ip_address | String(50) | | IPåœ°å€ |
| user_agent | String(500) | | ç”¨æˆ·ä»£ç† |
| created_at | DateTime | NOT NULL, DEFAULT=now() | åˆ›å»ºæ—¶é—´ |

**å…³ç³»**ï¼š
- `user` - å¤šå¯¹ä¸€å…³ç³»ï¼Œæ—¥å¿—å±äºä¸€ä¸ªç”¨æˆ·

#### 2.2.5 æƒé™è¡¨ (permissions)

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, AUTO_INCREMENT | æƒé™ID |
| name | String(100) | UNIQUE, NOT NULL | æƒé™åç§°ï¼šread_document, write_documentç­‰ |
| description | Text | | æƒé™æè¿° |
| resource_type | String(50) | | èµ„æºç±»å‹ï¼šdocument, user, system |
| created_at | DateTime | NOT NULL, DEFAULT=now() | åˆ›å»ºæ—¶é—´ |

**çº¦æŸ**ï¼š
- `name` æœ‰å”¯ä¸€çº¦æŸ

#### 2.2.6 è§’è‰²æƒé™å…³è”è¡¨ (role_permissions)

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, AUTO_INCREMENT | å…³è”ID |
| role | String(20) | NOT NULL | è§’è‰²ï¼šadmin, editor, viewer |
| permission_id | Integer | FOREIGN KEY(permissions.id), NOT NULL | æƒé™ID |
| created_at | DateTime | NOT NULL, DEFAULT=now() | åˆ›å»ºæ—¶é—´ |

**ç”¨é€”**ï¼šå»ºç«‹è§’è‰²ä¸æƒé™çš„å¤šå¯¹å¤šå…³ç³»

#### 2.2.7 è®¿é—®æ§åˆ¶åˆ—è¡¨ (acls)

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| id | Integer | PRIMARY KEY, AUTO_INCREMENT | ACL ID |
| resource_type | String(50) | NOT NULL | èµ„æºç±»å‹ï¼šdocumentç­‰ |
| resource_id | Integer | NOT NULL | èµ„æºID |
| user_id | Integer | FOREIGN KEY(users.id) | ç”¨æˆ·IDï¼ˆä¸ºç©ºåˆ™å¯¹æ‰€æœ‰ç”¨æˆ·ï¼‰ |
| role | String(20) | | è§’è‰²ï¼ˆä¸ºç©ºåˆ™å¯¹æ‰€æœ‰è§’è‰²ï¼‰ |
| permission | String(100) | NOT NULL | æƒé™ï¼šread, write, deleteç­‰ |
| granted | Boolean | DEFAULT=True | æ˜¯å¦æˆäºˆæƒé™ |
| created_at | DateTime | NOT NULL, DEFAULT=now() | åˆ›å»ºæ—¶é—´ |
| updated_at | DateTime | NOT NULL, DEFAULT=now(), ONUPDATE=now() | æ›´æ–°æ—¶é—´ |

**ç”¨é€”**ï¼šç»†ç²’åº¦çš„èµ„æºçº§æƒé™æ§åˆ¶

### 2.3 å¤–é”®å…³ç³»

- documents.owner_id â†’ users.id
- document_versions.document_id â†’ documents.id
- document_versions.user_id â†’ users.id
- operation_logs.user_id â†’ users.id
- role_permissions.permission_id â†’ permissions.id
- acls.user_id â†’ users.id

### 2.4 æ ¸å¿ƒæ•°æ®æ¨¡å‹

æ‰€æœ‰æ¨¡å‹å®šä¹‰åœ¨ `models/__init__.py` æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨ SQLAlchemy ORMã€‚

---

## 3. å¯¹å¤– HTTP API / æ¥å£è¯´æ˜

æ‰€æœ‰ API æ¥å£å‰ç¼€ä¸º `/api/v1`ï¼Œå®šä¹‰åœ¨ `app/main.py` ä¸­æ³¨å†Œè·¯ç”±ã€‚

### 3.1 è®¤è¯ç›¸å…³æ¥å£

**è·¯ç”±æ–‡ä»¶**ï¼š`api/routers/auth.py`

#### POST `/api/v1/auth/register`

**åŠŸèƒ½**ï¼šç”¨æˆ·æ³¨å†Œ

**è¯·æ±‚ä½“**ï¼ˆJSONï¼‰ï¼š
```json
{
  "username": "string",      // å¿…å¡«ï¼Œ3-20ä¸ªå­—ç¬¦ï¼Œå­—æ¯æ•°å­—ä¸‹åˆ’çº¿
  "email": "string",          // å¯é€‰ï¼Œé‚®ç®±æ ¼å¼
  "phone": "string",          // å¯é€‰ï¼Œæ‰‹æœºå·æ ¼å¼
  "password": "string",       // å¿…å¡«ï¼Œè‡³å°‘6ä¸ªå­—ç¬¦
  "is_active": true,          // å¯é€‰ï¼Œé»˜è®¤true
  "role": "viewer"            // å¯é€‰ï¼Œé»˜è®¤viewer
}
```

**å“åº”**ï¼ˆ201 Createdï¼‰ï¼š
```json
{
  "id": 1,
  "username": "string",
  "email": "string",
  "phone": "string",
  "is_active": true,
  "role": "viewer",
  "created_at": "2024-01-01T00:00:00"
}
```

**éªŒè¯è§„åˆ™**ï¼š
- é‚®ç®±æˆ–æ‰‹æœºå·è‡³å°‘æä¾›ä¸€ä¸ª
- ç”¨æˆ·åã€é‚®ç®±ã€æ‰‹æœºå·ä¸èƒ½é‡å¤
- å¯†ç é•¿åº¦è‡³å°‘6ä¸ªå­—ç¬¦

**è®¤è¯è¦æ±‚**ï¼šæ— éœ€è®¤è¯

---

#### POST `/api/v1/auth/token`

**åŠŸèƒ½**ï¼šç”¨æˆ·ç™»å½•ï¼ˆOAuth2 å…¼å®¹ï¼Œè¡¨å•æ ¼å¼ï¼‰

**è¯·æ±‚æ ¼å¼**ï¼š`application/x-www-form-urlencoded`

**è¯·æ±‚å‚æ•°**ï¼š
- `username`: ç”¨æˆ·åï¼ˆä¹Ÿå¯ä»¥æ˜¯é‚®ç®±æˆ–æ‰‹æœºå·ï¼‰
- `password`: å¯†ç 

**å“åº”**ï¼ˆ200 OKï¼‰ï¼š
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}
```

**è®¤è¯è¦æ±‚**ï¼šæ— éœ€è®¤è¯

**è¯´æ˜**ï¼šæ”¯æŒé€šè¿‡ç”¨æˆ·åã€é‚®ç®±æˆ–æ‰‹æœºå·ç™»å½•

---

#### GET `/api/v1/auth/me`

**åŠŸèƒ½**ï¼šè·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯

**å“åº”**ï¼ˆ200 OKï¼‰ï¼š
```json
{
  "id": 1,
  "username": "string",
  "email": "string",
  "phone": "string",
  "is_active": true,
  "role": "viewer",
  "full_name": "string",
  "bio": "string",
  "avatar_url": "string",
  "created_at": "2024-01-01T00:00:00",
  "updated_at": "2024-01-01T00:00:00"
}
```

**è®¤è¯è¦æ±‚**ï¼šéœ€è¦ Bearer Tokenï¼ˆJWTï¼‰

---

### 3.2 ç”¨æˆ·ç®¡ç†æ¥å£

**è·¯ç”±æ–‡ä»¶**ï¼š`api/routers/users.py`

#### GET `/api/v1/users/{user_id}`

**åŠŸèƒ½**ï¼šè·å–æŒ‡å®šç”¨æˆ·ä¿¡æ¯

**è·¯å¾„å‚æ•°**ï¼š
- `user_id` (int) - ç”¨æˆ·ID

**å“åº”**ï¼ˆ200 OKï¼‰ï¼šUser å¯¹è±¡

**è®¤è¯è¦æ±‚**ï¼šéœ€è¦ Bearer Token

**æƒé™è¦æ±‚**ï¼šæ— ç‰¹æ®Šæƒé™è¦æ±‚ï¼ˆä¼šè®°å½•æ“ä½œæ—¥å¿—ï¼‰

---

#### PUT `/api/v1/users/{user_id}`

**åŠŸèƒ½**ï¼šæ›´æ–°ç”¨æˆ·ä¿¡æ¯

**è·¯å¾„å‚æ•°**ï¼š
- `user_id` (int) - ç”¨æˆ·ID

**è¯·æ±‚ä½“**ï¼ˆJSONï¼‰ï¼š
```json
{
  "username": "string",        // å¯é€‰
  "email": "string",           // å¯é€‰
  "phone": "string",           // å¯é€‰
  "is_active": true,           // å¯é€‰
  "role": "string",            // å¯é€‰
  "full_name": "string",       // å¯é€‰
  "bio": "string",             // å¯é€‰
  "address": "string",         // å¯é€‰
  "phone_secondary": "string", // å¯é€‰
  "avatar_url": "string"       // å¯é€‰
}
```

**å“åº”**ï¼ˆ200 OKï¼‰ï¼šæ›´æ–°åçš„ User å¯¹è±¡

**è®¤è¯è¦æ±‚**ï¼šéœ€è¦ Bearer Token

**æƒé™è¦æ±‚**ï¼šåªèƒ½æ›´æ–°è‡ªå·±çš„ä¿¡æ¯ï¼Œæˆ–éœ€è¦ admin è§’è‰²

---

#### DELETE `/api/v1/users/{user_id}`

**åŠŸèƒ½**ï¼šåˆ é™¤ç”¨æˆ·

**è·¯å¾„å‚æ•°**ï¼š
- `user_id` (int) - ç”¨æˆ·ID

**å“åº”**ï¼ˆ200 OKï¼‰ï¼š
```json
{
  "message": "User deleted successfully"
}
```

**è®¤è¯è¦æ±‚**ï¼šéœ€è¦ Bearer Token

**æƒé™è¦æ±‚**ï¼šä»…ç®¡ç†å‘˜ï¼ˆadmin è§’è‰²ï¼‰

---

### 3.3 æ–‡æ¡£ç®¡ç†æ¥å£

**è·¯ç”±æ–‡ä»¶**ï¼š`api/routers/documents.py`

#### GET `/api/v1/documents`

**åŠŸèƒ½**ï¼šè·å–å½“å‰ç”¨æˆ·çš„æ–‡æ¡£åˆ—è¡¨

**æŸ¥è¯¢å‚æ•°**ï¼š
- `skip` (int, é»˜è®¤0) - è·³è¿‡è®°å½•æ•°
- `limit` (int, é»˜è®¤100) - è¿”å›è®°å½•æ•°

**å“åº”**ï¼ˆ200 OKï¼‰ï¼š
```json
[
  {
    "id": 1,
    "owner_id": 1,
    "title": "string",
    "content": "string",
    "status": "active",
    "created_at": "2024-01-01T00:00:00",
    "updated_at": "2024-01-01T00:00:00"
  }
]
```

**è®¤è¯è¦æ±‚**ï¼šéœ€è¦ Bearer Token

**æƒé™è¦æ±‚**ï¼šåªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ–‡æ¡£

---

#### POST `/api/v1/documents`

**åŠŸèƒ½**ï¼šåˆ›å»ºæ–‡æ¡£

**è¯·æ±‚ä½“**ï¼ˆJSONï¼‰ï¼š
```json
{
  "title": "string",           // å¿…å¡«
  "content": "string",         // å¯é€‰ï¼Œé»˜è®¤ç©ºå­—ç¬¦ä¸²
  "status": "active"           // å¯é€‰ï¼Œé»˜è®¤active
}
```

**å“åº”**ï¼ˆ201 Createdï¼‰ï¼šDocument å¯¹è±¡

**è®¤è¯è¦æ±‚**ï¼šéœ€è¦ Bearer Token

---

#### GET `/api/v1/documents/{document_id}`

**åŠŸèƒ½**ï¼šè·å–æ–‡æ¡£è¯¦æƒ…

**è·¯å¾„å‚æ•°**ï¼š
- `document_id` (int) - æ–‡æ¡£ID

**å“åº”**ï¼ˆ200 OKï¼‰ï¼šDocument å¯¹è±¡

**è®¤è¯è¦æ±‚**ï¼šéœ€è¦ Bearer Token

**æƒé™è¦æ±‚**ï¼šåªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ–‡æ¡£

---

#### PUT `/api/v1/documents/{document_id}`

**åŠŸèƒ½**ï¼šæ›´æ–°æ–‡æ¡£

**è·¯å¾„å‚æ•°**ï¼š
- `document_id` (int) - æ–‡æ¡£ID

**è¯·æ±‚ä½“**ï¼ˆJSONï¼‰ï¼š
```json
{
  "title": "string",           // å¯é€‰
  "content": "string",          // å¯é€‰
  "status": "string"           // å¯é€‰
}
```

**å“åº”**ï¼ˆ200 OKï¼‰ï¼šæ›´æ–°åçš„ Document å¯¹è±¡

**è®¤è¯è¦æ±‚**ï¼šéœ€è¦ Bearer Token

**æƒé™è¦æ±‚**ï¼šåªèƒ½æ›´æ–°è‡ªå·±çš„æ–‡æ¡£

---

#### DELETE `/api/v1/documents/{document_id}`

**åŠŸèƒ½**ï¼šåˆ é™¤æ–‡æ¡£

**è·¯å¾„å‚æ•°**ï¼š
- `document_id` (int) - æ–‡æ¡£ID

**å“åº”**ï¼ˆ204 No Contentï¼‰

**è®¤è¯è¦æ±‚**ï¼šéœ€è¦ Bearer Token

**æƒé™è¦æ±‚**ï¼šåªèƒ½åˆ é™¤è‡ªå·±çš„æ–‡æ¡£

---

#### GET `/api/v1/documents/{document_id}/versions`

**åŠŸèƒ½**ï¼šè·å–æ–‡æ¡£ç‰ˆæœ¬åˆ—è¡¨

**è·¯å¾„å‚æ•°**ï¼š
- `document_id` (int) - æ–‡æ¡£ID

**å“åº”**ï¼ˆ200 OKï¼‰ï¼š
```json
[
  {
    "id": 1,
    "version_number": 1,
    "user_id": 1,
    "summary": "string",
    "created_at": "2024-01-01T00:00:00"
  }
]
```

**è®¤è¯è¦æ±‚**ï¼šéœ€è¦ Bearer Token

**æƒé™è¦æ±‚**ï¼šåªèƒ½æŸ¥çœ‹è‡ªå·±æ–‡æ¡£çš„ç‰ˆæœ¬

---

#### POST `/api/v1/documents/{document_id}/versions`

**åŠŸèƒ½**ï¼šåˆ›å»ºæ–‡æ¡£ç‰ˆæœ¬

**è·¯å¾„å‚æ•°**ï¼š
- `document_id` (int) - æ–‡æ¡£ID

**æŸ¥è¯¢å‚æ•°**ï¼š
- `content` (string) - å†…å®¹å¿«ç…§ï¼Œå¿…å¡«
- `summary` (string) - å˜æ›´æ‘˜è¦ï¼Œå¯é€‰ï¼Œé»˜è®¤ç©ºå­—ç¬¦ä¸²

**å“åº”**ï¼ˆ201 Createdï¼‰ï¼š
```json
{
  "id": 1,
  "version_number": 1,
  "summary": "string",
  "created_at": "2024-01-01T00:00:00"
}
```

**è®¤è¯è¦æ±‚**ï¼šéœ€è¦ Bearer Token

**æƒé™è¦æ±‚**ï¼šåªèƒ½ä¸ºè‡ªå·±çš„æ–‡æ¡£åˆ›å»ºç‰ˆæœ¬

---

### 3.4 WebSocket æ¥å£

**è·¯ç”±æ–‡ä»¶**ï¼š`api/routers/ws.py`

#### WebSocket `/api/v1/ws/documents/{document_id}`

**åŠŸèƒ½**ï¼šå®æ—¶åä½œç¼–è¾‘è¿æ¥

**è¿æ¥åœ°å€**ï¼š`ws://<host>/api/v1/ws/documents/{document_id}`

**è·¯å¾„å‚æ•°**ï¼š
- `document_id` (int) - æ–‡æ¡£ID

**æ”¯æŒçš„æ¶ˆæ¯ç±»å‹**ï¼š

1. **å†…å®¹æ›´æ–°æ¶ˆæ¯**ï¼ˆå®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼‰ï¼š
```json
{
  "type": "content",
  "content": "æ–‡æ¡£å†…å®¹"
}
```

2. **å…‰æ ‡ä½ç½®æ¶ˆæ¯**ï¼ˆå®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼‰ï¼š
```json
{
  "type": "cursor",
  "cursor": {
    "position": 10
  }
}
```

**æœåŠ¡å™¨å‘é€çš„æ¶ˆæ¯ç±»å‹**ï¼š

1. **åˆå§‹åŒ–æ¶ˆæ¯**ï¼ˆè¿æ¥å»ºç«‹æ—¶ï¼‰ï¼š
```json
{
  "type": "init",
  "content": "æ–‡æ¡£åˆå§‹å†…å®¹"
}
```

2. **ç”¨æˆ·åŠ å…¥æ¶ˆæ¯**ï¼ˆå¹¿æ’­ç»™å…¶ä»–ç”¨æˆ·ï¼‰ï¼š
```json
{
  "type": "user_joined",
  "user_id": 1,
  "username": "string",
  "color": "#FF5733"
}
```

3. **å†…å®¹æ›´æ–°å¹¿æ’­**ï¼ˆå¹¿æ’­ç»™å…¶ä»–ç”¨æˆ·ï¼‰ï¼š
```json
{
  "type": "content",
  "content": "æ›´æ–°åçš„æ–‡æ¡£å†…å®¹",
  "user_id": 1
}
```

4. **å…‰æ ‡ä½ç½®å¹¿æ’­**ï¼ˆå¹¿æ’­ç»™å…¶ä»–ç”¨æˆ·ï¼‰ï¼š
```json
{
  "type": "cursor",
  "user_id": 1,
  "username": "string",
  "cursor": {
    "position": 10
  },
  "color": "#FF5733"
}
```

**è®¤è¯è¦æ±‚**ï¼šæ”¯æŒé€šè¿‡æŸ¥è¯¢å‚æ•°ä¼ é€’ Tokenï¼ˆå¯é€‰ï¼‰ï¼Œæ ¼å¼ï¼š`?token=<jwt_token>`

**è¯´æ˜**ï¼š
- è¿æ¥å»ºç«‹åï¼ŒæœåŠ¡å™¨ä¼šå‘é€æ–‡æ¡£åˆå§‹å†…å®¹
- å†…å®¹æ›´æ–°ä¼šå®æ—¶ä¿å­˜åˆ°æ•°æ®åº“å¹¶å¹¿æ’­ç»™æˆ¿é—´å†…å…¶ä»–ç”¨æˆ·
- å…‰æ ‡ä½ç½®ä¼šå®æ—¶å¹¿æ’­ç»™å…¶ä»–ç”¨æˆ·ï¼Œç”¨äºæ˜¾ç¤ºå…¶ä»–ç”¨æˆ·çš„å…‰æ ‡

### 3.5 WebSocket æœåŠ¡å®ç°

**æœåŠ¡æ–‡ä»¶**ï¼š`services/websocket_service.py`

**å®ç°ç±»**ï¼š`ConnectionManager`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- ç®¡ç†æ¯ä¸ªæ–‡æ¡£æˆ¿é—´çš„ WebSocket è¿æ¥
- å¹¿æ’­æ¶ˆæ¯ç»™æˆ¿é—´å†…å…¶ä»–ç”¨æˆ·
- ç”¨æˆ·åŠ å…¥/ç¦»å¼€é€šçŸ¥
- ç”¨æˆ·é¢œè‰²åˆ†é…ï¼ˆç”¨äºæ˜¾ç¤ºä¸åŒç”¨æˆ·çš„å…‰æ ‡å’Œæ ‡è¯†ï¼‰

**æ•°æ®ç»“æ„**ï¼š
```python
active_connections: Dict[int, list]  # document_id -> list of connections with user info
```

**è¿æ¥ä¿¡æ¯**ï¼š
- æ¯ä¸ªè¿æ¥åŒ…å« WebSocket å¯¹è±¡å’Œç”¨æˆ·ä¿¡æ¯

**ç”¨æˆ·é¢œè‰²åˆ†é…**ï¼š
- ä¸ºæ¯ä¸ªç”¨æˆ·åˆ†é…å›ºå®šé¢œè‰²ï¼Œç¡®ä¿ç”¨æˆ·åœ¨åä½œç¼–è¾‘æ—¶æœ‰ç‹¬ç‰¹æ ‡è¯†
- é¢œè‰²åˆ—è¡¨ï¼š["#FF5733", "#33FF57", "#3357FF", "#F333FF", "#FF33A1", "#33FFF0", "#FFBD33", "#8D33FF"]

---

## 4. å†…éƒ¨æ¨¡å—ä¸ä¾èµ–å…³ç³»

### 4.1 æ¶æ„åˆ†å±‚

é¡¹ç›®é‡‡ç”¨**åˆ†å±‚æ¶æ„**ï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹å±‚æ¬¡ï¼š

1. **Router å±‚**ï¼ˆ`api/routers/`ï¼‰
   - èŒè´£ï¼šæ¥æ”¶ HTTP è¯·æ±‚ï¼Œå‚æ•°éªŒè¯ï¼Œè°ƒç”¨ Service å±‚ï¼Œè¿”å›å“åº”
   - æ–‡ä»¶ï¼š`auth.py`, `users.py`, `documents.py`, `ws.py`

2. **Service å±‚**ï¼ˆ`services/`ï¼‰
   - èŒè´£ï¼šå°è£…ä¸šåŠ¡é€»è¾‘ï¼Œæ•°æ®éªŒè¯ï¼Œäº‹åŠ¡æ§åˆ¶ï¼ˆä¸ç›´æ¥ commitï¼Œç”± Router å±‚æ§åˆ¶ï¼‰
   - æ–‡ä»¶ï¼š`user_service.py`, `document_service.py`, `websocket_service.py`

3. **Model å±‚**ï¼ˆ`models/`ï¼‰
   - èŒè´£ï¼šå®šä¹‰æ•°æ®åº“æ¨¡å‹å’Œå…³ç³»
   - æ–‡ä»¶ï¼š`models/__init__.py`

4. **Schema å±‚**ï¼ˆ`schemas/`ï¼‰
   - èŒè´£ï¼šå®šä¹‰è¯·æ±‚/å“åº”çš„æ•°æ®ç»“æ„ï¼Œæ•°æ®éªŒè¯
   - æ–‡ä»¶ï¼š`schemas/__init__.py`

5. **Core å±‚**ï¼ˆ`core/`ï¼‰
   - èŒè´£ï¼šåº”ç”¨é…ç½®ã€å®‰å…¨è®¤è¯ã€å¯†ç åŠ å¯†
   - æ–‡ä»¶ï¼š`config.py`, `security.py`

6. **DB å±‚**ï¼ˆ`db/`ï¼‰
   - èŒè´£ï¼šæ•°æ®åº“è¿æ¥ã€ä¼šè¯ç®¡ç†ã€åˆå§‹åŒ–è„šæœ¬
   - æ–‡ä»¶ï¼š`session.py`, `init_db.py`, `init_permissions.py`

### 4.2 è°ƒç”¨å…³ç³»ç¤ºä¾‹

**ç”¨æˆ·æ³¨å†Œæµç¨‹**ï¼š
```
POST /api/v1/auth/register
  â†’ api/routers/auth.py:register()
    â†’ services/user_service.py:create_user()
      â†’ models/__init__.py:User (ORM æ¨¡å‹)
        â†’ db/session.py:get_db() (æ•°æ®åº“ä¼šè¯)
          â†’ OpenGauss æ•°æ®åº“
```

**ç”¨æˆ·ç™»å½•æµç¨‹**ï¼š
```
POST /api/v1/auth/token
  â†’ api/routers/auth.py:login()
    â†’ core/security.py:verify_password()
    â†’ core/security.py:create_access_token()
      â†’ python-jose (JWT ç”Ÿæˆ)
```

**è·å–æ–‡æ¡£åˆ—è¡¨æµç¨‹**ï¼š
```
GET /api/v1/documents
  â†’ api/routers/documents.py:get_documents_endpoint()
    â†’ core/security.py:get_current_user() (è®¤è¯)
    â†’ services/document_service.py:get_documents()
      â†’ models/__init__.py:Document (ORM æŸ¥è¯¢)
        â†’ db/session.py:get_db()
          â†’ OpenGauss æ•°æ®åº“
```

**WebSocket åä½œç¼–è¾‘æµç¨‹**ï¼š
```
WebSocket /api/v1/ws/documents/{document_id}
  â†’ api/routers/ws.py:websocket_document_endpoint()
    â†’ services/websocket_service.py:ConnectionManager
      â†’ å¹¿æ’­æ¶ˆæ¯ç»™æˆ¿é—´å†…å…¶ä»–ç”¨æˆ·
      â†’ æ›´æ–° models/__init__.py:Document.content
        â†’ db/session.py (æ•°æ®åº“æ›´æ–°)
```

### 4.3 æ•°æ®æµå‘

1. **è¯·æ±‚å¤„ç†**ï¼šHTTP Request â†’ Router â†’ Service â†’ Model â†’ Database
2. **å“åº”è¿”å›**ï¼šDatabase â†’ Model â†’ Service â†’ Router â†’ HTTP Response
3. **WebSocket**ï¼šWebSocket Message â†’ Router â†’ Service â†’ Broadcast â†’ å…¶ä»–å®¢æˆ·ç«¯

### 4.4 æ³¨æ„äº‹é¡¹

- **äº‹åŠ¡æ§åˆ¶**ï¼šService å±‚å‡½æ•°é»˜è®¤ä¸æäº¤äº‹åŠ¡ï¼ˆ`commit=False`ï¼‰ï¼Œç”± Router å±‚ç»Ÿä¸€æ§åˆ¶æäº¤å’Œå›æ»š
- **è®¤è¯ä¾èµ–**ï¼šå¤§éƒ¨åˆ†æ¥å£ä¾èµ– `core/security.py:get_current_user()` è¿›è¡Œ JWT è®¤è¯
- **æ—¥å¿—è®°å½•**ï¼šå…³é”®æ“ä½œï¼ˆå¦‚ç”¨æˆ·æŸ¥çœ‹ã€æ›´æ–°ã€åˆ é™¤ï¼‰ä¼šè®°å½•åˆ° `operation_logs` è¡¨

---

## 5. å¤–éƒ¨æœåŠ¡ä¸ç¬¬ä¸‰æ–¹ API

### 5.1 å½“å‰æœªé›†æˆçš„å¤–éƒ¨æœåŠ¡

æ ¹æ®ä»£ç åˆ†æï¼Œé¡¹ç›®å½“å‰**æœªé›†æˆ**ä»¥ä¸‹å¤–éƒ¨æœåŠ¡ï¼ˆä½†é¢„ç•™äº†é…ç½®é¡¹ï¼‰ï¼š

**é‚®ä»¶æœåŠ¡**ï¼ˆç”¨äºéªŒè¯ç å‘é€ï¼‰ï¼š
- é…ç½®é¡¹ï¼š`EMAIL_ENABLED`ï¼ˆ`core/config.py`ï¼Œå½“å‰æœªä½¿ç”¨ï¼‰
- ç”¨é€”ï¼šå‘é€å¯†ç é‡ç½®éªŒè¯ç 
- çŠ¶æ€ï¼šTODO - éœ€è¦é›†æˆå®é™…çš„é‚®ä»¶æœåŠ¡ï¼ˆå¦‚ SMTPã€SendGridã€é˜¿é‡Œäº‘é‚®ä»¶æ¨é€ç­‰ï¼‰

**çŸ­ä¿¡æœåŠ¡**ï¼ˆç”¨äºéªŒè¯ç å‘é€ï¼‰ï¼š
- é…ç½®é¡¹ï¼š`SMS_ENABLED`ï¼ˆ`core/config.py`ï¼Œå½“å‰æœªä½¿ç”¨ï¼‰
- ç”¨é€”ï¼šå‘é€å¯†ç é‡ç½®éªŒè¯ç 
- çŠ¶æ€ï¼šTODO - éœ€è¦é›†æˆå®é™…çš„çŸ­ä¿¡æœåŠ¡ï¼ˆå¦‚é˜¿é‡Œäº‘çŸ­ä¿¡ã€è…¾è®¯äº‘çŸ­ä¿¡ç­‰ï¼‰

**æ–‡ä»¶å­˜å‚¨æœåŠ¡**ï¼ˆç”¨äºå¤´åƒä¸Šä¼ ï¼‰ï¼š
- å½“å‰å®ç°ï¼šæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨ï¼ˆ`uploads/` ç›®å½•ï¼‰
- é…ç½®é¡¹ï¼š`UPLOAD_DIR`ï¼ˆåœ¨ `app/main.py` ä¸­é…ç½®ä¸º "uploads"ï¼‰
- é™æ€æ–‡ä»¶è®¿é—®ï¼š`/static/uploads/` è·¯å¾„æ˜ å°„åˆ°ä¸Šä¼ ç›®å½•
- çŠ¶æ€ï¼šåŸºç¡€åŠŸèƒ½å·²å®ç°ï¼Œä½†å¤´åƒä¸Šä¼ æ¥å£æœªåœ¨å½“å‰è·¯ç”±ä¸­æš´éœ²
- å»ºè®®ï¼šç”Ÿäº§ç¯å¢ƒè¿ç§»åˆ°å¯¹è±¡å­˜å‚¨æœåŠ¡ï¼ˆå¦‚é˜¿é‡Œäº‘ OSSã€è…¾è®¯äº‘ COSã€AWS S3 ç­‰ï¼‰

### 5.2 ç¬¬ä¸‰æ–¹åº“ä¾èµ–

**è®¤è¯ä¸å®‰å…¨**ï¼š
- `python-jose` - JWT Token ç”Ÿæˆå’ŒéªŒè¯
- `passlib` - å¯†ç å“ˆå¸Œï¼ˆbcryptï¼‰

**æ•°æ®åº“**ï¼š
- `psycopg2-binary` - PostgreSQL/OpenGauss æ•°æ®åº“é©±åŠ¨

**Web æ¡†æ¶**ï¼š
- `fastapi` - Web æ¡†æ¶
- `uvicorn` - ASGI æœåŠ¡å™¨
- `websockets` - WebSocket æ”¯æŒ

**æ•°æ®éªŒè¯**ï¼š
- `pydantic` / `pydantic-settings` - æ•°æ®éªŒè¯å’Œé…ç½®ç®¡ç†
- `email-validator` - é‚®ç®±æ ¼å¼éªŒè¯

---

## 6. é…ç½®ä¸è¿è¡Œç¯å¢ƒ

### 6.1 é…ç½®æ–‡ä»¶

**ä¸»é…ç½®æ–‡ä»¶**ï¼š`core/config.py`

**é…ç½®é¡¹è¯´æ˜**ï¼š

```python
# é¡¹ç›®åŸºæœ¬ä¿¡æ¯
PROJECT_NAME = "Collaborative Editor API"
VERSION = "1.0.0"
API_V1_STR = "/api/v1"  # API ç‰ˆæœ¬å‰ç¼€

# æ•°æ®åº“é…ç½®ï¼ˆé€šè¿‡ç¯å¢ƒå˜é‡ DATABASE_URL è¦†ç›–ï¼‰
DATABASE_URL = "postgresql+psycopg2://ç”¨æˆ·å:å¯†ç @ä¸»æœº:ç«¯å£/æ•°æ®åº“å"

# JWT é…ç½®
SECRET_KEY = "your-secret-key-change-in-production"  # ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 30  # Token æœ‰æ•ˆæœŸï¼ˆåˆ†é’Ÿï¼‰

# CORS é…ç½®
BACKEND_CORS_ORIGINS = [
    "http://localhost",
    "http://127.0.0.1",
    "http://localhost:3000",
    "http://127.0.0.1:3000"
]

# æ–‡ä»¶ä¸Šä¼ é…ç½®ï¼ˆä»£ç ä¸­ä½¿ç”¨ï¼Œä½†æœªåœ¨é…ç½®ç±»ä¸­å®šä¹‰ï¼‰
UPLOAD_DIR = "uploads"  # ä¸Šä¼ æ–‡ä»¶ç›®å½•
MAX_UPLOAD_SIZE = 5242880  # 5MB
ALLOWED_IMAGE_TYPES = ["image/jpeg", "image/png", "image/gif", "image/webp"]
```

### 6.2 ç¯å¢ƒå˜é‡

é¡¹ç›®ä½¿ç”¨ `python-dotenv` æ”¯æŒ `.env` æ–‡ä»¶ï¼Œå¯é€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–é…ç½®ï¼š

- `DATABASE_URL` - æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²
- `SECRET_KEY` - JWT å¯†é’¥ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»è®¾ç½®ï¼‰
- `ACCESS_TOKEN_EXPIRE_MINUTES` - Token æœ‰æ•ˆæœŸ

### 6.3 æ•°æ®åº“è¿æ¥é…ç½®

**è¿æ¥é…ç½®ä½ç½®**ï¼š`db/session.py`

**è¿æ¥æ± å‚æ•°**ï¼š
- `pool_size`: 10ï¼ˆè¿æ¥æ± å¤§å°ï¼‰
- `max_overflow`: 20ï¼ˆæœ€å¤§æº¢å‡ºè¿æ¥æ•°ï¼‰
- `pool_pre_ping`: Trueï¼ˆè¿æ¥å‰éªŒè¯æœ‰æ•ˆæ€§ï¼‰
- `echo`: Trueï¼ˆå¼€å‘ç¯å¢ƒæ‰“å° SQLï¼Œç”Ÿäº§ç¯å¢ƒåº”è®¾ä¸º Falseï¼‰

### 6.4 è¿è¡Œç¯å¢ƒ

**å¼€å‘ç¯å¢ƒ**ï¼š
- æ•°æ®åº“ï¼šæœ¬åœ° OpenGauss æˆ– PostgreSQL
- ç«¯å£ï¼šé»˜è®¤ 8000ï¼ˆå¯é€šè¿‡ uvicorn å‚æ•°ä¿®æ”¹ï¼‰
- è°ƒè¯•ï¼šSQL æ—¥å¿—å¼€å¯ï¼ˆ`echo=True`ï¼‰

**ç”Ÿäº§ç¯å¢ƒæ³¨æ„äº‹é¡¹**ï¼š
- å¿…é¡»ä¿®æ”¹ `SECRET_KEY`
- è®¾ç½® `echo=False` å…³é—­ SQL æ—¥å¿—
- é…ç½®æ­£ç¡®çš„ `BACKEND_CORS_ORIGINS`
- ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†æ•æ„Ÿé…ç½®
- é…ç½®æ—¥å¿—ç³»ç»Ÿï¼ˆå½“å‰ä½¿ç”¨ Python loggingï¼‰

---

## 7. è®¤è¯ä¸æƒé™

### 7.1 è®¤è¯æ–¹å¼

**è®¤è¯ç±»å‹**ï¼šJWT Tokenï¼ˆBearer Tokenï¼‰

**è®¤è¯å®ç°ä½ç½®**ï¼š`core/security.py`

**è®¤è¯æµç¨‹**ï¼š
1. ç”¨æˆ·é€šè¿‡ `/api/v1/auth/token` ç™»å½•ï¼Œæä¾›ç”¨æˆ·åå’Œå¯†ç 
2. æœåŠ¡å™¨éªŒè¯å¯†ç åç”Ÿæˆ JWT Token
3. å®¢æˆ·ç«¯åœ¨åç»­è¯·æ±‚çš„ `Authorization` å¤´ä¸­æºå¸¦ Tokenï¼š`Bearer <token>`
4. æœåŠ¡å™¨é€šè¿‡ `get_current_user()` ä¾èµ–å‡½æ•°éªŒè¯ Token å¹¶è·å–ç”¨æˆ·ä¿¡æ¯

**Token ç»“æ„**ï¼š
- ç®—æ³•ï¼šHS256
- è½½è·ï¼š`{"sub": "username", "exp": <è¿‡æœŸæ—¶é—´>}`
- æœ‰æ•ˆæœŸï¼šé»˜è®¤ 30 åˆ†é’Ÿï¼ˆå¯é€šè¿‡é…ç½®ä¿®æ”¹ï¼‰

### 7.2 æƒé™æ¨¡å‹

**æƒé™ç±»å‹**ï¼šåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰+ è®¿é—®æ§åˆ¶åˆ—è¡¨ï¼ˆACLï¼‰

**è§’è‰²å®šä¹‰**ï¼š
- **admin**ï¼ˆç®¡ç†å‘˜ï¼‰ï¼šæ‹¥æœ‰æ‰€æœ‰æƒé™
- **editor**ï¼ˆç¼–è¾‘è€…ï¼‰ï¼šå¯ä»¥åˆ›å»ºã€è¯»å–ã€æ›´æ–°æ–‡æ¡£ï¼ŒæŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯
- **viewer**ï¼ˆæŸ¥çœ‹è€…ï¼‰ï¼šåªèƒ½è¯»å–æ–‡æ¡£å’ŒæŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯

**æƒé™æ£€æŸ¥ä¼˜å…ˆçº§**ï¼ˆ`services/permission_service.py:check_permission()`ï¼‰ï¼š
1. ç”¨æˆ·ç‰¹å®šçš„ ACLï¼ˆ`acls` è¡¨ä¸­ `user_id` ä¸ä¸ºç©ºï¼‰
2. è§’è‰²ç‰¹å®šçš„ ACLï¼ˆ`acls` è¡¨ä¸­ `role` ä¸ä¸ºç©ºï¼‰
3. è§’è‰²æƒé™ï¼ˆ`role_permissions` è¡¨ï¼‰
4. é»˜è®¤è§’è‰²æƒé™ï¼ˆä»£ç ä¸­ç¡¬ç¼–ç ï¼‰

**é»˜è®¤æƒé™åˆ†é…**ï¼ˆ`db/init_permissions.py`ï¼‰ï¼š

- **admin**ï¼šæ‰€æœ‰æƒé™
  - read_document, write_document, update_document, delete_document
  - read_user, update_user, delete_user
  - manage_permissions, view_logs

- **editor**ï¼š
  - read_document, write_document, update_document
  - read_user

- **viewer**ï¼š
  - read_document
  - read_user

**æƒé™æ£€æŸ¥ä½ç½®**ï¼š
- `core/security.py:get_current_user()` - åŸºç¡€è®¤è¯
- `api/routers/users.py` - ç”¨æˆ·æ“ä½œæƒé™æ£€æŸ¥ï¼ˆå¦‚åˆ é™¤ç”¨æˆ·éœ€è¦ adminï¼‰
- `api/routers/documents.py` - æ–‡æ¡£æ“ä½œæƒé™æ£€æŸ¥ï¼ˆåªèƒ½æ“ä½œè‡ªå·±çš„æ–‡æ¡£ï¼‰

### 7.3 è®¤è¯ä¸­é—´ä»¶

**OAuth2 æ–¹æ¡ˆ**ï¼š`core/security.py:oauth2_scheme`

**Token URL**ï¼š`/api/v1/auth/token`

**ä¾èµ–æ³¨å…¥**ï¼šä½¿ç”¨ FastAPI çš„ `Depends()` æœºåˆ¶ï¼Œåœ¨è·¯ç”±å‡½æ•°ä¸­é€šè¿‡ `current_user: UserSchema = Depends(get_current_user)` è·å–å½“å‰ç”¨æˆ·

---

## 8. å…¶ä»–é‡è¦æœºåˆ¶

### 8.1 æ“ä½œæ—¥å¿—ç³»ç»Ÿ

**å®ç°ä½ç½®**ï¼š`api/routers/users.py:log_operation()`

**è®°å½•å†…å®¹**ï¼š
- ç”¨æˆ·ID
- æ“ä½œç±»å‹ï¼ˆactionï¼‰
- èµ„æºç±»å‹å’ŒID
- æ“ä½œæè¿°
- IP åœ°å€å’Œ User-Agent

**è®°å½•çš„æ“ä½œ**ï¼š
- æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯
- æ›´æ–°ç”¨æˆ·ä¿¡æ¯
- åˆ é™¤ç”¨æˆ·
- ç™»å½•ï¼ˆåœ¨ `api/routers/auth.py` ä¸­è®°å½•ï¼‰

**å­˜å‚¨ä½ç½®**ï¼š`operation_logs` è¡¨

**æ³¨æ„äº‹é¡¹**ï¼šæ—¥å¿—è®°å½•å¤±è´¥ä¸ä¼šå½±å“ä¸»ä¸šåŠ¡æµç¨‹ï¼Œåªè®°å½•é”™è¯¯æ—¥å¿—

### 8.2 æ–‡ä»¶ä¸Šä¼ æœºåˆ¶

**å®ç°ä½ç½®**ï¼š`api/routers/users.py`ï¼ˆä»£ç ä¸­å·²å®ç°ï¼Œä½†å½“å‰è·¯ç”±æ–‡ä»¶ä¸­æœªçœ‹åˆ°ï¼‰

**æ”¯æŒåŠŸèƒ½**ï¼š
- å¤´åƒä¸Šä¼ 
- æ–‡ä»¶ç±»å‹éªŒè¯ï¼ˆJPEG, PNG, GIF, WebPï¼‰
- æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆé»˜è®¤ 5MBï¼‰
- æ–‡ä»¶å­˜å‚¨è·¯å¾„ï¼š`uploads/avatars/`
- è®¿é—®è·¯å¾„ï¼š`/static/uploads/avatars/{filename}`

**é…ç½®é¡¹**ï¼ˆä»£ç ä¸­ä½¿ç”¨ä½†æœªåœ¨é…ç½®ç±»ä¸­å®šä¹‰ï¼‰ï¼š
- `UPLOAD_DIR`: ä¸Šä¼ ç›®å½•
- `MAX_UPLOAD_SIZE`: æœ€å¤§æ–‡ä»¶å¤§å°
- `ALLOWED_IMAGE_TYPES`: å…è®¸çš„å›¾ç‰‡ç±»å‹

### 8.3 æ•°æ®åº“åˆå§‹åŒ–

**åˆå§‹åŒ–è„šæœ¬**ï¼š`db/init_db.py`

**åˆå§‹åŒ–å†…å®¹**ï¼š
1. åˆ›å»ºæ‰€æœ‰æ•°æ®è¡¨ï¼ˆé€šè¿‡ SQLAlchemy `create_all()`ï¼‰
2. åˆå§‹åŒ–é»˜è®¤æƒé™å’Œè§’è‰²æƒé™ï¼ˆè°ƒç”¨ `db/init_permissions.py:init_permissions()`ï¼‰

**è§¦å‘æ—¶æœº**ï¼šåº”ç”¨å¯åŠ¨æ—¶ï¼ˆ`app/main.py:on_startup()`ï¼‰

**é”™è¯¯å¤„ç†**ï¼š
- æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥ä¼šé˜»æ­¢åº”ç”¨å¯åŠ¨
- æƒé™åˆå§‹åŒ–å¤±è´¥ä¼šè®°å½•é”™è¯¯æ—¥å¿—ï¼Œä½†ä¸é˜»æ­¢åº”ç”¨å¯åŠ¨ï¼ˆTODOï¼šå¯èƒ½éœ€è¦è°ƒæ•´ï¼‰

### 8.4 WebSocket è¿æ¥ç®¡ç†

**å®ç°ä½ç½®**ï¼š`services/websocket_service.py:ConnectionManager`

**åŠŸèƒ½**ï¼š
- ç®¡ç†æ¯ä¸ªæ–‡æ¡£æˆ¿é—´çš„ WebSocket è¿æ¥
- å¹¿æ’­æ¶ˆæ¯ç»™æˆ¿é—´å†…å…¶ä»–ç”¨æˆ·
- ç”¨æˆ·åŠ å…¥/ç¦»å¼€é€šçŸ¥
- ç”¨æˆ·é¢œè‰²åˆ†é…ï¼ˆç”¨äºæ˜¾ç¤ºä¸åŒç”¨æˆ·çš„å…‰æ ‡ï¼‰

**æ•°æ®ç»“æ„**ï¼š
```python
active_connections: Dict[int, list]  # document_id -> list of connections with user info
```

**è¿æ¥ä¿¡æ¯**ï¼š
- æ¯ä¸ªè¿æ¥åŒ…å« WebSocket å¯¹è±¡å’Œå®Œæ•´çš„ç”¨æˆ·å¯¹è±¡
- ç”¨æˆ·é¢œè‰²å›ºå®šåˆ†é…ï¼šåŸºäºç”¨æˆ·IDå–æ¨¡ï¼Œç¡®ä¿åŒä¸€ç”¨æˆ·æ°¸è¿œåŒä¸€ç§é¢œè‰²
- é¢œè‰²åˆ—è¡¨ï¼š["#FF5733", "#33FF57", "#3357FF", "#F333FF", "#FF33A1", "#33FFF0", "#FFBD33", "#8D33FF"]

---

## 9. é¡¹ç›®å…¥å£ä¸å¯åŠ¨

### 9.1 åº”ç”¨å…¥å£

**ä¸»å…¥å£æ–‡ä»¶**ï¼š`app/main.py`

**åº”ç”¨å¯¹è±¡**ï¼š`app`ï¼ˆFastAPI å®ä¾‹ï¼‰

**å¯åŠ¨æ–¹å¼**ï¼š
```bash
# æ–¹å¼1ï¼šä½¿ç”¨ uvicorn
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# æ–¹å¼2ï¼šç›´æ¥è¿è¡Œï¼ˆå¦‚æœå­˜åœ¨æ ¹ç›®å½• main.pyï¼‰
python main.py
```

### 9.2 API æ–‡æ¡£

**Swagger UI**ï¼š`http://localhost:8000/api/docs`

**ReDoc**ï¼š`http://localhost:8000/api/redoc`

### 9.3 é™æ€æ–‡ä»¶æœåŠ¡

**é™æ€æ–‡ä»¶ç›®å½•**ï¼š`/static` â†’ `static/` ç›®å½•

**ä¸Šä¼ æ–‡ä»¶ç›®å½•**ï¼š`/static/uploads` â†’ `uploads/` ç›®å½•

**æ¨¡æ¿æ–‡ä»¶ç›®å½•**ï¼š`templates/` ç›®å½•

---

## 10. æ³¨æ„äº‹é¡¹ä¸å¾…å®Œå–„åŠŸèƒ½

### 10.1 å®‰å…¨ç›¸å…³

1. **éªŒè¯ç å‘é€**ï¼šå½“å‰éªŒè¯ç åœ¨å¼€å‘ç¯å¢ƒä¸­å¯èƒ½ç›´æ¥è¿”å›ï¼Œç”Ÿäº§ç¯å¢ƒéœ€è¦é›†æˆé‚®ä»¶/çŸ­ä¿¡æœåŠ¡
2. **WebSocket è®¤è¯**ï¼šå½“å‰ WebSocket è¿æ¥æœªå¼ºåˆ¶è¦æ±‚è®¤è¯ï¼Œå»ºè®®æ·»åŠ  Token éªŒè¯
3. **SECRET_KEY**ï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹é»˜è®¤å¯†é’¥
4. **CORS é…ç½®**ï¼šç”Ÿäº§ç¯å¢ƒéœ€è¦é…ç½®æ­£ç¡®çš„å…è®¸æ¥æº

### 10.2 åŠŸèƒ½å®Œå–„

1. **å¯†ç é‡ç½®æµç¨‹**ï¼šä»£ç ä¸­å·²å®ç°éªŒè¯ç å’Œé‡ç½®ä»¤ç‰Œæœºåˆ¶ï¼Œä½†é‚®ä»¶/çŸ­ä¿¡å‘é€åŠŸèƒ½å¾…é›†æˆ
2. **å¤´åƒä¸Šä¼ æ¥å£**ï¼šç”¨æˆ·æ¨¡å‹æ”¯æŒå¤´åƒURLï¼Œé™æ€æ–‡ä»¶æœåŠ¡å·²é…ç½®ï¼Œä½†ä¸Šä¼ æ¥å£æœªåœ¨å½“å‰è·¯ç”±ä¸­æš´éœ²
3. **æƒé™ç®¡ç† API**ï¼šæƒé™å’Œ ACL ç®¡ç†åŠŸèƒ½å·²å®ç°æ¨¡å‹ï¼Œä½†è·¯ç”±å¯èƒ½å·²åˆ é™¤ï¼ˆæ ¹æ® deleted_files ä¿¡æ¯ï¼‰
4. **CRDT ç®—æ³•ä¼˜åŒ–**ï¼šå½“å‰å®ç°äº†åŸºç¡€çš„CRDTæ¡†æ¶ï¼Œä½†æœªåœ¨WebSocketåä½œä¸­å®é™…åº”ç”¨

### 10.3 æ€§èƒ½ä¼˜åŒ–

1. **N+1 æŸ¥è¯¢**ï¼šæ–‡æ¡£ç‰ˆæœ¬æŸ¥è¯¢å·²ä¼˜åŒ–ï¼Œä½¿ç”¨ `get_document_version_count()` é¿å… N+1
2. **è¿æ¥æ± **ï¼šå·²é…ç½®è¿æ¥æ± ï¼Œå‚æ•°å¯æ ¹æ®å®é™…è´Ÿè½½è°ƒæ•´
3. **æ—¥å¿—ç³»ç»Ÿ**ï¼šå»ºè®®é…ç½®ç»“æ„åŒ–æ—¥å¿—ï¼ˆå¦‚ JSON æ ¼å¼ï¼‰ä¾¿äºåç»­åˆ†æ

---

## 11. å‰ç«¯åä½œæœºåˆ¶è¯¦è§£

### 11.1 å®æ—¶åä½œæµç¨‹

**å‰ç«¯æ–‡ä»¶**ï¼š`static/editor.js`

**è¿æ¥å»ºç«‹**ï¼š
```javascript
// æ”¯æŒTokenè®¤è¯çš„WebSocketè¿æ¥
const tokenPart = token ? `?token=${token}` : '';
ws = new WebSocket(`${protocol}//${location.host}/api/v1/ws/documents/${doc_id}${tokenPart}`);
```

**å†…å®¹åŒæ­¥æœºåˆ¶**ï¼š
1. **å¢é‡åŒæ­¥**ï¼šä½¿ç”¨æœ¬åœ°å†…å®¹ç¼“å­˜(`localContent`)å¯¹æ¯”ï¼Œåªåœ¨å†…å®¹å®é™…å˜åŒ–æ—¶å‘é€
2. **é˜²æŠ–ä¼˜åŒ–**ï¼š100msé˜²æŠ–å»¶è¿Ÿï¼Œé¿å…é¢‘ç¹ç½‘ç»œè¯·æ±‚
3. **æ¶ˆæ¯ç±»å‹**ï¼š
   - `content` - æ–‡æ¡£å†…å®¹æ›´æ–°
   - `cursor` - å…‰æ ‡ä½ç½®åŒæ­¥
   - `init` - åˆå§‹å†…å®¹åŠ è½½
   - `user_joined` - ç”¨æˆ·åŠ å…¥é€šçŸ¥

**å…‰æ ‡åŒæ­¥å®ç°**ï¼š
```javascript
// ç²¾ç¡®å…‰æ ‡ä½ç½®è®¡ç®—ï¼ˆæ”¯æŒä¸­æ–‡ã€æ¢è¡Œï¼‰
function drawCursor(user_id, username, position, color) {
    // ä½¿ç”¨Canvas APIç²¾ç¡®æµ‹é‡å­—ç¬¦å®½åº¦
    const charWidth = measureTextWidth("æµ‹", editor);
    // æ”¯æŒå¤šè¡Œæ–‡æœ¬å’Œä¸­æ–‡æ··åˆæ˜¾ç¤º
    const lines = textBefore.split("\n");
    const lineNum = lines.length - 1;
    const colNum = lines[lines.length - 1].length;
}
```

**æ€§èƒ½ä¼˜åŒ–**ï¼š
- **é˜²æŠ–æœºåˆ¶**ï¼šè¾“å…¥äº‹ä»¶100mså»¶è¿Ÿå‘é€
- **å¢é‡æ›´æ–°**ï¼šåªåœ¨å†…å®¹å˜åŒ–æ—¶å‘é€æ¶ˆæ¯
- **Canvasæµ‹é‡**ï¼šç²¾ç¡®è®¡ç®—å­—ç¬¦å®½åº¦ï¼Œæ”¯æŒä¸­è‹±æ–‡æ··æ’
- **äº‹ä»¶ä¼˜åŒ–**ï¼š`selectionchange` äº‹ä»¶50mså»¶è¿Ÿå¤„ç†

### 11.2 CRDT ç®—æ³•å®ç°

**å®ç°æ–‡ä»¶**ï¼š`app/crdt.py`

**æ ¸å¿ƒæ•°æ®ç»“æ„**ï¼š
```python
class CRDT:
    def __init__(self):
        self.sequence = []  # æ¯ä¸ªå…ƒç´ : {"id": (client, ts), "char": "A", "deleted": False}
```

**æ“ä½œç±»å‹**ï¼š
1. **æ’å…¥æ“ä½œ**ï¼š
   ```python
   def insert(self, index, char, client_id):
       op_id = (client_id, time.time())  # å”¯ä¸€æ“ä½œID
       element = {"id": op_id, "char": char, "deleted": False}
       return {"type": "insert", "id": op_id, "index": index, "char": char}
   ```

2. **åˆ é™¤æ“ä½œ**ï¼š
   ```python
   def delete(self, index):
       self.sequence[index]["deleted"] = True  # æ ‡è®°åˆ é™¤ï¼Œä¸ç‰©ç†åˆ é™¤
       return {"type": "delete", "id": self.sequence[index]["id"]}
   ```

3. **æ“ä½œåˆå¹¶**ï¼š
   ```python
   def merge(self, ops):
       for op in ops:
           self.apply(op)  # æŒ‰åºåº”ç”¨æ“ä½œ
   ```

**å½“å‰çŠ¶æ€**ï¼š
- âœ… åŸºç¡€CRDTæ¡†æ¶å·²å®ç°
- âš ï¸ æœªåœ¨WebSocketåä½œä¸­å®é™…åº”ç”¨
- âš ï¸ å½“å‰ä½¿ç”¨ç®€å•çš„å…¨é‡å†…å®¹åŒæ­¥
- ğŸ”§ å¯ä¼˜åŒ–ä¸ºçœŸæ­£çš„CRDTå†²çªè§£å†³æœºåˆ¶

**å»ºè®®æ”¹è¿›**ï¼š
1. é›†æˆCRDTåˆ°WebSocketæ¶ˆæ¯å¤„ç†
2. å®ç°æ“ä½œè½¬æ¢(OT)æˆ–çœŸæ­£çš„CRDTç®—æ³•
3. ä¼˜åŒ–ç½‘ç»œä¼ è¾“ï¼ŒåªåŒæ­¥æ“ä½œè€Œéå…¨é‡å†…å®¹

---

## 12. ä¾èµ–åŒ…æ¸…å•

**æ ¸å¿ƒä¾èµ–**ï¼ˆ`requirements.txt`ï¼‰ï¼š
- `fastapi==0.121.2` - Web æ¡†æ¶
- `uvicorn==0.38.0` - ASGI æœåŠ¡å™¨
- `SQLAlchemy==2.0.44` - ORM
- `psycopg2-binary==2.9.11` - PostgreSQL é©±åŠ¨
- `python-jose==3.5.0` - JWT å¤„ç†
- `passlib==1.7.4` - å¯†ç åŠ å¯†
- `pydantic-settings==2.0.3` - é…ç½®ç®¡ç†
- `websockets==15.0.1` - WebSocket æ”¯æŒ
- `python-multipart==0.0.12` - æ–‡ä»¶ä¸Šä¼ æ”¯æŒ
- `email-validator==2.3.0` - é‚®ç®±éªŒè¯

---

## 13. æ–‡ä»¶è·¯å¾„ç´¢å¼•

**å…³é”®æ–‡ä»¶è·¯å¾„**ï¼š

- åº”ç”¨å…¥å£ï¼š`app/main.py`
- é…ç½®ï¼š`core/config.py`
- å®‰å…¨è®¤è¯ï¼š`core/security.py`
- æ•°æ®åº“è¿æ¥ï¼š`db/session.py`
- æ•°æ®åº“åˆå§‹åŒ–ï¼š`db/init_db.py`
- æƒé™åˆå§‹åŒ–ï¼š`db/init_permissions.py`
- æ•°æ®æ¨¡å‹ï¼š`models/__init__.py`
- æ•°æ®éªŒè¯ï¼š`schemas/__init__.py`
- è®¤è¯è·¯ç”±ï¼š`api/routers/auth.py`
- ç”¨æˆ·è·¯ç”±ï¼š`api/routers/users.py`
- æ–‡æ¡£è·¯ç”±ï¼š`api/routers/documents.py`
- WebSocket è·¯ç”±ï¼š`api/routers/ws.py`
- ç”¨æˆ·æœåŠ¡ï¼š`services/user_service.py`
- æ–‡æ¡£æœåŠ¡ï¼š`services/document_service.py`
- WebSocket æœåŠ¡ï¼š`services/websocket_service.py`

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**ï¼š2024å¹´
**é¡¹ç›®ç‰ˆæœ¬**ï¼š1.0.0
**æœ€åæ›´æ–°**ï¼š2025å¹´11æœˆ24æ—¥ - åŸºäºå®é™…ä»£ç åº“çŠ¶æ€å®Œå–„
**æ›´æ–°å†…å®¹**ï¼š
- ä¿®æ­£WebSocketè®¤è¯è¯´æ˜ï¼ˆæ”¯æŒTokenå‚æ•°ï¼‰
- æ›´æ–°æ–‡ä»¶å­˜å‚¨é…ç½®æè¿°
- å®Œå–„å‰ç«¯åä½œæœºåˆ¶è¯¦è§£
- æ·»åŠ CRDTç®—æ³•å®ç°åˆ†æ
- ä¼˜åŒ–æ€§èƒ½ä¼˜åŒ–ç‚¹è¯´æ˜