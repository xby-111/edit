<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>协作编辑器</title>
    <!-- Quill 编辑器 CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }
        .status-text {
            color: #666;
        }
        .save-indicator {
            font-size: 12px;
            color: #4CAF50;
            margin-left: 10px;
        }
        .editor-container {
            position: relative;
            margin-top: 20px;
        }
        #editor {
            min-height: 400px;
            background-color: white;
        }
        .toolbar {
            border: 1px solid #ccc;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
        }
        .remote-cursor {
            position: absolute;
            width: 2px;
            height: 20px;
            z-index: 10;
            pointer-events: none;
        }
        .cursor-label {
            position: absolute;
            top: -25px;
            left: -2px;
            background: #000;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            white-space: nowrap;
        }
        .draft-restore {
            background-color: #ff9800;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }
        .draft-restore:hover { background-color: #e68900; }
        .mode-btn { background-color: #2196F3; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .mode-btn.active { background-color: #1976D2; }
        .mode-btn + .mode-btn { margin-left: 6px; }
        .collab-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; margin-top: 16px; }
        .panel { background: #fafafa; border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; }
        #comment-list { max-height: 260px; overflow-y: auto; border: 1px solid #ddd; padding: 8px; border-radius: 4px; margin-bottom: 8px; }
        #comment-input { width: 100%; min-height: 80px; padding: 8px; }
        #task-list table { width: 100%; border-collapse: collapse; }
        #task-list th, #task-list td { border: 1px solid #ddd; padding: 6px; text-align: left; }
        #task-form input, #task-form textarea { width: 100%; padding: 6px; margin-bottom: 6px; }
        .online-users { font-size: 12px; color: #555; }
        #markdown-editor { display: none; }
        /* 连接状态指示器样式 */
        .status-connected { color: #4CAF50; }
        .status-disconnected { color: #F44336; }
        .status-reconnecting { color: #FF9800; }
        #connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 14px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- 连接状态指示器 -->
    <div id="connection-status" class="status-disconnected">● 未连接</div>
    
    <div class="container">
        <div class="header">
            <h2>多人实时协作编辑器</h2>
            <div>
                <button id="rich-text-btn" class="mode-btn active">富文本</button>
                <button id="markdown-btn" class="mode-btn">Markdown</button>
                <button id="share-manage-btn" class="mode-btn" style="background-color: #4CAF50;">共享管理</button>
                <button id="back-to-documents" style="background-color: #2196F3; padding: 8px 16px; border: none; border-radius: 4px; color: white; cursor: pointer; margin-left: 20px;">返回文档列表</button>
            </div>
        </div>

        <div class="editor-container">
            <div id="rich-editor" style="display: block;">
                <div id="editor"></div>
            </div>
            <div id="markdown-editor" style="display: none;">
                <textarea id="markdown-textarea" style="width: 100%; height: 400px; font-family: monospace; font-size: 16px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; resize: vertical;"></textarea>
            </div>
            <div id="cursor-layer" style="position: relative; height: 0; pointer-events: none;"></div>
        </div>

        <div class="status">
            <div class="status-info">
                <span id="status-text" class="status-text">连接中...</span>
                <span id="save-indicator" class="save-indicator" style="display: none;">已自动保存</span>
                <span id="draft-indicator" class="save-indicator" style="display: none; background-color: #ff9800;">发现本地草稿</span>
            </div>
            <div class="online-users" id="online-users">在线用户：-</div>
            <div>
                <button id="restore-draft-btn" class="draft-restore" style="display: none;">恢复本地草稿</button>
            </div>
        </div>

        <div class="collab-layout">
            <div class="panel">
                <h3>文档编辑</h3>
                <p id="editing-tip" class="status-text">等待连接...</p>
            </div>
            <div class="panel">
                <h3>评论区</h3>
                <div id="comment-list"></div>
                <textarea id="comment-input" placeholder="输入评论..."></textarea>
                <button id="comment-submit">发送</button>
            </div>
        </div>

        <div class="panel" style="margin-top: 16px;">
        <h3>任务列表</h3>
        <div id="task-list"></div>
        <div id="task-form">
            <input type="text" id="task-title" placeholder="任务标题">
            <textarea id="task-desc" placeholder="任务描述（可选）"></textarea>
            <input type="date" id="task-due">
            <button id="task-create">创建任务</button>
        </div>
    </div>
</div>

<!-- 共享管理弹窗 -->
<div id="share-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: relative; max-width: 500px; margin: 100px auto; background: white; padding: 20px; border-radius: 8px;">
        <h3>共享管理</h3>
        <button id="close-share-modal" style="float: right; background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">关闭</button>
        
        <div style="margin-bottom: 15px;">
            <label>添加协作者：</label>
            <input type="text" id="collaborator-username" placeholder="输入用户名" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <select id="collaborator-role" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="editor">编辑者</option>
                <option value="viewer">查看者</option>
            </select>
            <button id="add-collaborator" style="background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">添加</button>
        </div>
        
        <div style="margin-bottom: 15px;">
            <label>批量添加：</label>
            <textarea id="batch-collaborators" placeholder="每行一个用户名和角色，格式: username1:editor&#10;username2:viewer" style="width: 100%; height: 80px; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            <button id="batch-add-collaborators" style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">批量添加</button>
        </div>
        
        <div>
            <h4>当前协作者：</h4>
            <div id="collaborators-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;"></div>
        </div>
    </div>
</div>
    </div>

    <!-- Quill 编辑器 JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        let currentMode = 'rich-text';
        let quillEditor = null;
        let socket = null;
        let isRemoteUpdating = false;
        let onlineUsers = new Set();
        
        // WebSocket 重连配置
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 10;
        const RECONNECT_INTERVAL = 3000; // 3 秒

        const params = new URLSearchParams(window.location.search);
        const docId = parseInt(params.get('doc_id') || '1');
        const token = params.get('token') || localStorage.getItem('access_token') || '';
        const username = params.get('username') || '';
        const authHeader = token ? { 'Authorization': `Bearer ${token}` } : {};

        document.getElementById('back-to-documents').addEventListener('click', () => { window.location.href = '/'; });
        document.getElementById('rich-text-btn').addEventListener('click', () => switchToMode('rich-text'));
        document.getElementById('markdown-btn').addEventListener('click', () => switchToMode('markdown'));

        function switchToMode(mode) {
            currentMode = mode;
            document.getElementById('rich-text-btn').classList.toggle('active', mode === 'rich-text');
            document.getElementById('markdown-btn').classList.toggle('active', mode === 'markdown');
            document.getElementById('rich-editor').style.display = mode === 'rich-text' ? 'block' : 'none';
            document.getElementById('markdown-editor').style.display = mode === 'markdown' ? 'block' : 'none';
            if (mode === 'rich-text' && quillEditor) {
                const markdownContent = document.getElementById('markdown-textarea').value;
                quillEditor.root.innerHTML = markdownToHtml(markdownContent);
            } else if (mode === 'markdown') {
                const richContent = quillEditor ? quillEditor.root.innerHTML : '';
                document.getElementById('markdown-textarea').value = htmlToMarkdown(richContent);
            }
        }

        function markdownToHtml(markdown) {
            return markdown
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/^\> (.*$)/gim, '<blockquote>$1</blockquote>')
                .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
                .replace(/\*(.*)\*/gim, '<em>$1</em>')
                .replace(/!\[([^\]]*)\]\(([^)]*)\)/gim, '<img alt="$1" src="$2" />')
                .replace(/\[([^\]]*)\]\(([^)]*)\)/gim, '<a href="$2">$1</a>')
                .replace(/\n$/gim, '<br />')
                .replace(/^\- (.*$)/gim, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
        }

        function htmlToMarkdown(html) {
            return html
                .replace(/<h1>(.*?)<\/h1>/gim, '# $1')
                .replace(/<h2>(.*?)<\/h2>/gim, '## $1')
                .replace(/<h3>(.*?)<\/h3>/gim, '### $1')
                .replace(/<blockquote>(.*?)<\/blockquote>/gim, '> $1')
                .replace(/<strong>(.*?)<\/strong>/gim, '**$1**')
                .replace(/<em>(.*?)<\/em>/gim, '*$1*')
                .replace(/<img[^>]*alt="([^"]*)"[^>]*>/gim, '![$1]($2)')
                .replace(/<a[^>]*href="([^"]*)"[^>]*>(.*?)<\/a>/gim, '[$2]($1)')
                .replace(/<br\s*\/?/gim, '\n')
                .replace(/<ul>(.*?)<\/ul>/gims, '$1')
                .replace(/<li>(.*?)<\/li>/gim, '- $1');
        }

        function getCurrentContent() {
            if (currentMode === 'rich-text' && quillEditor) {
                return quillEditor.root.innerHTML;
            }
            return document.getElementById('markdown-textarea').value;
        }

        function setCurrentContent(content) {
            if (currentMode === 'rich-text' && quillEditor) {
                quillEditor.root.innerHTML = content;
            } else {
                document.getElementById('markdown-textarea').value = content;
            }
        }

        function initQuillEditor() {
            quillEditor = new Quill('#editor', {
                theme: 'snow',
                placeholder: '开始编写内容...',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        ['blockquote', 'code-block'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'script': 'sub'}, { 'script': 'super' }],
                        [{ 'indent': '-1'}, { 'indent': '+1' }],
                        [{ 'color': [] }, { 'background': [] }],
                        ['link', 'image'],
                        ['clean'],
                    ]
                }
            });

            quillEditor.on('text-change', function(delta, oldDelta, source) {
                if (source === 'user' && socket && socket.readyState === WebSocket.OPEN && !isRemoteUpdating) {
                    sendContentUpdate(getCurrentContent());
                    if (window.autoSave) window.autoSave();
                }
            });

            quillEditor.on('selection-change', function(range, oldRange, source) {
                if (source === 'user') {
                    sendCursor(range);
                }
            });
        }

        function updateStatus(text) { 
            document.getElementById('status-text').textContent = text; 
            // 同时更新连接状态指示器
            const indicator = document.getElementById('connection-status');
            if (indicator) {
                if (text === '已连接') {
                    indicator.className = 'status-connected';
                    indicator.textContent = '● 已连接';
                } else if (text === '连接已关闭' || text === '连接出错') {
                    indicator.className = 'status-disconnected';
                    indicator.textContent = '● 已断开';
                } else if (text === '重连中...') {
                    indicator.className = 'status-reconnecting';
                    indicator.textContent = '● 重连中...';
                } else {
                    indicator.className = 'status-disconnected';
                    indicator.textContent = '● ' + text;
                }
            }
        }
        function updateOnlineUsers() { document.getElementById('online-users').textContent = `在线用户：${Array.from(onlineUsers).join(', ') || '-'}`; }
        function showSaveIndicator() {
            const indicator = document.getElementById('save-indicator');
            indicator.style.display = 'inline';
            setTimeout(() => indicator.style.display = 'none', 2000);
        }

        function checkLocalDraft(documentId) {
            const draftKey = `draft_${documentId}`;
            const draft = localStorage.getItem(draftKey);
            if (draft) {
                const draftData = JSON.parse(draft);
                const serverTime = localStorage.getItem(`server_time_${documentId}`) || 0;
                if (draftData.timestamp > serverTime) {
                    document.getElementById('draft-indicator').style.display = 'inline';
                    document.getElementById('restore-draft-btn').style.display = 'inline-block';
                    return true;
                }
            }
            return false;
        }

        document.getElementById('restore-draft-btn').addEventListener('click', function() {
            const draftKey = `draft_${docId}`;
            const draft = localStorage.getItem(draftKey);
            if (draft) {
                const draftData = JSON.parse(draft);
                setCurrentContent(draftData.content);
                document.getElementById('draft-indicator').style.display = 'none';
                document.getElementById('restore-draft-btn').style.display = 'none';
                localStorage.removeItem(draftKey);
                alert('本地草稿已恢复');
            }
        });

        function saveLocalDraft(documentId, content) {
            const draftKey = `draft_${documentId}`;
            const draftData = { content: content, timestamp: Date.now() };
            localStorage.setItem(draftKey, JSON.stringify(draftData));
        }

        function autoSaveSetup() {
            window.autoSave = function() {
                const currentContent = getCurrentContent();
                saveLocalDraft(docId, currentContent);
            };
        }

        function connectWebSocket() {
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${location.host}/ws/documents/${docId}?token=${encodeURIComponent(token)}&username=${encodeURIComponent(username || '匿名用户')}`;
            socket = new WebSocket(wsUrl);

            socket.onopen = () => {
                updateStatus('已连接');
                reconnectAttempts = 0; // 重置重连计数
                document.getElementById('editing-tip').textContent = '你正在编辑文档';
            };

            socket.onerror = (e) => {
                console.error('WebSocket错误:', e);
                updateStatus('连接出错');
            };
            
            socket.onclose = (e) => {
                console.log('WebSocket关闭:', e.code, e.reason);
                updateStatus('连接已关闭');
                // 清理socket引用
                socket = null;
                
                // 尝试自动重连
                if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    reconnectAttempts++;
                    updateStatus('重连中...');
                    console.log(`尝试重连... (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`);
                    setTimeout(() => {
                        connectWebSocket();
                    }, RECONNECT_INTERVAL);
                } else {
                    console.log('已达到最大重连次数');
                    alert('连接已断开，请刷新页面重新连接');
                }
            };

            socket.onmessage = (event) => {
                const msg = JSON.parse(event.data || '{}');
                
                // 处理心跳消息
                if (msg.type === 'ping') {
                    socket.send(JSON.stringify({ type: 'pong' }));
                    return;
                }
                
                if (msg.type === 'presence') {
                    if (msg.action === 'init' && Array.isArray(msg.online_users)) {
                        onlineUsers = new Set(msg.online_users);
                        // 显示详细的在线用户信息
                        if (msg.online_users_info && Array.isArray(msg.online_users_info)) {
                            console.log('在线用户详情:', msg.online_users_info);
                        }
                    }
                    if (msg.action === 'join') onlineUsers.add(msg.user);
                    if (msg.action === 'leave') onlineUsers.delete(msg.user);
                    updateOnlineUsers();
                    return;
                }

                // 处理初始化消息
                if (msg.type === 'init' && msg.payload?.html !== undefined) {
                    isRemoteUpdating = true;
                    setCurrentContent(msg.payload.html);
                    saveLocalDraft(docId, msg.payload.html);
                    
                    // 处理权限信息
                    if (msg.permissions) {
                        const permissions = msg.permissions;
                        const canEdit = permissions.can_edit;
                        const isOwner = permissions.is_owner;
                        
                        // 更新编辑器状态
                        if (quillEditor) {
                            quillEditor.enable(canEdit);
                        }
                        document.getElementById('markdown-textarea').disabled = !canEdit;
                        
                        // 更新状态提示
                        if (isOwner) {
                            document.getElementById('editing-tip').textContent = '你是文档所有者，可以编辑和管理协作者';
                        } else if (canEdit) {
                            document.getElementById('editing-tip').textContent = '你是编辑者，可以编辑文档内容';
                        } else {
                            document.getElementById('editing-tip').textContent = '你是查看者，只能查看文档内容';
                        }
                        
                        // 显示/隐藏共享管理按钮
                        const shareBtn = document.getElementById('share-manage-btn');
                        if (shareBtn) {
                            shareBtn.style.display = isOwner ? 'inline-block' : 'none';
                        }
                    }
                    
                    isRemoteUpdating = false;
                    return;
                }

                if (msg.type === 'content_update' && msg.payload?.html) {
                    if (msg.user === username) return;
                    isRemoteUpdating = true;
                    setCurrentContent(msg.payload.html);
                    saveLocalDraft(docId, msg.payload.html);
                    isRemoteUpdating = false;
                    return;
                }

                if (msg.type === 'cursor' && msg.user) {
                    document.getElementById('editing-tip').textContent = `${msg.user} 正在编辑文档...`;
                    return;
                }

                // 处理错误消息
                if (msg.type === 'error' && msg.payload?.message) {
                    alert(msg.payload.message);
                    return;
                }
            };
        }

        function sendContentUpdate(html) {
            if (!socket || socket.readyState !== WebSocket.OPEN) return;
            socket.send(JSON.stringify({ type: 'content_update', payload: { html } }));
        }

        function sendCursor(range) {
            if (!socket || socket.readyState !== WebSocket.OPEN) return;
            const index = range?.index || 0;
            const length = range?.length || 0;
            socket.send(JSON.stringify({ type: 'cursor', payload: { index, length } }));
        }

        async function fetchComments() {
            const res = await fetch(`/api/v1/documents/${docId}/comments`, { headers: { 'Content-Type': 'application/json', ...authHeader } });
            if (!res.ok) return;
            const data = await res.json();
            const list = document.getElementById('comment-list');
            list.innerHTML = '';
            data.forEach(c => {
                const div = document.createElement('div');
                div.style.borderBottom = '1px solid #eee';
                div.style.padding = '6px 0';
                div.innerHTML = `<strong>#${c.user_id}</strong>：${c.content}<div style="font-size:12px;color:#888;">${c.created_at}</div>`;
                list.appendChild(div);
            });
        }

        async function submitComment() {
            const content = document.getElementById('comment-input').value.trim();
            if (!content) return;
            const res = await fetch(`/api/v1/documents/${docId}/comments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', ...authHeader },
                body: JSON.stringify({ content })
            });
            if (res.ok) {
                document.getElementById('comment-input').value = '';
                fetchComments();
            }
        }

        async function fetchTasks() {
            const res = await fetch(`/api/v1/documents/${docId}/tasks`, { headers: { 'Content-Type': 'application/json', ...authHeader } });
            if (!res.ok) return;
            const data = await res.json();
            const container = document.getElementById('task-list');
            const rows = data.map(t => `<tr><td>${t.title}</td><td>${t.status}</td><td>${t.due_at || ''}</td><td><button data-id="${t.id}" class="task-done">完成</button></td></tr>`).join('');
            container.innerHTML = `<table><tr><th>标题</th><th>状态</th><th>截止</th><th>操作</th></tr>${rows}</table>`;
            document.querySelectorAll('.task-done').forEach(btn => btn.addEventListener('click', () => updateTaskStatus(btn.dataset.id)));
        }

        async function createTask() {
            const title = document.getElementById('task-title').value.trim();
            if (!title) return;
            const description = document.getElementById('task-desc').value.trim();
            const due_at = document.getElementById('task-due').value || null;
            const res = await fetch(`/api/v1/documents/${docId}/tasks`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', ...authHeader },
                body: JSON.stringify({ title, description, due_at })
            });
            if (res.ok) {
                document.getElementById('task-title').value = '';
                document.getElementById('task-desc').value = '';
                document.getElementById('task-due').value = '';
                fetchTasks();
                alert('任务创建成功');
            }
        }

        async function updateTaskStatus(taskId) {
            const res = await fetch(`/api/v1/tasks/${taskId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', ...authHeader },
                body: JSON.stringify({ status: 'DONE' })
            });
            if (res.ok) {
                fetchTasks();
                const tip = document.createElement('div');
                tip.style.background = '#d4edda';
                tip.style.color = '#155724';
                tip.style.padding = '6px';
                tip.style.marginTop = '8px';
                tip.textContent = '任务已完成！';
                document.getElementById('task-form').appendChild(tip);
                setTimeout(() => tip.remove(), 2000);
            }
        }

        document.getElementById('comment-submit').addEventListener('click', submitComment);
        document.getElementById('task-create').addEventListener('click', createTask);
        document.getElementById('share-manage-btn').addEventListener('click', showShareModal);
        document.getElementById('close-share-modal').addEventListener('click', hideShareModal);
        document.getElementById('add-collaborator').addEventListener('click', addCollaborator);
        document.getElementById('batch-add-collaborators').addEventListener('click', batchAddCollaborators);

        // 共享管理函数
        function showShareModal() {
            document.getElementById('share-modal').style.display = 'block';
            loadCollaborators();
        }

        function hideShareModal() {
            document.getElementById('share-modal').style.display = 'none';
        }

        async function addCollaborator() {
            const username = document.getElementById('collaborator-username').value.trim();
            const role = document.getElementById('collaborator-role').value;
            
            if (!username) {
                alert('请输入用户名');
                return;
            }

            try {
                const response = await fetch(`/api/v1/documents/${docId}/collaborators`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeader },
                    body: JSON.stringify({ username, role })
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    document.getElementById('collaborator-username').value = '';
                    loadCollaborators();
                } else {
                    const error = await response.json();
                    alert(`添加失败: ${error.detail}`);
                }
            } catch (error) {
                console.error('添加协作者失败:', error);
                alert('添加协作者失败，请检查网络连接');
            }
        }

        async function batchAddCollaborators() {
            const batchText = document.getElementById('batch-collaborators').value.trim();
            if (!batchText) {
                alert('请输入要批量添加的用户');
                return;
            }

            // 解析批量输入
            const lines = batchText.split('\n').filter(line => line.trim());
            const users = [];
            
            for (const line of lines) {
                const parts = line.split(':');
                if (parts.length === 2) {
                    users.push({
                        username: parts[0].trim(),
                        role: parts[1].trim()
                    });
                }
            }

            if (users.length === 0) {
                alert('请按正确格式输入：每行一个用户名和角色，用冒号分隔');
                return;
            }

            try {
                const response = await fetch(`/api/v1/documents/${docId}/collaborators/batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeader },
                    body: JSON.stringify({ users })
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`批量添加完成：成功 ${result.success} 个，失败 ${result.failed} 个`);
                    document.getElementById('batch-collaborators').value = '';
                    loadCollaborators();
                } else {
                    const error = await response.json();
                    alert(`批量添加失败: ${error.detail}`);
                }
            } catch (error) {
                console.error('批量添加协作者失败:', error);
                alert('批量添加协作者失败，请检查网络连接');
            }
        }

        async function loadCollaborators() {
            try {
                const response = await fetch(`/api/v1/documents/${docId}/collaborators`, {
                    headers: { 'Content-Type': 'application/json', ...authHeader }
                });

                if (response.ok) {
                    const result = await response.json();
                    const list = document.getElementById('collaborators-list');
                    list.innerHTML = '';
                    
                    if (result.collaborators && result.collaborators.length > 0) {
                        result.collaborators.forEach(collab => {
                            const div = document.createElement('div');
                            div.style.borderBottom = '1px solid #eee';
                            div.style.padding = '8px 0';
                            div.innerHTML = `
                                <strong>${collab.username}</strong> 
                                <span style="margin-left: 10px; color: #666;">(${collab.role})</span>
                                <span style="margin-left: 10px; font-size: 12px; color: #999;">${collab.created_at}</span>
                                <button onclick="removeCollaborator(${collab.user_id})" style="margin-left: 10px; background: #f44336; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer;">移除</button>
                            `;
                            list.appendChild(div);
                        });
                    } else {
                        list.innerHTML = '<span style="color: #999;">暂无协作者</span>';
                    }
                }
            } catch (error) {
                console.error('加载协作者列表失败:', error);
            }
        }

        async function removeCollaborator(userId) {
            if (!confirm('确定要移除该协作者吗？')) {
                return;
            }

            try {
                const response = await fetch(`/api/v1/documents/${docId}/collaborators/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json', ...authHeader }
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    loadCollaborators();
                } else {
                    const error = await response.json();
                    alert(`移除失败: ${error.detail}`);
                }
            } catch (error) {
                console.error('移除协作者失败:', error);
                alert('移除协作者失败，请检查网络连接');
            }
        }

        // 页面关闭时清理WebSocket连接
        window.addEventListener('beforeunload', function() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                // 发送关闭消息（可选）
                try {
                    socket.close(1000, 'Page closing');
                } catch (e) {
                    console.error('关闭WebSocket时出错:', e);
                }
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            initQuillEditor();
            autoSaveSetup();
            checkLocalDraft(docId);
            connectWebSocket();
            fetchComments();
            fetchTasks();
        });
    </script>
</body>
</html>
