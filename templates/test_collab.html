<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>协作编辑器 - 多人协作文档编辑系统</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- Quill Editor CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .navbar {
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            z-index: 1000;
        }
        
        .editor-layout {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
            position: relative;
        }
        
        .editor-wrapper {
            flex: 1;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        
        #editor {
            flex: 1;
            border: none !important;
            font-size: 16px;
        }
        
        .ql-toolbar {
            border-top: none !important;
            border-left: none !important;
            border-right: none !important;
            border-bottom: 1px solid #dee2e6 !important;
            background-color: #fff;
            border-radius: 8px 8px 0 0;
        }
        
        .ql-container {
            border: none !important;
            flex: 1;
            overflow-y: auto;
        }
        
        .sidebar {
            width: 320px;
            background: white;
            border-left: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }
        
        .sidebar.collapsed {
            transform: translateX(100%);
            width: 0;
            border: none;
        }
        
        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        /* Cursor Layer */
        #cursor-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        .remote-cursor {
            position: absolute;
            width: 2px;
            background-color: #FF5733;
            transition: all 0.1s ease;
        }
        
        .cursor-label {
            position: absolute;
            top: -22px;
            left: -2px;
            background-color: #FF5733;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0.8;
        }
        
        /* Status Indicator */
        .status-indicator {
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #ccc;
        }
        
        .status-connected .status-dot { background-color: #198754; }
        .status-connected { color: #198754; }
        
        .status-disconnected .status-dot { background-color: #dc3545; }
        .status-disconnected { color: #dc3545; }
        
        .status-reconnecting .status-dot { background-color: #ffc107; }
        .status-reconnecting { color: #ffc107; }
        
        /* Comments & Tasks */
        .comment-item {
            border-bottom: 1px solid #f0f0f0;
            padding: 10px 0;
        }
        
        .comment-item:last-child {
            border-bottom: none;
        }
        
        .task-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .task-done {
            text-decoration: line-through;
            color: #999;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom px-3">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <i class="bi bi-arrow-left-circle me-2 text-secondary"></i>
                <span class="fw-bold text-primary">协作编辑器</span>
            </a>
            
            <div class="d-flex align-items-center gap-3">
                <div id="connection-status" class="status-indicator status-disconnected">
                    <div class="status-dot"></div>
                    <span id="status-text">未连接</span>
                </div>
                
                <div class="vr mx-2"></div>
                
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary active" id="mode-rich">
                        <i class="bi bi-type-bold"></i> 富文本
                    </button>
                    <button class="btn btn-outline-secondary" id="mode-markdown">
                        <i class="bi bi-markdown"></i> Markdown
                    </button>
                </div>
                
                <button class="btn btn-sm btn-outline-primary" id="share-btn">
                    <i class="bi bi-share"></i> 共享
                </button>
                
                <button class="btn btn-sm btn-outline-secondary" id="toggle-sidebar">
                    <i class="bi bi-layout-sidebar-reverse"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Layout -->
    <div class="editor-layout">
        <!-- Editor Area -->
        <div class="main-area">
            <div class="editor-wrapper">
                <!-- Quill Toolbar will be inserted here by Quill -->
                <div id="editor"></div>
                <!-- Cursor Layer -->
                <div id="cursor-layer"></div>
            </div>
            
            <!-- Markdown Editor (Hidden by default) -->
            <div id="markdown-editor-container" class="editor-wrapper" style="display: none;">
                <textarea id="markdown-textarea" class="form-control border-0 h-100 p-3" style="resize: none; font-family: monospace;"></textarea>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <ul class="nav nav-pills nav-fill w-100" id="sidebar-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active py-1" id="comments-tab" data-bs-toggle="tab" data-bs-target="#comments-pane" type="button">
                            <i class="bi bi-chat-dots"></i> 评论
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link py-1" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks-pane" type="button">
                            <i class="bi bi-check2-square"></i> 任务
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link py-1" id="users-tab" data-bs-toggle="tab" data-bs-target="#users-pane" type="button">
                            <i class="bi bi-people"></i> 在线
                        </button>
                    </li>
                </ul>
            </div>
            
            <div class="tab-content sidebar-content">
                <!-- Comments Pane -->
                <div class="tab-pane fade show active" id="comments-pane">
                    <div id="comment-list" class="mb-3">
                        <div class="text-center text-muted small py-3">加载评论中...</div>
                    </div>
                    <div class="mt-auto">
                        <textarea class="form-control mb-2" id="comment-input" rows="2" placeholder="输入评论..."></textarea>
                        <button class="btn btn-primary btn-sm w-100" id="comment-submit">发送评论</button>
                    </div>
                </div>
                
                <!-- Tasks Pane -->
                <div class="tab-pane fade" id="tasks-pane">
                    <div id="task-list" class="mb-3">
                        <div class="text-center text-muted small py-3">加载任务中...</div>
                    </div>
                    <div class="mt-auto border-top pt-3">
                        <h6 class="small fw-bold mb-2">新建任务</h6>
                        <input type="text" class="form-control form-control-sm mb-2" id="task-title" placeholder="任务标题">
                        <textarea class="form-control form-control-sm mb-2" id="task-desc" rows="2" placeholder="描述 (可选)"></textarea>
                        <input type="date" class="form-control form-control-sm mb-2" id="task-due">
                        <button class="btn btn-success btn-sm w-100" id="task-create">创建任务</button>
                    </div>
                </div>
                
                <!-- Users Pane -->
                <div class="tab-pane fade" id="users-pane">
                    <h6 class="small fw-bold mb-3">在线用户</h6>
                    <div id="online-users-list">
                        <!-- Dynamic user list -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal fade" id="shareModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">文档共享管理</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <label class="form-label fw-bold">添加协作者</label>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" id="collaborator-username" placeholder="用户名">
                            <select class="form-select" id="collaborator-role" style="max-width: 120px;">
                                <option value="editor">编辑者</option>
                                <option value="viewer">查看者</option>
                            </select>
                            <button class="btn btn-primary" id="add-collaborator">添加</button>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label fw-bold">当前协作者</label>
                        <div id="collaborators-list" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                            <div class="text-center text-muted small">加载中...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="/static/toast.js"></script>
    <script src="/static/client.js"></script>
    <script src="/static/editor.js"></script>
    
    <script>
        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // Parse URL params
            const params = new URLSearchParams(window.location.search);
            const docId = parseInt(params.get('doc_id') || '1');
            const token = params.get('token') || localStorage.getItem('access_token') || '';
            
            if (!token) {
                Toast.error('未登录，请先登录');
                setTimeout(() => window.location.href = '/', 2000);
                return;
            }

            // Initialize Quill
            const toolbarOptions = [
                ['bold', 'italic', 'underline', 'strike'],
                ['blockquote', 'code-block'],
                [{ 'header': 1 }, { 'header': 2 }],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'color': [] }, { 'background': [] }],
                ['clean']
            ];

            window.quillEditor = new Quill('#editor', {
                theme: 'snow',
                modules: {
                    toolbar: toolbarOptions
                }
            });

            // Initialize Editor Logic (WebSocket, CRDT, etc.)
            if (window.initEditor) {
                window.initEditor(docId, token);
            }

            // UI Event Handlers
            setupUIHandlers(docId);
            
            // Load Initial Data
            loadComments(docId);
            loadTasks(docId);
        });

        function setupUIHandlers(docId) {
            // Sidebar Toggle
            document.getElementById('toggle-sidebar').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('collapsed');
            });

            // Mode Switch
            document.getElementById('mode-rich').addEventListener('click', function() {
                this.classList.add('active');
                document.getElementById('mode-markdown').classList.remove('active');
                document.querySelector('.editor-wrapper').style.display = 'flex';
                document.getElementById('markdown-editor-container').style.display = 'none';
            });

            document.getElementById('mode-markdown').addEventListener('click', function() {
                this.classList.add('active');
                document.getElementById('mode-rich').classList.remove('active');
                document.querySelector('.editor-wrapper').style.display = 'none';
                document.getElementById('markdown-editor-container').style.display = 'block';
                // Sync content to markdown textarea
                document.getElementById('markdown-textarea').value = window.quillEditor.getText();
            });

            // Share Modal
            const shareModal = new bootstrap.Modal(document.getElementById('shareModal'));
            document.getElementById('share-btn').addEventListener('click', () => {
                shareModal.show();
                loadCollaborators(docId);
            });

            // Comment Submit
            document.getElementById('comment-submit').addEventListener('click', async () => {
                const content = document.getElementById('comment-input').value.trim();
                if (!content) return;
                
                try {
                    await api.request(`/documents/${docId}/comments`, {
                        method: 'POST',
                        body: JSON.stringify({ content })
                    });
                    document.getElementById('comment-input').value = '';
                    loadComments(docId);
                    Toast.success('评论已发送');
                } catch (e) {
                    Toast.error('发送评论失败: ' + e.message);
                }
            });

            // Task Create
            document.getElementById('task-create').addEventListener('click', async () => {
                const title = document.getElementById('task-title').value.trim();
                if (!title) return;
                
                try {
                    await api.request(`/documents/${docId}/tasks`, {
                        method: 'POST',
                        body: JSON.stringify({
                            title,
                            description: document.getElementById('task-desc').value.trim(),
                            due_at: document.getElementById('task-due').value || null
                        })
                    });
                    
                    // Clear form
                    document.getElementById('task-title').value = '';
                    document.getElementById('task-desc').value = '';
                    document.getElementById('task-due').value = '';
                    
                    loadTasks(docId);
                    Toast.success('任务创建成功');
                } catch (e) {
                    Toast.error('创建任务失败: ' + e.message);
                }
            });
            
            // Add Collaborator
            document.getElementById('add-collaborator').addEventListener('click', async () => {
                const username = document.getElementById('collaborator-username').value.trim();
                const role = document.getElementById('collaborator-role').value;
                
                if (!username) return;
                
                try {
                    await api.request(`/documents/${docId}/collaborators`, {
                        method: 'POST',
                        body: JSON.stringify({ username, role })
                    });
                    document.getElementById('collaborator-username').value = '';
                    loadCollaborators(docId);
                    Toast.success('协作者添加成功');
                } catch (e) {
                    Toast.error('添加失败: ' + e.message);
                }
            });
        }

        async function loadComments(docId) {
            try {
                const comments = await api.request(`/documents/${docId}/comments`);
                const list = document.getElementById('comment-list');
                
                if (comments.length === 0) {
                    list.innerHTML = '<div class="text-center text-muted small py-3">暂无评论</div>';
                    return;
                }
                
                list.innerHTML = comments.map(c => `
                    <div class="comment-item">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="fw-bold small">#${c.user_id}</span>
                            <span class="text-muted small" style="font-size: 10px;">${new Date(c.created_at).toLocaleString()}</span>
                        </div>
                        <div class="small text-break">${c.content}</div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('加载评论失败', e);
            }
        }

        async function loadTasks(docId) {
            try {
                const tasks = await api.request(`/documents/${docId}/tasks`);
                const list = document.getElementById('task-list');
                
                if (tasks.length === 0) {
                    list.innerHTML = '<div class="text-center text-muted small py-3">暂无任务</div>';
                    return;
                }
                
                list.innerHTML = tasks.map(t => `
                    <div class="task-item">
                        <div class="flex-grow-1">
                            <div class="fw-bold small ${t.status === 'DONE' ? 'task-done' : ''}">${t.title}</div>
                            ${t.due_at ? `<div class="text-muted" style="font-size: 10px;">截止: ${new Date(t.due_at).toLocaleDateString()}</div>` : ''}
                        </div>
                        ${t.status !== 'DONE' ? `
                            <button class="btn btn-outline-success btn-sm py-0 px-1" onclick="completeTask(${t.id}, ${docId})">
                                <i class="bi bi-check"></i>
                            </button>
                        ` : '<i class="bi bi-check-circle-fill text-success"></i>'}
                    </div>
                `).join('');
            } catch (e) {
                console.error('加载任务失败', e);
            }
        }
        
        async function completeTask(taskId, docId) {
            try {
                await api.request(`/tasks/${taskId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ status: 'DONE' })
                });
                loadTasks(docId);
                Toast.success('任务已完成');
            } catch (e) {
                Toast.error('操作失败: ' + e.message);
            }
        }
        
        async function loadCollaborators(docId) {
            try {
                const res = await api.request(`/documents/${docId}/collaborators`);
                const list = document.getElementById('collaborators-list');
                
                if (!res.collaborators || res.collaborators.length === 0) {
                    list.innerHTML = '<div class="text-center text-muted small">暂无协作者</div>';
                    return;
                }
                
                list.innerHTML = res.collaborators.map(c => `
                    <div class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom">
                        <div>
                            <div class="fw-bold small">${c.username}</div>
                            <div class="text-muted" style="font-size: 10px;">${c.role}</div>
                        </div>
                        <button class="btn btn-outline-danger btn-sm py-0 px-2" onclick="removeCollaborator(${docId}, ${c.user_id})">
                            移除
                        </button>
                    </div>
                `).join('');
            } catch (e) {
                console.error('加载协作者失败', e);
            }
        }
        
        async function removeCollaborator(docId, userId) {
            if (!await Toast.confirm('确定要移除该协作者吗？')) return;
            
            try {
                await api.request(`/documents/${docId}/collaborators/${userId}`, {
                    method: 'DELETE'
                });
                loadCollaborators(docId);
                Toast.success('协作者已移除');
            } catch (e) {
                Toast.error('移除失败: ' + e.message);
            }
        }
        
        // Expose functions to global scope for onclick handlers
        window.completeTask = completeTask;
        window.removeCollaborator = removeCollaborator;
    </script>
</body>
</html>
