<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>åä½œç¼–è¾‘å™¨</title>
    <!-- Quill ç¼–è¾‘å™¨ CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/mobile.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }
        .status-text {
            color: #666;
        }
        .save-indicator {
            font-size: 12px;
            color: #4CAF50;
            margin-left: 10px;
        }
        .editor-container {
            position: relative;
            margin-top: 20px;
        }
        #editor {
            min-height: 400px;
            background-color: white;
        }
        .toolbar {
            border: 1px solid #ccc;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
        }
        .remote-cursor {
            position: absolute;
            width: 2px;
            height: 20px;
            z-index: 10;
            pointer-events: none;
        }
        .cursor-label {
            position: absolute;
            top: -25px;
            left: -2px;
            background: #000;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            white-space: nowrap;
        }
        .draft-restore {
            background-color: #ff9800;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }
        .draft-restore:hover { background-color: #e68900; }
        .mode-btn { background-color: #2196F3; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .mode-btn.active { background-color: #1976D2; }
        .mode-btn + .mode-btn { margin-left: 6px; }
        .collab-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; margin-top: 16px; }
        .panel { background: #fafafa; border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; }
        #comment-list { max-height: 260px; overflow-y: auto; border: 1px solid #ddd; padding: 8px; border-radius: 4px; margin-bottom: 8px; }
        #comment-input { width: 100%; min-height: 80px; padding: 8px; }
        #task-list table { width: 100%; border-collapse: collapse; }
        #task-list th, #task-list td { border: 1px solid #ddd; padding: 6px; text-align: left; }
        #task-form input, #task-form textarea { width: 100%; padding: 6px; margin-bottom: 6px; }
        .online-users { font-size: 12px; color: #555; }
        #markdown-editor { display: none; }
    </style>
</head>
<body class="mobile-container">
    <div class="mobile-nav">
        <h2>å¤šäººå®æ—¶åä½œç¼–è¾‘å™¨</h2>
        <div class="nav-actions">
            <div class="bell" id="mobile-sync-status">ğŸ”„</div>
            <button id="back-to-documents" style="background-color: #2196F3; padding: 8px 12px; border: none; border-radius: 8px; color: white; cursor: pointer;">è¿”å›</button>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <div style="display:flex; flex-wrap: wrap; gap:8px; align-items:center;">
                <button id="rich-text-btn" class="mode-btn active">å¯Œæ–‡æœ¬</button>
                <button id="markdown-btn" class="mode-btn">Markdown</button>
                <button id="share-manage-btn" class="mode-btn" style="background-color: #4CAF50;">å…±äº«ç®¡ç†</button>
            </div>
            <div class="sync-actions">
                <span id="sync-indicator" class="status-text">å‡†å¤‡è¿æ¥...</span>
                <button id="manual-save" class="mode-btn" style="background:#2563eb; color:#fff;">ä¿å­˜/åŒæ­¥</button>
            </div>
        </div>

        <div class="editor-container">
            <div id="rich-editor" style="display: block;">
                <div id="editor"></div>
            </div>
            <div id="markdown-editor" style="display: none;">
                <textarea id="markdown-textarea" style="width: 100%; height: 400px; font-family: monospace; font-size: 16px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; resize: vertical;"></textarea>
            </div>
            <div id="cursor-layer" style="position: relative; height: 0; pointer-events: none;"></div>
        </div>
        <div id="quill-toolbar-wrapper">
        <div id="quill-main-toolbar" class="mobile-toolbar">
            <select class="ql-header">
                <option value="1">H1</option>
                <option value="2">H2</option>
                <option selected></option>
            </select>
            <button class="ql-bold">B</button>
            <button class="ql-italic">I</button>
            <button class="ql-underline">U</button>
            <button class="ql-list" value="ordered">1.</button>
            <button class="ql-list" value="bullet">â€¢</button>
            <button id="more-toggle" aria-label="æ›´å¤šå·¥å…·">Â·Â·Â·</button>
        </div>
        <div id="quill-more-toolbar" class="more-toolbar">
            <select class="ql-font"></select>
            <select class="ql-align"></select>
            <select class="ql-color"></select>
            <select class="ql-background"></select>
            <button class="ql-code-block">ä»£ç </button>
            <button class="ql-clean">æ¸…é™¤</button>
        </div>
        </div>

        <div class="status">
            <div class="status-info">
                <span id="status-text" class="status-text">è¿æ¥ä¸­...</span>
                <span id="save-indicator" class="save-indicator" style="display: none;">å·²è‡ªåŠ¨ä¿å­˜</span>
                <span id="draft-indicator" class="save-indicator" style="display: none; background-color: #ff9800;">å‘ç°æœ¬åœ°è‰ç¨¿</span>
            </div>
            <div class="online-users" id="online-users">åœ¨çº¿ç”¨æˆ·ï¼š-</div>
            <div>
                <button id="restore-draft-btn" class="draft-restore" style="display: none;">æ¢å¤æœ¬åœ°è‰ç¨¿</button>
            </div>
        </div>
        <div class="sync-banner" id="sync-banner" style="display:none;">
            <span id="sync-banner-text">åŒæ­¥ä¸­...</span>
            <span id="sync-banner-extra"></span>
        </div>

        <div class="collab-layout">
            <div class="panel">
                <h3>æ–‡æ¡£ç¼–è¾‘</h3>
                <p id="editing-tip" class="status-text">ç­‰å¾…è¿æ¥...</p>
            </div>
            <div class="panel">
                <h3>è¯„è®ºåŒº</h3>
                <div id="comment-list"></div>
                <textarea id="comment-input" placeholder="è¾“å…¥è¯„è®º..."></textarea>
                <button id="comment-submit">å‘é€</button>
            </div>
        </div>

        <div class="panel" style="margin-top: 16px;">
        <h3>ä»»åŠ¡åˆ—è¡¨</h3>
        <div id="task-list"></div>
        <div id="task-form">
            <input type="text" id="task-title" placeholder="ä»»åŠ¡æ ‡é¢˜">
            <textarea id="task-desc" placeholder="ä»»åŠ¡æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
            <input type="date" id="task-due">
            <button id="task-create">åˆ›å»ºä»»åŠ¡</button>
        </div>
    </div>
</div>

<!-- å…±äº«ç®¡ç†å¼¹çª— -->
<div id="share-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: relative; max-width: 500px; margin: 100px auto; background: white; padding: 20px; border-radius: 8px;">
        <h3>å…±äº«ç®¡ç†</h3>
        <button id="close-share-modal" style="float: right; background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">å…³é—­</button>
        
        <div style="margin-bottom: 15px;">
            <label>æ·»åŠ åä½œè€…ï¼š</label>
            <input type="text" id="collaborator-username" placeholder="è¾“å…¥ç”¨æˆ·å" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <select id="collaborator-role" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="editor">ç¼–è¾‘è€…</option>
                <option value="viewer">æŸ¥çœ‹è€…</option>
            </select>
            <button id="add-collaborator" style="background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">æ·»åŠ </button>
        </div>
        
        <div style="margin-bottom: 15px;">
            <label>æ‰¹é‡æ·»åŠ ï¼š</label>
            <textarea id="batch-collaborators" placeholder="æ¯è¡Œä¸€ä¸ªç”¨æˆ·åå’Œè§’è‰²ï¼Œæ ¼å¼: username1:editor&#10;username2:viewer" style="width: 100%; height: 80px; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            <button id="batch-add-collaborators" style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">æ‰¹é‡æ·»åŠ </button>
        </div>
        
        <div>
            <h4>å½“å‰åä½œè€…ï¼š</h4>
            <div id="collaborators-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;"></div>
        </div>
    </div>
</div>
    </div>

    <!-- Quill ç¼–è¾‘å™¨ JS -->
    <script src="/static/offline_drafts.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        let currentMode = 'rich-text';
        let quillEditor = null;
        let socket = null;
        let isRemoteUpdating = false;
        let onlineUsers = new Set();
        let reconnectAttempts = 0;
        let baseRevisionId = null;
        let lastKnownTitle = '';
        let heartbeatTimer = null;
        let draftSaveTimer = null;

        const params = new URLSearchParams(window.location.search);
        const docId = parseInt(params.get('doc_id') || '1');
        const token = params.get('token') || localStorage.getItem('access_token') || '';
        const username = params.get('username') || '';
        const authHeader = token ? { 'Authorization': `Bearer ${token}` } : {};

        document.getElementById('back-to-documents').addEventListener('click', () => { window.location.href = '/'; });
        document.getElementById('rich-text-btn').addEventListener('click', () => switchToMode('rich-text'));
        document.getElementById('markdown-btn').addEventListener('click', () => switchToMode('markdown'));

        function switchToMode(mode) {
            currentMode = mode;
            document.getElementById('rich-text-btn').classList.toggle('active', mode === 'rich-text');
            document.getElementById('markdown-btn').classList.toggle('active', mode === 'markdown');
            document.getElementById('rich-editor').style.display = mode === 'rich-text' ? 'block' : 'none';
            document.getElementById('markdown-editor').style.display = mode === 'markdown' ? 'block' : 'none';
            if (mode === 'rich-text' && quillEditor) {
                const markdownContent = document.getElementById('markdown-textarea').value;
                quillEditor.root.innerHTML = markdownToHtml(markdownContent);
            } else if (mode === 'markdown') {
                const richContent = quillEditor ? quillEditor.root.innerHTML : '';
                document.getElementById('markdown-textarea').value = htmlToMarkdown(richContent);
            }
        }

        function markdownToHtml(markdown) {
            return markdown
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/^\> (.*$)/gim, '<blockquote>$1</blockquote>')
                .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
                .replace(/\*(.*)\*/gim, '<em>$1</em>')
                .replace(/!\[([^\]]*)\]\(([^)]*)\)/gim, '<img alt="$1" src="$2" />')
                .replace(/\[([^\]]*)\]\(([^)]*)\)/gim, '<a href="$2">$1</a>')
                .replace(/\n$/gim, '<br />')
                .replace(/^\- (.*$)/gim, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
        }

        function htmlToMarkdown(html) {
            return html
                .replace(/<h1>(.*?)<\/h1>/gim, '# $1')
                .replace(/<h2>(.*?)<\/h2>/gim, '## $1')
                .replace(/<h3>(.*?)<\/h3>/gim, '### $1')
                .replace(/<blockquote>(.*?)<\/blockquote>/gim, '> $1')
                .replace(/<strong>(.*?)<\/strong>/gim, '**$1**')
                .replace(/<em>(.*?)<\/em>/gim, '*$1*')
                .replace(/<img[^>]*alt="([^"]*)"[^>]*>/gim, '![$1]($2)')
                .replace(/<a[^>]*href="([^"]*)"[^>]*>(.*?)<\/a>/gim, '[$2]($1)')
                .replace(/<br\s*\/?/gim, '\n')
                .replace(/<ul>(.*?)<\/ul>/gims, '$1')
                .replace(/<li>(.*?)<\/li>/gim, '- $1');
        }

        function getCurrentContent() {
            if (currentMode === 'rich-text' && quillEditor) {
                return quillEditor.root.innerHTML;
            }
            return document.getElementById('markdown-textarea').value;
        }

        function setCurrentContent(content) {
            if (currentMode === 'rich-text' && quillEditor) {
                quillEditor.root.innerHTML = content;
            } else {
                document.getElementById('markdown-textarea').value = content;
            }
        }

        function initQuillEditor() {
            quillEditor = new Quill('#editor', {
                theme: 'snow',
                placeholder: 'å¼€å§‹ç¼–å†™å†…å®¹...',
                modules: {
                    toolbar: {
                        container: '#quill-toolbar-wrapper'
                    }
                }
            });

            quillEditor.on('text-change', function(delta, oldDelta, source) {
                if (source === 'user' && socket && socket.readyState === WebSocket.OPEN && !isRemoteUpdating) {
                    sendContentUpdate(getCurrentContent());
                    if (window.autoSave) window.autoSave();
                }
            });

            quillEditor.on('selection-change', function(range, oldRange, source) {
                if (source === 'user') {
                    sendCursor(range);
                }
            });
        }

        function updateStatus(text) { document.getElementById('status-text').textContent = text; }
        function updateOnlineUsers() { document.getElementById('online-users').textContent = `åœ¨çº¿ç”¨æˆ·ï¼š${Array.from(onlineUsers).join(', ') || '-'}`; }
        function showSaveIndicator() {
            const indicator = document.getElementById('save-indicator');
            indicator.style.display = 'inline';
            setTimeout(() => indicator.style.display = 'none', 2000);
        }

        function updateSyncBanner(text, extra = '', tone = 'info') {
            const banner = document.getElementById('sync-banner');
            const textEl = document.getElementById('sync-banner-text');
            const extraEl = document.getElementById('sync-banner-extra');
            textEl.textContent = text;
            extraEl.textContent = extra;
            banner.style.display = 'flex';
            banner.style.background = tone === 'error' ? '#fee2e2' : tone === 'warn' ? '#fef9c3' : '#e0f2fe';
            banner.style.color = tone === 'error' ? '#991b1b' : tone === 'warn' ? '#92400e' : '#075985';
        }

        function hideSyncBanner() {
            document.getElementById('sync-banner').style.display = 'none';
        }

        function checkLocalDraft(documentId) {
            const draftKey = `offline_draft_${username || 'guest'}_${documentId}`;
            OfflineDrafts.loadDraft(draftKey).then(draft => {
                if (draft && draft.content_delta) {
                    document.getElementById('draft-indicator').style.display = 'inline';
                    document.getElementById('restore-draft-btn').style.display = 'inline-block';
                }
            });
            return false;
        }

        document.getElementById('restore-draft-btn').addEventListener('click', function() {
            const draftKey = `offline_draft_${username || 'guest'}_${docId}`;
            OfflineDrafts.loadDraft(draftKey).then(draft => {
                if (draft) {
                    setCurrentContent(draft.content_delta);
                    baseRevisionId = draft.base_revision_id || baseRevisionId;
                    document.getElementById('draft-indicator').style.display = 'none';
                    document.getElementById('restore-draft-btn').style.display = 'none';
                    OfflineDrafts.deleteDraft(draftKey);
                    alert('æœ¬åœ°è‰ç¨¿å·²æ¢å¤');
                }
            });
        });

        function saveLocalDraft(documentId, content) {
            const draftKey = `offline_draft_${username || 'guest'}_${documentId}`;
            const payload = {
                doc_id: documentId,
                user_id: username || 'guest',
                content_delta: content,
                updated_at_local: Date.now(),
                base_revision_id: baseRevisionId,
                dirty: true,
                title: lastKnownTitle
            };
            OfflineDrafts.saveDraft(draftKey, payload);
        }

        function autoSaveSetup() {
            window.autoSave = function() {
                clearTimeout(draftSaveTimer);
                draftSaveTimer = setTimeout(() => {
                    const currentContent = getCurrentContent();
                    saveLocalDraft(docId, currentContent);
                }, 3000);
            };
        }

        async function fetchLatestDocument(forceRender = false) {
            try {
                const res = await fetch(`/api/v1/documents/${docId}`, { headers: { 'Content-Type': 'application/json', ...authHeader } });
                if (!res.ok) return;
                const data = await res.json();
                lastKnownTitle = data.title;
                baseRevisionId = data.latest_revision_id || baseRevisionId;
                if (forceRender) {
                    isRemoteUpdating = true;
                    setCurrentContent(data.content || '');
                    isRemoteUpdating = false;
                }
                hideSyncBanner();
            } catch (err) {
                console.error('æ‹‰å–æ–‡æ¡£å¤±è´¥', err);
            }
        }

        async function attemptSyncDraft() {
            const draftKey = `offline_draft_${username || 'guest'}_${docId}`;
            const draft = await OfflineDrafts.loadDraft(draftKey);
            if (!draft || !draft.dirty) return;

            try {
                const res = await fetch(`/api/v1/documents/${docId}`, { headers: { 'Content-Type': 'application/json', ...authHeader } });
                if (!res.ok) return;
                const remote = await res.json();
                const serverRev = remote.latest_revision_id;

                if (draft.base_revision_id && serverRev && draft.base_revision_id !== serverRev) {
                    const choice = prompt('æ£€æµ‹åˆ°ç¦»çº¿è‰ç¨¿ä¸æœåŠ¡å™¨ä¸ä¸€è‡´ï¼Œè¾“å…¥ 1 è¦†ç›–æœåŠ¡å™¨ / 2 å¤åˆ¶ä¸ºæ–°æ–‡æ¡£ / 3 æ”¾å¼ƒè‰ç¨¿', '1');
                    if (choice === '1') {
                        await fetch(`/api/v1/documents/${docId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json', ...authHeader },
                            body: JSON.stringify({ content: draft.content_delta })
                        });
                        await OfflineDrafts.deleteDraft(draftKey);
                        await fetchLatestDocument(true);
                    } else if (choice === '2') {
                        await fetch('/api/v1/documents', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', ...authHeader },
                            body: JSON.stringify({ title: `${remote.title || 'ç¦»çº¿è‰ç¨¿'}(offline copy)`, content: draft.content_delta })
                        });
                        await OfflineDrafts.deleteDraft(draftKey);
                    } else {
                        await OfflineDrafts.deleteDraft(draftKey);
                    }
                    return;
                }

                const syncRes = await fetch(`/api/v1/documents/${docId}/sync`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeader },
                    body: JSON.stringify({ content: draft.content_delta, base_revision_id: draft.base_revision_id })
                });
                if (syncRes.status === 409) {
                    updateSyncBanner('åŒæ­¥å†²çª', 'è¯·æ‰‹åŠ¨é€‰æ‹©ç­–ç•¥', 'warn');
                    return;
                }
                if (syncRes.ok) {
                    baseRevisionId = (await syncRes.json()).revision_id || baseRevisionId;
                    await OfflineDrafts.deleteDraft(draftKey);
                    hideSyncBanner();
                }
            } catch (err) {
                console.error('åŒæ­¥ç¦»çº¿è‰ç¨¿å¤±è´¥', err);
            }
        }

        function connectWebSocket() {
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${location.host}/ws/documents/${docId}?token=${encodeURIComponent(token)}&username=${encodeURIComponent(username || 'åŒ¿åç”¨æˆ·')}`;
            socket = new WebSocket(wsUrl);

            socket.onopen = () => {
                reconnectAttempts = 0;
                updateStatus('å·²è¿æ¥');
                document.getElementById('editing-tip').textContent = 'ä½ æ­£åœ¨ç¼–è¾‘æ–‡æ¡£';
                updateSyncBanner('åœ¨çº¿', 'å®æ—¶åŒæ­¥å¯ç”¨');
                fetchLatestDocument(true);
                if (heartbeatTimer) clearInterval(heartbeatTimer);
                heartbeatTimer = setInterval(() => {
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({ type: 'pong', payload: { ts: Date.now() } }));
                    }
                }, 25000);
            };

            socket.onerror = (e) => {
                console.error('WebSocketé”™è¯¯:', e);
                updateStatus('è¿æ¥å‡ºé”™');
                updateSyncBanner('è¿æ¥å¼‚å¸¸', 'ç¨åé‡è¯•', 'warn');
            };

            socket.onclose = (e) => {
                console.log('WebSocketå…³é—­:', e.code, e.reason);
                updateStatus('è¿æ¥å·²å…³é—­');
                socket = null;
                const delay = Math.min(20000, 1000 * Math.pow(2, reconnectAttempts));
                reconnectAttempts += 1;
                updateSyncBanner('æ­£åœ¨é‡è¿', `å°†åœ¨ ${Math.round(delay / 1000)}s åé‡è¯•`, 'warn');
                setTimeout(connectWebSocket, delay);
            };

            socket.onmessage = (event) => {
                const msg = JSON.parse(event.data || '{}');
                if (msg.type === 'ping') {
                    if (socket && socket.readyState === WebSocket.OPEN) socket.send(JSON.stringify({ type: 'pong' }));
                    return;
                }
                if (msg.type === 'sync_ack' && msg.payload?.revision_id) {
                    baseRevisionId = msg.payload.revision_id;
                    hideSyncBanner();
                }
                if (msg.type === 'presence') {
                    if (msg.action === 'init' && Array.isArray(msg.online_users)) {
                        onlineUsers = new Set(msg.online_users);
                        if (msg.online_users_info && Array.isArray(msg.online_users_info)) {
                            console.log('åœ¨çº¿ç”¨æˆ·è¯¦æƒ…:', msg.online_users_info);
                        }
                    }
                    if (msg.action === 'join') onlineUsers.add(msg.user);
                    if (msg.action === 'leave') onlineUsers.delete(msg.user);
                    updateOnlineUsers();
                    return;
                }

                if (msg.type === 'init' && msg.payload?.html !== undefined) {
                    isRemoteUpdating = true;
                    setCurrentContent(msg.payload.html);
                    saveLocalDraft(docId, msg.payload.html);
                    baseRevisionId = msg.payload.revision_id || baseRevisionId;

                    if (msg.permissions) {
                        const permissions = msg.permissions;
                        const canEdit = permissions.can_edit;
                        const isOwner = permissions.is_owner;

                        if (quillEditor) {
                            quillEditor.enable(canEdit);
                        }
                        document.getElementById('markdown-textarea').disabled = !canEdit;

                        if (isOwner) {
                            document.getElementById('editing-tip').textContent = 'ä½ æ˜¯æ–‡æ¡£æ‰€æœ‰è€…ï¼Œå¯ä»¥ç¼–è¾‘å’Œç®¡ç†åä½œè€…';
                        } else if (canEdit) {
                            document.getElementById('editing-tip').textContent = 'ä½ æ˜¯ç¼–è¾‘è€…ï¼Œå¯ä»¥ç¼–è¾‘æ–‡æ¡£å†…å®¹';
                        } else {
                            document.getElementById('editing-tip').textContent = 'ä½ æ˜¯æŸ¥çœ‹è€…ï¼Œåªèƒ½æŸ¥çœ‹æ–‡æ¡£å†…å®¹';
                        }

                        const shareBtn = document.getElementById('share-manage-btn');
                        if (shareBtn) {
                            shareBtn.style.display = isOwner ? 'inline-block' : 'none';
                        }
                    }

                    isRemoteUpdating = false;
                    return;
                }

                if (msg.type === 'content_update' && msg.payload?.html) {
                    if (msg.user === username) return;
                    isRemoteUpdating = true;
                    setCurrentContent(msg.payload.html);
                    baseRevisionId = msg.payload.revision_id || baseRevisionId;
                    saveLocalDraft(docId, msg.payload.html);
                    isRemoteUpdating = false;
                    return;
                }

                if (msg.type === 'cursor' && msg.user) {
                    document.getElementById('editing-tip').textContent = `${msg.user} æ­£åœ¨ç¼–è¾‘æ–‡æ¡£...`;
                    return;
                }

                if (msg.type === 'error' && msg.payload?.message) {
                    alert(msg.payload.message);
                    return;
                }
            };
        }

        function sendContentUpdate(html) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                updateSyncBanner('åŒæ­¥ä¸­', 'å®æ—¶ä¿å­˜...');
                socket.send(JSON.stringify({ type: 'content_update', payload: { html } }));
            } else {
                updateSyncBanner('ç¦»çº¿ç¼–è¾‘', 'å†…å®¹å·²ä¿å­˜åˆ°æœ¬åœ°', 'warn');
                saveLocalDraft(docId, html);
            }
        }

        function sendCursor(range) {
            if (!socket || socket.readyState !== WebSocket.OPEN) return;
            const index = range?.index || 0;
            const length = range?.length || 0;
            socket.send(JSON.stringify({ type: 'cursor', payload: { index, length } }));
        }

        async function manualSync() {
            const content = getCurrentContent();
            updateSyncBanner('æ‰‹åŠ¨åŒæ­¥ä¸­', 'æ­£åœ¨ä¿å­˜...');
            try {
                const res = await fetch(`/api/v1/documents/${docId}/sync`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeader },
                    body: JSON.stringify({ content, base_revision_id: baseRevisionId })
                });
                if (res.status === 409) {
                    updateSyncBanner('åŒæ­¥å†²çª', 'è¯·åˆ·æ–°åé€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬', 'warn');
                    return;
                }
                if (res.ok) {
                    const data = await res.json();
                    baseRevisionId = data.revision_id || baseRevisionId;
                    hideSyncBanner();
                    showSaveIndicator();
                    await OfflineDrafts.deleteDraft(`offline_draft_${username || 'guest'}_${docId}`);
                }
            } catch (err) {
                console.error('æ‰‹åŠ¨åŒæ­¥å¤±è´¥', err);
                updateSyncBanner('åŒæ­¥å¤±è´¥', 'è¯·ç¨åé‡è¯•', 'error');
            }
        }

        async function fetchComments() {
            const res = await fetch(`/api/v1/documents/${docId}/comments`, { headers: { 'Content-Type': 'application/json', ...authHeader } });
            if (!res.ok) return;
            const data = await res.json();
            const list = document.getElementById('comment-list');
            list.innerHTML = '';
            data.forEach(c => {
                const div = document.createElement('div');
                div.style.borderBottom = '1px solid #eee';
                div.style.padding = '6px 0';
                div.innerHTML = `<strong>#${c.user_id}</strong>ï¼š${c.content}<div style="font-size:12px;color:#888;">${c.created_at}</div>`;
                list.appendChild(div);
            });
        }

        async function submitComment() {
            const content = document.getElementById('comment-input').value.trim();
            if (!content) return;
            const res = await fetch(`/api/v1/documents/${docId}/comments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', ...authHeader },
                body: JSON.stringify({ content })
            });
            if (res.ok) {
                document.getElementById('comment-input').value = '';
                fetchComments();
            }
        }

        async function fetchTasks() {
            const res = await fetch(`/api/v1/documents/${docId}/tasks`, { headers: { 'Content-Type': 'application/json', ...authHeader } });
            if (!res.ok) return;
            const data = await res.json();
            const container = document.getElementById('task-list');
            const rows = data.map(t => `<tr><td>${t.title}</td><td>${t.status}</td><td>${t.due_at || ''}</td><td><button data-id="${t.id}" class="task-done">å®Œæˆ</button></td></tr>`).join('');
            container.innerHTML = `<table><tr><th>æ ‡é¢˜</th><th>çŠ¶æ€</th><th>æˆªæ­¢</th><th>æ“ä½œ</th></tr>${rows}</table>`;
            document.querySelectorAll('.task-done').forEach(btn => btn.addEventListener('click', () => updateTaskStatus(btn.dataset.id)));
        }

        async function createTask() {
            const title = document.getElementById('task-title').value.trim();
            if (!title) return;
            const description = document.getElementById('task-desc').value.trim();
            const due_at = document.getElementById('task-due').value || null;
            const res = await fetch(`/api/v1/documents/${docId}/tasks`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', ...authHeader },
                body: JSON.stringify({ title, description, due_at })
            });
            if (res.ok) {
                document.getElementById('task-title').value = '';
                document.getElementById('task-desc').value = '';
                document.getElementById('task-due').value = '';
                fetchTasks();
                alert('ä»»åŠ¡åˆ›å»ºæˆåŠŸ');
            }
        }

        async function updateTaskStatus(taskId) {
            const res = await fetch(`/api/v1/tasks/${taskId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', ...authHeader },
                body: JSON.stringify({ status: 'DONE' })
            });
            if (res.ok) {
                fetchTasks();
                const tip = document.createElement('div');
                tip.style.background = '#d4edda';
                tip.style.color = '#155724';
                tip.style.padding = '6px';
                tip.style.marginTop = '8px';
                tip.textContent = 'ä»»åŠ¡å·²å®Œæˆï¼';
                document.getElementById('task-form').appendChild(tip);
                setTimeout(() => tip.remove(), 2000);
            }
        }

        document.getElementById('comment-submit').addEventListener('click', submitComment);
        document.getElementById('task-create').addEventListener('click', createTask);
        document.getElementById('share-manage-btn').addEventListener('click', showShareModal);
        document.getElementById('close-share-modal').addEventListener('click', hideShareModal);
        document.getElementById('add-collaborator').addEventListener('click', addCollaborator);
        document.getElementById('batch-add-collaborators').addEventListener('click', batchAddCollaborators);
        document.getElementById('manual-save').addEventListener('click', manualSync);
        document.getElementById('more-toggle').addEventListener('click', () => {
            document.getElementById('quill-more-toolbar').classList.toggle('active');
        });

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && (!socket || socket.readyState !== WebSocket.OPEN)) {
                connectWebSocket();
                fetchLatestDocument(true);
            }
        });

        window.addEventListener('online', () => {
            updateSyncBanner('å›åˆ°åœ¨çº¿', 'å‡†å¤‡åŒæ­¥');
            connectWebSocket();
            attemptSyncDraft();
        });
        window.addEventListener('offline', () => {
            updateSyncBanner('ç¦»çº¿æ¨¡å¼', 'ç¼–è¾‘å†…å®¹å°†æš‚å­˜', 'warn');
        });

        // å…±äº«ç®¡ç†å‡½æ•°
        function showShareModal() {
            document.getElementById('share-modal').style.display = 'block';
            loadCollaborators();
        }

        function hideShareModal() {
            document.getElementById('share-modal').style.display = 'none';
        }

        async function addCollaborator() {
            const username = document.getElementById('collaborator-username').value.trim();
            const role = document.getElementById('collaborator-role').value;
            
            if (!username) {
                alert('è¯·è¾“å…¥ç”¨æˆ·å');
                return;
            }

            try {
                const response = await fetch(`/api/v1/documents/${docId}/collaborators`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeader },
                    body: JSON.stringify({ username, role })
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    document.getElementById('collaborator-username').value = '';
                    loadCollaborators();
                } else {
                    const error = await response.json();
                    alert(`æ·»åŠ å¤±è´¥: ${error.detail}`);
                }
            } catch (error) {
                console.error('æ·»åŠ åä½œè€…å¤±è´¥:', error);
                alert('æ·»åŠ åä½œè€…å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        async function batchAddCollaborators() {
            const batchText = document.getElementById('batch-collaborators').value.trim();
            if (!batchText) {
                alert('è¯·è¾“å…¥è¦æ‰¹é‡æ·»åŠ çš„ç”¨æˆ·');
                return;
            }

            // è§£ææ‰¹é‡è¾“å…¥
            const lines = batchText.split('\n').filter(line => line.trim());
            const users = [];
            
            for (const line of lines) {
                const parts = line.split(':');
                if (parts.length === 2) {
                    users.push({
                        username: parts[0].trim(),
                        role: parts[1].trim()
                    });
                }
            }

            if (users.length === 0) {
                alert('è¯·æŒ‰æ­£ç¡®æ ¼å¼è¾“å…¥ï¼šæ¯è¡Œä¸€ä¸ªç”¨æˆ·åå’Œè§’è‰²ï¼Œç”¨å†’å·åˆ†éš”');
                return;
            }

            try {
                const response = await fetch(`/api/v1/documents/${docId}/collaborators/batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeader },
                    body: JSON.stringify({ users })
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`æ‰¹é‡æ·»åŠ å®Œæˆï¼šæˆåŠŸ ${result.success} ä¸ªï¼Œå¤±è´¥ ${result.failed} ä¸ª`);
                    document.getElementById('batch-collaborators').value = '';
                    loadCollaborators();
                } else {
                    const error = await response.json();
                    alert(`æ‰¹é‡æ·»åŠ å¤±è´¥: ${error.detail}`);
                }
            } catch (error) {
                console.error('æ‰¹é‡æ·»åŠ åä½œè€…å¤±è´¥:', error);
                alert('æ‰¹é‡æ·»åŠ åä½œè€…å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        async function loadCollaborators() {
            try {
                const response = await fetch(`/api/v1/documents/${docId}/collaborators`, {
                    headers: { 'Content-Type': 'application/json', ...authHeader }
                });

                if (response.ok) {
                    const result = await response.json();
                    const list = document.getElementById('collaborators-list');
                    list.innerHTML = '';
                    
                    if (result.collaborators && result.collaborators.length > 0) {
                        result.collaborators.forEach(collab => {
                            const div = document.createElement('div');
                            div.style.borderBottom = '1px solid #eee';
                            div.style.padding = '8px 0';
                            div.innerHTML = `
                                <strong>${collab.username}</strong> 
                                <span style="margin-left: 10px; color: #666;">(${collab.role})</span>
                                <span style="margin-left: 10px; font-size: 12px; color: #999;">${collab.created_at}</span>
                                <button onclick="removeCollaborator(${collab.user_id})" style="margin-left: 10px; background: #f44336; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer;">ç§»é™¤</button>
                            `;
                            list.appendChild(div);
                        });
                    } else {
                        list.innerHTML = '<span style="color: #999;">æš‚æ— åä½œè€…</span>';
                    }
                }
            } catch (error) {
                console.error('åŠ è½½åä½œè€…åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        async function removeCollaborator(userId) {
            if (!confirm('ç¡®å®šè¦ç§»é™¤è¯¥åä½œè€…å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`/api/v1/documents/${docId}/collaborators/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json', ...authHeader }
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    loadCollaborators();
                } else {
                    const error = await response.json();
                    alert(`ç§»é™¤å¤±è´¥: ${error.detail}`);
                }
            } catch (error) {
                console.error('ç§»é™¤åä½œè€…å¤±è´¥:', error);
                alert('ç§»é™¤åä½œè€…å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // é¡µé¢å…³é—­æ—¶æ¸…ç†WebSocketè¿æ¥
        window.addEventListener('beforeunload', function() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                // å‘é€å…³é—­æ¶ˆæ¯ï¼ˆå¯é€‰ï¼‰
                try {
                    socket.close(1000, 'Page closing');
                } catch (e) {
                    console.error('å…³é—­WebSocketæ—¶å‡ºé”™:', e);
                }
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            initQuillEditor();
            autoSaveSetup();
            checkLocalDraft(docId);
            connectWebSocket();
            fetchLatestDocument(true);
            attemptSyncDraft();
            fetchComments();
            fetchTasks();
        });
    </script>
</body>
</html>
