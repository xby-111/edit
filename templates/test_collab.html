<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>协作编辑器测试</title>
    <style>
        #container {
            position: relative;
            width: 90%;
            margin: 0 auto;
        }

        #editor {
            width: 100%;
            height: 400px;
            font-size: 16px;
            position: relative;
            z-index: 1;
            padding: 10px;
            border: 1px solid #ccc;
        }

        .cursor {
            position: absolute;
            width: 2px;
            height: 20px;
            background-color: red;
            z-index: 2;
        }
        
        .remote-cursor {
            position: absolute;
            width: 2px;
            height: 20px;
            z-index: 10;
        }
        
        .status {
            margin-top: 10px;
            padding: 5px;
            background-color: #f0f0f0;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h2>多人实时协作编辑器测试</h2>

    <div id="container">
        <textarea id="editor" style="width: 100%; height: 70vh; font-family: monospace; font-size: 16px;"></textarea>
        <div id="cursor-layer" style="position: relative; height: 0; pointer-events: none;"></div>
    </div>
    
    <div class="status">
        状态: <span id="status-text">连接中...</span>
        <br>
        文档ID: <input type="number" id="docId" value="1" min="1">
        <button onclick="connectToDoc()">连接到文档</button>
    </div>

    <script>
        let ws;
        let client_id = Math.random().toString(36).substring(2);
        let documentId;

        function connectToDoc() {
            documentId = document.getElementById("docId").value;
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            }
            
            // 连接到WebSocket
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/api/v1/ws/documents/${documentId}`;
            
            try {
                ws = new WebSocket(wsUrl);
                
                ws.onmessage = (event) => {
                    const msg = JSON.parse(event.data);
                    const editor = document.getElementById("editor");

                    if (msg.type === "init") {
                        // 初始化内容（从后端获取的当前文档内容）
                        editor.value = msg.content;
                        updateStatus("已连接并初始化");
                    }

                    if (msg.type === "content") {
                        // 更新内容
                        if (msg.user_id !== getCurrentUserId()) {
                            editor.value = msg.content;
                            updateStatus(`用户 ${msg.user_id} 更新了内容`);
                        }
                    }

                    if (msg.type === "cursor") {
                        // 显示其他用户的光标位置
                        if (msg.user_id !== getCurrentUserId()) {
                            drawCursor(msg.user_id, msg.cursor);
                            updateStatus(`用户 ${msg.user_id} 移动了光标`);
                        }
                    }
                };

                ws.onopen = () => {
                    updateStatus("WebSocket连接已建立");
                };

                ws.onerror = (error) => {
                    console.error("WebSocket错误:", error);
                    updateStatus("WebSocket连接错误: " + error);
                };

                ws.onclose = () => {
                    updateStatus("WebSocket连接已关闭");
                };
            } catch (e) {
                console.error("连接错误:", e);
                updateStatus("连接错误: " + e);
            }
        }

        function setupEditor() {
            const editor = document.getElementById("editor");

            editor.addEventListener("input", (e) => {
                // 发送内容更新到服务器
                const content = editor.value;
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: "content",
                        content: content
                    }));
                }
            });

            // 发送光标位置
            editor.addEventListener("keyup", sendCursor);
            editor.addEventListener("mouseup", sendCursor);
            editor.addEventListener("click", sendCursor);
        }

        // 发送光标位置
        function sendCursor() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            
            const editor = document.getElementById("editor");
            const selectionStart = editor.selectionStart;

            // 计算光标位置（简化版，实际可能需要更复杂的计算）
            const text = editor.value;
            const textBeforeCursor = text.substring(0, selectionStart);
            const lines = textBeforeCursor.split('\n');
            const currentLine = lines.length - 1;
            const currentColumn = lines[lines.length - 1].length;

            const cursorInfo = {
                position: selectionStart,
                line: currentLine,
                column: currentColumn
            };

            ws.send(JSON.stringify({
                type: "cursor",
                cursor: cursorInfo
            }));
        }

        // 绘制其他用户的光标
        function drawCursor(user_id, cursor) {
            const editor = document.getElementById("editor");
            const cursorLayer = document.getElementById("cursor-layer");
            
            // 为每个用户创建或更新光标元素
            let userCursor = document.getElementById(`cursor-${user_id}`);
            if (!userCursor) {
                userCursor = document.createElement("div");
                userCursor.id = `cursor-${user_id}`;
                userCursor.className = "remote-cursor";
                userCursor.style.position = "absolute";
                userCursor.style.width = "2px";
                userCursor.style.backgroundColor = getRandomColor();
                userCursor.style.zIndex = "10";
                userCursor.innerHTML = `<div style="position: absolute; top: -18px; left: -10px; background: #000; color: white; padding: 2px 5px; border-radius: 3px; font-size: 12px; white-space: nowrap;">User ${user_id}</div>`;
                cursorLayer.appendChild(userCursor);
            }

            // 这里需要根据行和列信息计算像素位置
            // 简化实现，直接使用position信息
            if (cursor && cursor.position !== undefined) {
                // 获取编辑器的位置信息
                const editorRect = editor.getBoundingClientRect();
                const textBeforeCursor = editor.value.substring(0, cursor.position);
                const lines = textBeforeCursor.split('\n');
                const currentLine = lines.length - 1;
                const currentColumn = lines[lines.length - 1].length;

                // 计算光标的大致像素位置（这是一个简化实现，实际可能需要更精确的计算）
                const lineHeight = 20; // 假设行高为20px
                const charWidth = 8;   // 假设字符宽度为8px
                const top = currentLine * lineHeight;
                const left = currentColumn * charWidth;

                userCursor.style.top = `${top}px`;
                userCursor.style.left = `${left}px`;
                userCursor.style.height = `${lineHeight}px`;
            }
        }

        // 生成随机颜色
        function getRandomColor() {
            const colors = ['#FF5733', '#33FF57', '#3357FF', '#F333FF', '#FF33A1', '#33FFF0'];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        function getCurrentUserId() {
            // 简化实现，实际应该从认证信息中获取
            return "current_user"; // 这里应该获取当前用户的ID
        }
        
        function updateStatus(text) {
            document.getElementById("status-text").textContent = text;
        }

        // 初始化
        setupEditor();
        
        // 页面加载完成后自动连接到默认文档
        window.onload = function() {
            connectToDoc();
        };
    </script>
</body>
</html>